#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Validates AI SDLC Governance Compliance

.DESCRIPTION
    Checks all artifacts for governance metadata, validates exception log format,
    and verifies metrics calculations.

.PARAMETER ProjectPath
    Path to the project root directory

.PARAMETER Fix
    Automatically fix issues where possible

.EXAMPLE
    .\validate-governance.ps1 -ProjectPath "."
    .\validate-governance.ps1 -ProjectPath "." -Fix

.NOTES
    Generated by: claude-3.5-sonnet
    Timestamp: 2025-12-03T00:00:00Z
    Version: 1.0.0
    Policy Version: v1.0.0
    Traceability: REQ-3.4 → DESIGN-3.4 → TASK-3.5
    Review Status: Pending
    Risk Level: Level 2
#>

param(
    [Parameter(Mandatory=$false)]
    [string]$ProjectPath = "..",
    
    [Parameter(Mandatory=$false)]
    [switch]$Fix
)

# Set error action preference
$ErrorActionPreference = "Stop"

Write-Host "=== AI SDLC Governance Compliance Validation ===" -ForegroundColor Cyan
Write-Host ""

$issues = @()
$warnings = @()
$passed = 0
$failed = 0

# Helper function to add issue
function Add-Issue {
    param([string]$Message, [string]$Severity = "ERROR")
    
    if ($Severity -eq "ERROR") {
        $script:issues += $Message
        $script:failed++
        Write-Host "[FAIL] $Message" -ForegroundColor Red
    } else {
        $script:warnings += $Message
        Write-Host "[WARN] $Message" -ForegroundColor Yellow
    }
}

# Helper function to add pass
function Add-Pass {
    param([string]$Message)
    $script:passed++
    Write-Host "[PASS] $Message" -ForegroundColor Green
}

# Check 1: Validate governance directory structure
Write-Host "`n[CHECK 1] Governance Directory Structure" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$governanceDir = Join-Path $ProjectPath ".kiro/governance"
if (Test-Path $governanceDir) {
    Add-Pass "Governance directory exists"
} else {
    Add-Issue "Governance directory missing: $governanceDir"
}

$exceptionsFile = Join-Path $governanceDir "exceptions.md"
if (Test-Path $exceptionsFile) {
    Add-Pass "Exceptions file exists"
} else {
    Add-Issue "Exceptions file missing: $exceptionsFile"
}

$metricsFile = Join-Path $governanceDir "metrics.md"
if (Test-Path $metricsFile) {
    Add-Pass "Metrics file exists"
} else {
    Add-Issue "Metrics file missing: $metricsFile"
}

# Check 2: Validate Python Lambda metadata
Write-Host "`n[CHECK 2] Python Lambda Metadata" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$lambdaDir = Join-Path $ProjectPath "rds-operations-dashboard/lambda"
if (Test-Path $lambdaDir) {
    $pythonHandlers = Get-ChildItem -Path $lambdaDir -Recurse -Filter "handler.py" -ErrorAction SilentlyContinue
    
    $totalHandlers = $pythonHandlers.Count
    $handlersWithMetadata = 0
    
    foreach ($handler in $pythonHandlers) {
        $content = Get-Content $handler.FullName -Raw -ErrorAction SilentlyContinue
        
        if ($content -match '"""[\s\S]*?generated_by[\s\S]*?"""' -or 
            $content -match "'''[\s\S]*?generated_by[\s\S]*?'''") {
            $handlersWithMetadata++
        } else {
            Add-Issue "Missing metadata in: $($handler.FullName)" "WARNING"
        }
    }
    
    if ($handlersWithMetadata -eq $totalHandlers) {
        Add-Pass "All $totalHandlers Lambda handlers have metadata"
    } else {
        Add-Issue "$handlersWithMetadata/$totalHandlers Lambda handlers have metadata"
    }
} else {
    Add-Issue "Lambda directory not found: $lambdaDir" "WARNING"
}

# Check 3: Validate TypeScript/CDK metadata
Write-Host "`n[CHECK 3] TypeScript/CDK Metadata" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$infraDir = Join-Path $ProjectPath "rds-operations-dashboard/infrastructure/lib"
if (Test-Path $infraDir) {
    $tsStacks = Get-ChildItem -Path $infraDir -Filter "*-stack.ts" -ErrorAction SilentlyContinue
    
    $totalStacks = $tsStacks.Count
    $stacksWithMetadata = 0
    
    foreach ($stack in $tsStacks) {
        $content = Get-Content $stack.FullName -Raw -ErrorAction SilentlyContinue
        
        if ($content -match '/\*[\s\S]*?generated_by[\s\S]*?\*/') {
            $stacksWithMetadata++
        } else {
            Add-Issue "Missing metadata in: $($stack.FullName)" "WARNING"
        }
    }
    
    if ($stacksWithMetadata -eq $totalStacks) {
        Add-Pass "All $totalStacks CDK stacks have metadata"
    } elseif ($stacksWithMetadata -gt 0) {
        Add-Issue "$stacksWithMetadata/$totalStacks CDK stacks have metadata" "WARNING"
    } else {
        Add-Issue "No CDK stacks have metadata" "WARNING"
    }
} else {
    Add-Issue "Infrastructure directory not found: $infraDir" "WARNING"
}

# Check 4: Validate exception log format
Write-Host "`n[CHECK 4] Exception Log Format" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

if (Test-Path $exceptionsFile) {
    $exceptionsContent = Get-Content $exceptionsFile -Raw
    
    # Check for required sections
    if ($exceptionsContent -match "## Exception Log Location") {
        Add-Pass "Exception log has location section"
    } else {
        Add-Issue "Exception log missing location section"
    }
    
    if ($exceptionsContent -match "## Exception Log Format") {
        Add-Pass "Exception log has format section"
    } else {
        Add-Issue "Exception log missing format section"
    }
    
    # Check for exception entries
    $exceptionCount = ([regex]::Matches($exceptionsContent, '## Exception EXC-')).Count
    if ($exceptionCount -gt 0) {
        Add-Pass "Found $exceptionCount exception entries"
        
        # Validate each exception has required fields
        $exceptions = [regex]::Matches($exceptionsContent, '## Exception (EXC-\d{4}-\d{3})')
        foreach ($match in $exceptions) {
            $exceptionId = $match.Groups[1].Value
            $exceptionBlock = $exceptionsContent.Substring($match.Index, 
                [Math]::Min(1000, $exceptionsContent.Length - $match.Index))
            
            $requiredFields = @("Date:", "Gate Bypassed:", "Risk Level:", "Reason:", "Approval Chain:", "Status:")
            $missingFields = @()
            
            foreach ($field in $requiredFields) {
                if ($exceptionBlock -notmatch [regex]::Escape($field)) {
                    $missingFields += $field
                }
            }
            
            if ($missingFields.Count -eq 0) {
                Add-Pass "Exception $exceptionId has all required fields"
            } else {
                Add-Issue "Exception $exceptionId missing fields: $($missingFields -join ', ')"
            }
        }
    } else {
        Add-Pass "No exceptions logged (clean record)"
    }
}

# Check 5: Validate metrics calculations
Write-Host "`n[CHECK 5] Metrics Calculations" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

if (Test-Path $metricsFile) {
    $metricsContent = Get-Content $metricsFile -Raw
    
    # Check for required metrics
    $requiredMetrics = @(
        "AI Velocity Index \(AVI\)",
        "Human Validation Density \(HVD\)",
        "AI Code Acceptance Rate \(ACAR\)",
        "Trust Confidence Index \(TCI\)",
        "Security Gate Pass Rate \(SGPR\)",
        "Governance Compliance Index \(GCI\)"
    )
    
    foreach ($metric in $requiredMetrics) {
        if ($metricsContent -match $metric) {
            Add-Pass "Metric present: $($metric -replace '\\', '')"
        } else {
            Add-Issue "Metric missing: $($metric -replace '\\', '')"
        }
    }
    
    # Check for metadata block
    if ($metricsContent -match '\*\*Metadata:\*\*') {
        Add-Pass "Metrics file has metadata block"
    } else {
        Add-Issue "Metrics file missing metadata block" "WARNING"
    }
    
    # Check last updated date
    if ($metricsContent -match '\*\*Last Updated:\*\* (\d{4}-\d{2}-\d{2})') {
        $lastUpdated = [DateTime]::Parse($matches[1])
        $daysSinceUpdate = ((Get-Date) - $lastUpdated).Days
        
        if ($daysSinceUpdate -le 30) {
            Add-Pass "Metrics updated recently ($daysSinceUpdate days ago)"
        } else {
            Add-Issue "Metrics outdated ($daysSinceUpdate days old)" "WARNING"
        }
    } else {
        Add-Issue "Cannot determine metrics last updated date" "WARNING"
    }
}

# Check 6: Validate spec documents
Write-Host "`n[CHECK 6] Spec Documents" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$specsDir = Join-Path $ProjectPath ".kiro/specs"
if (Test-Path $specsDir) {
    $specDirs = Get-ChildItem -Path $specsDir -Directory -ErrorAction SilentlyContinue
    
    foreach ($specDir in $specDirs) {
        $specName = $specDir.Name
        $requirementsFile = Join-Path $specDir.FullName "requirements.md"
        $designFile = Join-Path $specDir.FullName "design.md"
        $tasksFile = Join-Path $specDir.FullName "tasks.md"
        
        $hasRequirements = Test-Path $requirementsFile
        $hasDesign = Test-Path $designFile
        $hasTasks = Test-Path $tasksFile
        
        if ($hasRequirements -and $hasDesign -and $hasTasks) {
            Add-Pass "Spec '$specName' has all required documents"
        } else {
            $missing = @()
            if (-not $hasRequirements) { $missing += "requirements.md" }
            if (-not $hasDesign) { $missing += "design.md" }
            if (-not $hasTasks) { $missing += "tasks.md" }
            Add-Issue "Spec '$specName' missing: $($missing -join ', ')" "WARNING"
        }
    }
} else {
    Add-Issue "Specs directory not found: $specsDir" "WARNING"
}

# Check 7: Validate governance policy
Write-Host "`n[CHECK 7] Governance Policy" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$policyFile = Join-Path $ProjectPath ".kiro/steering/ai-sdlc-governance.md"
if (Test-Path $policyFile) {
    Add-Pass "Governance policy file exists"
    
    $policyContent = Get-Content $policyFile -Raw
    
    # Check for required sections
    $requiredSections = @(
        "## Core Principles",
        "## Model Risk Classification",
        "## Governance Roles Matrix",
        "## Artifact Metadata Requirements",
        "## Development Workflow Gates",
        "## Audit Trail Requirements"
    )
    
    foreach ($section in $requiredSections) {
        if ($policyContent -match [regex]::Escape($section)) {
            Add-Pass "Policy has section: $section"
        } else {
            Add-Issue "Policy missing section: $section"
        }
    }
    
    # Check policy version
    if ($policyContent -match '\*\*Policy Version:\*\* (v\d+\.\d+\.\d+)') {
        Add-Pass "Policy version: $($matches[1])"
    } else {
        Add-Issue "Policy version not found" "WARNING"
    }
} else {
    Add-Issue "Governance policy file missing: $policyFile"
}

# Check 8: Validate test coverage
Write-Host "`n[CHECK 8] Test Coverage" -ForegroundColor Cyan
Write-Host "----------------------------------------" -ForegroundColor Cyan

$testsDir = Join-Path $ProjectPath "rds-operations-dashboard/lambda/tests"
if (Test-Path $testsDir) {
    $testFiles = Get-ChildItem -Path $testsDir -Filter "test_*.py" -ErrorAction SilentlyContinue
    $testCount = $testFiles.Count
    
    if ($testCount -gt 0) {
        Add-Pass "Found $testCount test files"
    } else {
        Add-Issue "No test files found" "WARNING"
    }
    
    # Check for property-based tests
    $pbtTests = 0
    foreach ($testFile in $testFiles) {
        $content = Get-Content $testFile.FullName -Raw -ErrorAction SilentlyContinue
        if ($content -match "hypothesis|property|@given") {
            $pbtTests++
        }
    }
    
    if ($pbtTests -gt 0) {
        Add-Pass "Found $pbtTests property-based test files"
    } else {
        Add-Issue "No property-based tests found" "WARNING"
    }
} else {
    Add-Issue "Tests directory not found: $testsDir" "WARNING"
}

# Summary
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "VALIDATION SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Passed:   $passed" -ForegroundColor Green
Write-Host "Failed:   $failed" -ForegroundColor $(if ($failed -gt 0) { "Red" } else { "Green" })
Write-Host "Warnings: $($warnings.Count)" -ForegroundColor Yellow
Write-Host ""

if ($issues.Count -gt 0) {
    Write-Host "CRITICAL ISSUES:" -ForegroundColor Red
    foreach ($issue in $issues) {
        Write-Host "  - $issue" -ForegroundColor Red
    }
    Write-Host ""
}

if ($warnings.Count -gt 0) {
    Write-Host "WARNINGS:" -ForegroundColor Yellow
    foreach ($warning in $warnings) {
        Write-Host "  - $warning" -ForegroundColor Yellow
    }
    Write-Host ""
}

# Recommendations
if ($issues.Count -gt 0 -or $warnings.Count -gt 0) {
    Write-Host "RECOMMENDATIONS:" -ForegroundColor Cyan
    
    if ($issues.Count -gt 0) {
        Write-Host "  1. Address critical issues before proceeding to production" -ForegroundColor White
        Write-Host "  2. Run: .\scripts\add-governance-metadata.py to add missing metadata" -ForegroundColor White
    }
    
    if ($warnings.Count -gt 0) {
        Write-Host "  3. Review warnings and update artifacts as needed" -ForegroundColor White
        Write-Host "  4. Run: .\scripts\update-governance-metrics.ps1 to refresh metrics" -ForegroundColor White
    }
    
    Write-Host ""
}

# Exit code
if ($issues.Count -gt 0) {
    Write-Host "[FAILED] Governance validation failed with $($issues.Count) critical issues" -ForegroundColor Red
    exit 1
} else {
    Write-Host "[SUCCESS] Governance validation passed!" -ForegroundColor Green
    exit 0
}
