 Great! Let's Deploy from Your Local Machine
✅ Step 1: Verify Prerequisites
# Check AWS CLI
aws --version

# Check Node.js
node --version

# Check Python
python --version

# Check CDK
cdk --version
# If not installed: npm install -g aws-cdk
✅ Step 2: Configure AWS CLI
# Configure with your IAM user credentials (NOT root!)
aws configure

# Enter when prompted:
# AWS Access Key ID: [Your IAM user access key]
# AWS Secret Access Key: [Your IAM user secret key]
# Default region: ap-southeast-1
# Default output format: json

# Verify it works
aws sts get-caller-identity
✅ Step 3: Navigate to Project
# Go to your project directory
cd rds-operations-dashboard
✅ Step 4: Install Dependencies
# Install infrastructure dependencies
cd infrastructure
npm install

# Install CDK globally if not already installed
npm install -g aws-cdk

# Verify CDK
cdk --version
✅ Step 5: Bootstrap CDK
# Get your account ID
aws sts get-caller-identity --query Account --output text

# Bootstrap CDK (one-time setup)
cdk bootstrap aws://YOUR_ACCOUNT_ID/ap-southeast-1
# Replace YOUR_ACCOUNT_ID with the actual number from above
✅ Step 6: Deploy Infrastructure
# Synthesize CloudFormation templates (verify everything compiles)
cdk synth --all

# Deploy all stacks (takes 10-15 minutes)
cdk deploy --all --require-approval never

# Or deploy with confirmation prompts:
# cdk deploy --all
✅ Step 7: Save Deployment Outputs
After deployment completes, save these:

# Get API Gateway URL
aws cloudformation describe-stacks `
  --stack-name RDSDashboard-API-prod `
  --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' `
  --output text

# Get API Key

aws cloudformation describe-stacks --stack-name RDSDashboard-API-prod --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text

https://0pjyr8lkpl.execute-api.ap-southeast-1.amazonaws.com/prod/

aws cloudformation describe-stacks --stack-name RDSDashboard-API-prod --query 'Stacks[0].Outputs[?OutputKey==`ApiKeyId`].OutputValue' --output text   
 
r5oxfieb66

aws apigateway get-api-key --api-key $apiKeyId --include-value --query 'value' --output text

mBUq3FxIobYOjMSOmY8K8zgM1UHlxMZ7feV9Mr7g

aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?contains(StackName, 'RDSDashboard')].StackName" --output table
-------------------------------------
|            ListStacks             |
+-----------------------------------+
|  RDSDashboard-Orchestration-prod  |
|  RDSDashboard-Compute-prod        |
|  RDSDashboard-IAM-prod            |
|  RDSDashboard-Data-prod           |
+-----------------------------------+

aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?contains(StackName, 'RDSDashboard')].StackName" --output table

-------------------------------------
|            ListStacks             |
+-----------------------------------+
|  RDSDashboard-API-prod            |
|  RDSDashboard-Monitoring-prod     |
|  RDSDashboard-Orchestration-prod  |
|  RDSDashboard-Compute-prod        |
|  RDSDashboard-IAM-prod            |
|  RDSDashboard-Data-prod           |
+-----------------------------------+

BFF and Secrets deployment:

# BFF (Backend-for-Frontend) Deployment Guide

## Overview

The BFF layer provides a secure proxy between the frontend and the internal API Gateway, eliminating the need to expose API keys in the browser. This solution uses AWS Secrets Manager to securely store API credentials.

## Architecture

```
Frontend (Browser)
    ↓ (No API Key)
BFF API Gateway (Public)
    ↓
BFF Lambda Function
    ↓ (Fetches API Key from Secrets Manager)
Internal API Gateway (Protected)
    ↓
Backend Lambda Functions
```

## Security Benefits

✅ **No API key in frontend code** - Completely eliminated from browser  
✅ **Secrets in AWS Secrets Manager** - Encrypted and rotatable  
✅ **Cached credentials** - BFF caches secrets for 5 minutes to reduce API calls  
✅ **CORS enabled** - Proper cross-origin support  
✅ **Error handling** - Graceful fallbacks  

## Prerequisites

- AWS CLI configured with appropriate credentials
- CDK deployed (API stack must be deployed first)
- PowerShell (for Windows) or Bash (for Linux/Mac)

## Deployment Steps

### Step 1: Deploy the BFF Stack

```powershell
# Navigate to project root
cd rds-operations-dashboard

# Deploy BFF stack
./scripts/deploy-bff.ps1
```

This script will:
1. Deploy the BFF CloudFormation stack
2. Create Secrets Manager secret
3. Populate the secret with API credentials
4. Display the BFF API URL

### Step 2: Update Frontend Configuration

After deployment, update your frontend `.env` file:

```bash
# Get BFF URL
aws cloudformation describe-stacks \
  --stack-name RDSDashboard-BFF-prod \
  --query 'Stacks[0].Outputs[?OutputKey==`BffApiUrl`].OutputValue' \
  --output text
```

Update `frontend/.env`:
```env
VITE_BFF_API_URL=https://your-bff-url.execute-api.ap-southeast-1.amazonaws.com/prod
```

### Step 3: Test Locally

```bash
cd frontend
npm run dev
```

Open http://localhost:5173 and verify:
- Dashboard loads without errors
- API calls work (check browser console)
- No API key visible in network requests

### Step 4: Deploy to Production

```bash
git add .
git commit -m "Add BFF security layer"
git push
```

GitHub Actions will automatically:
1. Detect BFF stack
2. Use BFF URL for frontend build
3. Deploy to S3

## Manual Deployment Steps

If you prefer manual deployment:

### 1. Deploy BFF Stack

```bash
cd rds-operations-dashboard/infrastructure
npx aws-cdk deploy RDSDashboard-BFF-prod --require-approval never
```

### 2. Setup Secrets Manager

```powershell
./scripts/setup-bff-secrets.ps1
```

Or manually:

```bash
# Get API Key ID
API_KEY_ID=$(aws cloudformation describe-stacks \
  --stack-name RDSDashboard-API-prod \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiKeyId`].OutputValue' \
  --output text)

# Get API URL
API_URL=$(aws cloudformation describe-stacks \
  --stack-name RDSDashboard-API-prod \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
  --output text)

# Get API Key value
API_KEY=$(aws apigateway get-api-key \
  --api-key $API_KEY_ID \
  --include-value \
  --query 'value' \
  --output text)

# Update secret
aws secretsmanager update-secret \
  --secret-id rds-dashboard-api-key-prod \
  --secret-string "{\"apiUrl\":\"$API_URL\",\"apiKey\":\"$API_KEY\",\"description\":\"RDS Dashboard API credentials\"}"
```

## Verification

### 1. Check BFF Stack Status

```bash
aws cloudformation describe-stacks \
  --stack-name RDSDashboard-BFF-prod \
  --query 'Stacks[0].StackStatus' \
  --output text
```

Expected: `CREATE_COMPLETE` or `UPDATE_COMPLETE`

### 2. Verify Secrets Manager

```bash
aws secretsmanager describe-secret \
  --secret-id rds-dashboard-api-key-prod
```

### 3. Test BFF Endpoint

```bash
# Get BFF URL
BFF_URL=$(aws cloudformation describe-stacks \
  --stack-name RDSDashboard-BFF-prod \
  --query 'Stacks[0].Outputs[?OutputKey==`BffApiUrl`].OutputValue' \
  --output text)

# Test health endpoint
curl "${BFF_URL}/health"
```

### 4. Check Lambda Logs

```bash
aws logs tail /aws/lambda/rds-dashboard-bff-prod --follow
```

## Troubleshooting

### Issue: BFF returns 500 error

**Cause:** Secret not populated or Lambda can't access it

**Solution:**
```powershell
./scripts/setup-bff-secrets.ps1
```

### Issue: CORS errors in browser

**Cause:** BFF API Gateway CORS not configured

**Solution:** Redeploy BFF stack:
```bash
npx aws-cdk deploy RDSDashboard-BFF-prod --force
```

### Issue: Frontend still using direct API

**Cause:** `VITE_BFF_API_URL` not set

**Solution:** 
1. Check `frontend/.env` has `VITE_BFF_API_URL` set
2. Rebuild frontend: `npm run build`
3. Clear browser cache

### Issue: Secret rotation needed

**Solution:**
```bash
# Rotate API key in API Gateway
aws apigateway update-api-key \
  --api-key <API_KEY_ID> \
  --patch-operations op=replace,path=/value,value=<NEW_KEY>

# Update secret
./scripts/setup-bff-secrets.ps1
```

## Cost Considerations

The BFF solution adds minimal cost:

- **Lambda invocations:** ~$0.20 per 1M requests
- **API Gateway:** ~$3.50 per 1M requests
- **Secrets Manager:** ~$0.40 per secret per month + $0.05 per 10,000 API calls
- **CloudWatch Logs:** ~$0.50 per GB

**Estimated monthly cost for 1M requests:** ~$5

## Security Best Practices

1. **Rotate secrets regularly** - Use AWS Secrets Manager rotation
2. **Monitor BFF logs** - Set up CloudWatch alarms for errors
3. **Limit BFF access** - Consider adding WAF rules if needed
4. **Use VPC endpoints** - For enhanced security (optional)
5. **Enable API Gateway throttling** - Already configured (1000 req/s)

## Rollback Plan

If issues occur, rollback to direct API access:

1. Update `frontend/.env`:
   ```env
   # Comment out BFF URL
   # VITE_BFF_API_URL=https://...
   
   # Use direct API
   VITE_API_BASE_URL=https://0pjyr8lkpl.execute-api.ap-southeast-1.amazonaws.com/prod
   VITE_API_KEY=<your-api-key>
   ```

2. Rebuild and redeploy frontend

3. Delete BFF stack (optional):
   ```bash
   aws cloudformation delete-stack --stack-name RDSDashboard-BFF-prod
   ```

## Monitoring

### CloudWatch Metrics

Monitor these metrics in CloudWatch:

- **BFF Lambda Duration** - Should be < 1000ms
- **BFF Lambda Errors** - Should be 0
- **BFF API Gateway 4XX/5XX** - Should be minimal
- **Secrets Manager API Calls** - Should be low (caching working)

### Set Up Alarms

```bash
# Lambda error alarm
aws cloudwatch put-metric-alarm \
  --alarm-name rds-dashboard-bff-errors \
  --alarm-description "BFF Lambda errors" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 300 \
  --evaluation-periods 1 \
  --threshold 5 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=rds-dashboard-bff-prod
```

## Next Steps

After successful BFF deployment:

1. ✅ Remove API key from frontend code completely
2. ✅ Update documentation to reference BFF URL
3. ✅ Set up monitoring and alarms
4. ✅ Configure secret rotation (optional)
5. ✅ Consider adding WAF for additional security (optional)

## Support

For issues or questions:
1. Check CloudWatch logs: `/aws/lambda/rds-dashboard-bff-prod`
2. Verify Secrets Manager secret is populated
3. Test BFF endpoint directly with curl
4. Review this guide's troubleshooting section


aws cloudformation describe-stacks --stack-name RDSDashboard-BFF-prod --query 'Stacks[0].Outputs[?OutputKey==`BffApiUrl`].OutputValue' --output text
https://08mqqv008c.execute-api.ap-southeast-1.amazonaws.com/prod/

aws cloudformation describe-stacks --stack-name RDSDashboard-BFF-prod --query 'Stacks[0].Outputs' --output json
[
    {
        "OutputKey": "ApiSecretArn",
        "OutputValue": "arn:aws:secretsmanager:ap-southeast-1:876595225096:secret:rds-dashboard-api-key-prod-KjtkXE", 
        "Description": "API Secret ARN in Secrets Manager",        "ExportName": "prod-ApiSecretArn"
    },
    {
        "OutputKey": "BffApiUrl",
        "OutputValue": "https://08mqqv008c.execute-api.ap-southeast-1.amazonaws.com/prod/",
        "Description": "BFF API Gateway URL",
        "ExportName": "prod-BffApiUrl"
    },
    {
        "OutputKey": "BffApiId",
        "OutputValue": "08mqqv008c",
        "Description": "BFF API Gateway ID",
        "ExportName": "prod-BffApiId"
    },
    {
        "OutputKey": "BffApiEndpoint413D959F",
        "OutputValue": "https://08mqqv008c.execute-api.ap-southeast-1.amazonaws.com/prod/"
    }
]

To see latest error info from AWS directly:

aws logs tail /aws/lambda/rds-dashboard-bff-prod --since 5m --format short

aws logs tail /aws/lambda/rds-query-handler-prod --since 2m --format short | Select-Object -Last 30

aws logs tail /aws/lambda/rds-query-handler-prod --since 2m --format short | Select-String "Discovering instances in region" | Select-Object -First 5

$temp = New-Item -ItemType Directory -Path "$env:TEMP\lambda-query-fix3" -Force; Copy-Item -Path "lambda\query-handler\*" -Destination $temp -Recurse -Force; Copy-Item -Path "lambda\shared" -Destination "$temp\shared" -Recurse -Force; Compress-Archive -Path "$temp\*" -DestinationPath "$env:TEMP\query-handler-fix3.zip" -Force; aws lambda update-function-code --function-name rds-query-handler-prod --zip-file "fileb://$env:TEMP\query-handler-fix3.zip" --output json | Out-Null; Remove-Item $temp -Recurse -Force; Remove-Item "$env:TEMP\query-handler-fix3.zip" -Force; Write-Host "Query handler updated - final version"

Start-Sleep -Seconds 5; $apiKey = aws apigateway get-api-key --api-key r5oxfieb66 --include-value --query 'value' --output text; Invoke-WebRequest -Uri "https://0pjyr8lkpl.execute-api.ap-southeast-1.amazonaws.com/prod/instances" -Headers @{"x-api-key"=$apiKey} -Method GET -UseBasicParsing -ErrorAction SilentlyContinue | Select-Object StatusCode, @{Name='ContentLength';Expression={$_.Content.Length}}	

aws rds describe-db-instances --region ap-southeast-1

Compress-Archive -Path *.py -DestinationPath ../discovery-lambda.zip -Force