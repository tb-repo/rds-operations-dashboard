"""
AWS Client Utilities

Generated by: claude-3.5-sonnet
Timestamp: 2025-11-12T17:00:00Z
Version: 1.0.0
Policy Version: v1.0.0
Traceability: REQ-1.1, REQ-9.1 → DESIGN-001 → TASK-1
Review Status: Pending
Risk Level: Level 2

Purpose: Centralized AWS service client creation with cross-account role assumption
and retry logic. Provides reusable clients for STS, RDS, CloudWatch, DynamoDB, S3, SNS.

Design Decisions:
- Singleton pattern for client reuse (reduces connection overhead)
- Automatic retry with exponential backoff for transient errors
- Cross-account role assumption with external ID for security
- Session caching to minimize STS API calls
"""

import os
import boto3
from botocore.config import Config
from botocore.exceptions import ClientError
from typing import Optional, Dict
import logging

logger = logging.getLogger(__name__)

# AWS SDK configuration with retry logic
BOTO_CONFIG = Config(
    retries={
        'max_attempts': 3,
        'mode': 'adaptive'  # Adaptive retry mode for better handling of throttling
    },
    connect_timeout=5,
    read_timeout=30,
    max_pool_connections=50
)

# Cache for assumed role sessions
_session_cache: Dict[str, boto3.Session] = {}


class AWSClients:
    """
    Factory class for creating AWS service clients with cross-account support.
    
    Usage:
        # Local account clients
        rds = AWSClients.get_rds_client()
        dynamodb = AWSClients.get_dynamodb_client()
        
        # Cross-account clients
        rds = AWSClients.get_rds_client(
            account_id='123456789012',
            role_name='RDSDashboardCrossAccountRole',
            external_id='rds-dashboard-unique-id-12345'
        )
    """
    
    @staticmethod
    def get_sts_client() -> boto3.client:
        """
        Get STS client for role assumption.
        
        Returns:
            boto3.client: STS client
        """
        return boto3.client('sts', config=BOTO_CONFIG)
    
    @staticmethod
    def assume_role(
        account_id: str,
        role_name: str,
        external_id: str,
        session_name: Optional[str] = None
    ) -> boto3.Session:
        """
        Assume cross-account IAM role and return session.
        
        Args:
            account_id: Target AWS account ID
            role_name: IAM role name to assume
            external_id: External ID for trust policy
            session_name: Optional session name (defaults to 'rds-dashboard-session')
        
        Returns:
            boto3.Session: Session with assumed role credentials
        
        Raises:
            ClientError: If role assumption fails
        
        Requirements: REQ-9.1 (cross-account access), REQ-9.4 (external ID)
        """
        cache_key = f"{account_id}:{role_name}"
        
        # Return cached session if available and not expired
        # Note: Sessions expire after 1 hour by default
        if cache_key in _session_cache:
            logger.debug(f"Using cached session for {cache_key}")
            return _session_cache[cache_key]
        
        session_name = session_name or 'rds-dashboard-session'
        role_arn = f"arn:aws:iam::{account_id}:role/{role_name}"
        
        try:
            sts_client = AWSClients.get_sts_client()
            
            logger.info(f"Assuming role: {role_arn}")
            response = sts_client.assume_role(
                RoleArn=role_arn,
                RoleSessionName=session_name,
                ExternalId=external_id,
                DurationSeconds=3600  # 1 hour
            )
            
            credentials = response['Credentials']
            session = boto3.Session(
                aws_access_key_id=credentials['AccessKeyId'],
                aws_secret_access_key=credentials['SecretAccessKey'],
                aws_session_token=credentials['SessionToken']
            )
            
            # Cache session
            _session_cache[cache_key] = session
            logger.info(f"Successfully assumed role: {role_arn}")
            
            return session
            
        except ClientError as e:
            error_code = e.response['Error']['Code']
            error_message = e.response['Error']['Message']
            logger.error(f"Failed to assume role {role_arn}: {error_code} - {error_message}")
            raise
    
    @staticmethod
    def get_rds_client(
        region: Optional[str] = None,
        account_id: Optional[str] = None,
        role_name: Optional[str] = None,
        external_id: Optional[str] = None
    ) -> boto3.client:
        """
        Get RDS client (local or cross-account).
        
        Args:
            region: AWS region (defaults to environment variable or ap-southeast-1)
            account_id: Target account ID for cross-account access
            role_name: IAM role name for cross-account access
            external_id: External ID for cross-account access
        
        Returns:
            boto3.client: RDS client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        
        if account_id and role_name and external_id:
            session = AWSClients.assume_role(account_id, role_name, external_id)
            return session.client('rds', region_name=region, config=BOTO_CONFIG)
        else:
            return boto3.client('rds', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_cloudwatch_client(
        region: Optional[str] = None,
        account_id: Optional[str] = None,
        role_name: Optional[str] = None,
        external_id: Optional[str] = None
    ) -> boto3.client:
        """
        Get CloudWatch client (local or cross-account).
        
        Args:
            region: AWS region
            account_id: Target account ID for cross-account access
            role_name: IAM role name for cross-account access
            external_id: External ID for cross-account access
        
        Returns:
            boto3.client: CloudWatch client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        
        if account_id and role_name and external_id:
            session = AWSClients.assume_role(account_id, role_name, external_id)
            return session.client('cloudwatch', region_name=region, config=BOTO_CONFIG)
        else:
            return boto3.client('cloudwatch', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_dynamodb_resource(region: Optional[str] = None) -> boto3.resource:
        """
        Get DynamoDB resource (local account only).
        
        Args:
            region: AWS region
        
        Returns:
            boto3.resource: DynamoDB resource
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        return boto3.resource('dynamodb', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_dynamodb_client(region: Optional[str] = None) -> boto3.client:
        """
        Get DynamoDB client (local account only).
        
        Args:
            region: AWS region
        
        Returns:
            boto3.client: DynamoDB client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        return boto3.client('dynamodb', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_s3_client(region: Optional[str] = None) -> boto3.client:
        """
        Get S3 client (local account only).
        
        Args:
            region: AWS region
        
        Returns:
            boto3.client: S3 client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        return boto3.client('s3', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_sns_client(region: Optional[str] = None) -> boto3.client:
        """
        Get SNS client (local account only).
        
        Args:
            region: AWS region
        
        Returns:
            boto3.client: SNS client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        return boto3.client('sns', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def get_cloudwatch_logs_client(region: Optional[str] = None) -> boto3.client:
        """
        Get CloudWatch Logs client (local account only).
        
        Args:
            region: AWS region
        
        Returns:
            boto3.client: CloudWatch Logs client
        """
        region = region or os.environ.get('AWS_REGION', 'ap-southeast-1')
        return boto3.client('logs', region_name=region, config=BOTO_CONFIG)
    
    @staticmethod
    def clear_session_cache():
        """
        Clear cached assumed role sessions.
        Useful for testing or when credentials need to be refreshed.
        """
        global _session_cache
        _session_cache.clear()
        logger.info("Cleared session cache")
