"""
Metrics Cache Manager

Generated by: claude-3.5-sonnet
Timestamp: 2025-11-12T19:00:00Z
Version: 1.0.0
Policy Version: v1.0.0
Traceability: REQ-2.2, REQ-8.2, REQ-8.3, REQ-8.4 → DESIGN-001 → TASK-3.1
Review Status: Pending
Risk Level: Level 2

Purpose: Manage CloudWatch metrics caching in DynamoDB with TTL.
Tracks cache hit rate and publishes metrics to CloudWatch.

Design Decisions:
- 5-minute TTL for all metrics (configurable)
- Cache key format: {instance_id}#{metric_name}#{period}
- Automatic TTL expiration via DynamoDB
- Cache hit rate tracking for optimization
"""

import os
from datetime import datetime
from typing import Optional, Dict, Any
from decimal import Decimal

import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from shared import AWSClients, StructuredLogger

logger = StructuredLogger('cache-manager')


class MetricsCacheManager:
    """
    Manages caching of CloudWatch metrics in DynamoDB.
    
    Usage:
        cache = MetricsCacheManager(config)
        
        # Try to get from cache
        cached_value = cache.get('instance-1', 'CPUUtilization', 300)
        
        # Store in cache
        cache.put('instance-1', 'CPUUtilization', 300, 45.2, datetime.utcnow(), 'Percent')
        
        # Get cache statistics
        stats = cache.get_statistics()
    """
    
    def __init__(self, config: Any):
        """
        Initialize cache manager.
        
        Args:
            config: Application configuration
        """
        self.config = config
        self.cache_hits = 0
        self.cache_misses = 0
        self.cache_writes = 0
        self.cache_errors = 0
        
        # Get DynamoDB table
        dynamodb = AWSClients.get_dynamodb_resource()
        self.table = dynamodb.Table(config.dynamodb.metrics_cache_table)
    
    def get(
        self,
        instance_id: str,
        metric_name: str,
        period: int
    ) -> Optional[Dict[str, Any]]:
        """
        Get metric from cache if available and fresh.
        
        Args:
            instance_id: RDS instance identifier
            metric_name: CloudWatch metric name
            period: Metric period in seconds
        
        Returns:
            dict: Cached metric data or None if not found/expired
        
        Requirements: REQ-8.2 (caching), REQ-8.3 (TTL)
        """
        cache_key = self._build_cache_key(instance_id, metric_name, period)
        
        try:
            response = self.table.get_item(Key={'cache_key': cache_key})
            
            if 'Item' in response:
                item = response['Item']
                
                # Check TTL
                ttl = item.get('ttl', 0)
                current_time = int(datetime.utcnow().timestamp())
                
                if ttl > current_time:
                    self.cache_hits += 1
                    logger.debug(f'Cache hit: {cache_key}',
                               instance_id=instance_id,
                               metric_name=metric_name)
                    return self._convert_from_dynamodb(item)
                else:
                    self.cache_misses += 1
                    logger.debug(f'Cache expired: {cache_key}',
                               instance_id=instance_id,
                               metric_name=metric_name)
                    return None
            
            self.cache_misses += 1
            logger.debug(f'Cache miss: {cache_key}',
                       instance_id=instance_id,
                       metric_name=metric_name)
            return None
            
        except Exception as e:
            self.cache_errors += 1
            logger.error('Failed to get from cache',
                        cache_key=cache_key,
                        error=str(e))
            return None
    
    def put(
        self,
        instance_id: str,
        metric_name: str,
        period: int,
        value: float,
        timestamp: datetime,
        unit: str
    ) -> bool:
        """
        Store metric in cache with TTL.
        
        Args:
            instance_id: RDS instance identifier
            metric_name: CloudWatch metric name
            period: Metric period in seconds
            value: Metric value
            timestamp: Metric timestamp
            unit: Metric unit
        
        Returns:
            bool: True if successful
        
        Requirements: REQ-8.2 (caching), REQ-8.3 (TTL)
        """
        cache_key = self._build_cache_key(instance_id, metric_name, period)
        
        try:
            # Calculate TTL
            ttl = int(datetime.utcnow().timestamp()) + self.config.cache.metrics_ttl_seconds
            
            # Prepare item
            item = {
                'cache_key': cache_key,
                'instance_id': instance_id,
                'metric_name': metric_name,
                'period': period,
                'value': Decimal(str(value)),  # Convert to Decimal for DynamoDB
                'timestamp': timestamp.isoformat(),
                'unit': unit,
                'ttl': ttl,
                'cached_at': datetime.utcnow().isoformat() + 'Z'
            }
            
            # Store in DynamoDB
            self.table.put_item(Item=item)
            
            self.cache_writes += 1
            logger.debug(f'Stored in cache: {cache_key}',
                       instance_id=instance_id,
                       metric_name=metric_name,
                       value=value)
            
            return True
            
        except Exception as e:
            self.cache_errors += 1
            logger.error('Failed to store in cache',
                        cache_key=cache_key,
                        error=str(e))
            return False
    
    def get_statistics(self) -> Dict[str, Any]:
        """
        Get cache statistics for this session.
        
        Returns:
            dict: Cache statistics
        
        Requirements: REQ-8.4 (cache hit rate tracking)
        """
        total_requests = self.cache_hits + self.cache_misses
        cache_hit_rate = (self.cache_hits / total_requests * 100) if total_requests > 0 else 0
        
        return {
            'cache_hits': self.cache_hits,
            'cache_misses': self.cache_misses,
            'cache_writes': self.cache_writes,
            'cache_errors': self.cache_errors,
            'total_requests': total_requests,
            'cache_hit_rate': round(cache_hit_rate, 2)
        }
    
    def publish_cache_metrics(self) -> None:
        """
        Publish cache statistics to CloudWatch.
        
        Requirements: REQ-8.4 (cache hit rate monitoring)
        """
        try:
            stats = self.get_statistics()
            
            cloudwatch = AWSClients.get_cloudwatch_client()
            namespace = self.config.monitoring.cloudwatch_namespace
            
            metrics = [
                {
                    'MetricName': 'CacheHits',
                    'Value': stats['cache_hits'],
                    'Unit': 'Count'
                },
                {
                    'MetricName': 'CacheMisses',
                    'Value': stats['cache_misses'],
                    'Unit': 'Count'
                },
                {
                    'MetricName': 'CacheHitRate',
                    'Value': stats['cache_hit_rate'],
                    'Unit': 'Percent'
                },
                {
                    'MetricName': 'CacheWrites',
                    'Value': stats['cache_writes'],
                    'Unit': 'Count'
                },
                {
                    'MetricName': 'CacheErrors',
                    'Value': stats['cache_errors'],
                    'Unit': 'Count'
                }
            ]
            
            cloudwatch.put_metric_data(
                Namespace=namespace,
                MetricData=metrics
            )
            
            logger.info('Published cache metrics to CloudWatch',
                       cache_hit_rate=stats['cache_hit_rate'],
                       cache_hits=stats['cache_hits'],
                       cache_misses=stats['cache_misses'])
            
        except Exception as e:
            logger.error('Failed to publish cache metrics',
                        error=str(e))
    
    def _build_cache_key(
        self,
        instance_id: str,
        metric_name: str,
        period: int
    ) -> str:
        """
        Build cache key from components.
        
        Args:
            instance_id: RDS instance identifier
            metric_name: CloudWatch metric name
            period: Metric period in seconds
        
        Returns:
            str: Cache key
        """
        return f"{instance_id}#{metric_name}#{period}"
    
    def _convert_from_dynamodb(self, item: Dict[str, Any]) -> Dict[str, Any]:
        """
        Convert DynamoDB item to standard format.
        
        Args:
            item: DynamoDB item
        
        Returns:
            dict: Converted item
        """
        # Convert Decimal to float
        if 'value' in item and isinstance(item['value'], Decimal):
            item['value'] = float(item['value'])
        
        return item
    
    def clear_expired_entries(self) -> int:
        """
        Manually clear expired cache entries.
        Note: DynamoDB TTL handles this automatically, but this can be used for testing.
        
        Returns:
            int: Number of entries cleared
        """
        try:
            current_time = int(datetime.utcnow().timestamp())
            
            # Scan for expired entries
            response = self.table.scan(
                FilterExpression='#ttl < :current_time',
                ExpressionAttributeNames={'#ttl': 'ttl'},
                ExpressionAttributeValues={':current_time': current_time}
            )
            
            expired_items = response.get('Items', [])
            
            # Delete expired entries
            with self.table.batch_writer() as batch:
                for item in expired_items:
                    batch.delete_item(Key={'cache_key': item['cache_key']})
            
            logger.info(f'Cleared {len(expired_items)} expired cache entries')
            
            return len(expired_items)
            
        except Exception as e:
            logger.error('Failed to clear expired entries',
                        error=str(e))
            return 0
