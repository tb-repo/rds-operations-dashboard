"""
Correlation ID Middleware

Generated by: claude-3.5-sonnet
Timestamp: 2025-12-03T00:00:00Z
Version: 1.0.0
Policy Version: v1.0.0
Traceability: REQ-5.1 → DESIGN-5.1 → TASK-4.2
Review Status: Pending
Risk Level: Level 2

Purpose: Extract, generate, and propagate correlation IDs across Lambda invocations
and downstream service calls for distributed tracing.

Features:
- Automatic extraction from API Gateway events
- Generation of new correlation IDs when not present
- Propagation to downstream AWS service calls
- Integration with AWS X-Ray
"""

import uuid
import boto3
from typing import Any, Dict, Optional, Callable
from functools import wraps


class CorrelationContext:
    """
    Thread-local storage for correlation ID.
    
    This allows correlation IDs to be accessed anywhere in the call stack
    without explicitly passing them through function parameters.
    """
    
    _correlation_id: Optional[str] = None
    
    @classmethod
    def set(cls, correlation_id: str):
        """Set the correlation ID for the current context."""
        cls._correlation_id = correlation_id
    
    @classmethod
    def get(cls) -> Optional[str]:
        """Get the correlation ID from the current context."""
        return cls._correlation_id
    
    @classmethod
    def clear(cls):
        """Clear the correlation ID from the current context."""
        cls._correlation_id = None


def extract_correlation_id(event: Dict[str, Any]) -> str:
    """
    Extract correlation ID from Lambda event.
    
    Checks multiple sources in priority order:
    1. X-Correlation-ID header (API Gateway)
    2. X-Request-ID header (API Gateway)
    3. correlationId field (direct invocation)
    4. requestContext.requestId (API Gateway)
    5. Generate new UUID
    
    Args:
        event: Lambda event dictionary
    
    Returns:
        str: Correlation ID
    
    Requirements: REQ-5.1 (correlation ID propagation)
    """
    # Check headers (API Gateway)
    headers = event.get('headers', {})
    if headers:
        # Try X-Correlation-ID (case-insensitive)
        for key, value in headers.items():
            if key.lower() == 'x-correlation-id':
                return value
        
        # Try X-Request-ID (case-insensitive)
        for key, value in headers.items():
            if key.lower() == 'x-request-id':
                return value
    
    # Check direct invocation payload
    if 'correlationId' in event:
        return event['correlationId']
    
    # Check API Gateway request context
    request_context = event.get('requestContext', {})
    if request_context and 'requestId' in request_context:
        return request_context['requestId']
    
    # Generate new UUID
    return str(uuid.uuid4())


def inject_correlation_id(
    params: Dict[str, Any],
    correlation_id: str,
    param_name: str = 'correlationId'
) -> Dict[str, Any]:
    """
    Inject correlation ID into parameters for downstream calls.
    
    Args:
        params: Parameters dictionary
        correlation_id: Correlation ID to inject
        param_name: Parameter name (default: 'correlationId')
    
    Returns:
        Dict: Parameters with correlation ID injected
    
    Example:
        params = {'FunctionName': 'my-function', 'Payload': json.dumps(payload)}
        params = inject_correlation_id(params, correlation_id)
    """
    if 'Payload' in params:
        # For Lambda invocations, inject into payload
        import json
        try:
            payload = json.loads(params['Payload'])
            if isinstance(payload, dict):
                payload[param_name] = correlation_id
                params['Payload'] = json.dumps(payload)
        except (json.JSONDecodeError, TypeError):
            pass
    else:
        # For other calls, inject at top level
        params[param_name] = correlation_id
    
    return params


def with_correlation_id(func: Callable) -> Callable:
    """
    Decorator to automatically extract and set correlation ID from Lambda event.
    
    Usage:
        @with_correlation_id
        def lambda_handler(event, context):
            # Correlation ID is automatically extracted and set in context
            correlation_id = CorrelationContext.get()
            logger = get_logger('my-service', correlation_id=correlation_id)
            logger.info('Processing request')
    
    Args:
        func: Lambda handler function
    
    Returns:
        Callable: Decorated function
    
    Requirements: REQ-5.1 (correlation ID propagation)
    """
    @wraps(func)
    def wrapper(event, context):
        # Extract correlation ID from event
        correlation_id = extract_correlation_id(event)
        
        # Set in context
        CorrelationContext.set(correlation_id)
        
        # Add to X-Ray segment if available
        try:
            from aws_xray_sdk.core import xray_recorder
            segment = xray_recorder.current_segment()
            if segment:
                segment.put_annotation('correlation_id', correlation_id)
        except ImportError:
            pass  # X-Ray SDK not installed
        except Exception:
            pass  # X-Ray not enabled or segment not available
        
        try:
            # Call original function
            result = func(event, context)
            
            # Inject correlation ID into response headers if API Gateway
            if isinstance(result, dict) and 'headers' in result:
                if result['headers'] is None:
                    result['headers'] = {}
                result['headers']['X-Correlation-ID'] = correlation_id
            
            return result
        finally:
            # Clear context
            CorrelationContext.clear()
    
    return wrapper


class CorrelationAwareClient:
    """
    Wrapper for boto3 clients that automatically propagates correlation IDs.
    
    Usage:
        # Instead of:
        lambda_client = boto3.client('lambda')
        
        # Use:
        lambda_client = CorrelationAwareClient('lambda')
        
        # Correlation ID is automatically injected into all calls
        lambda_client.invoke(
            FunctionName='my-function',
            Payload=json.dumps({'key': 'value'})
        )
    """
    
    def __init__(self, service_name: str, **kwargs):
        """
        Initialize correlation-aware client.
        
        Args:
            service_name: AWS service name (e.g., 'lambda', 'dynamodb')
            **kwargs: Additional arguments for boto3.client()
        """
        self.service_name = service_name
        self.client = boto3.client(service_name, **kwargs)
    
    def __getattr__(self, name: str):
        """
        Intercept method calls to inject correlation ID.
        
        Args:
            name: Method name
        
        Returns:
            Callable: Wrapped method
        """
        original_method = getattr(self.client, name)
        
        @wraps(original_method)
        def wrapper(*args, **kwargs):
            # Get correlation ID from context
            correlation_id = CorrelationContext.get()
            
            if correlation_id:
                # Inject correlation ID based on service
                if self.service_name == 'lambda' and name == 'invoke':
                    kwargs = inject_correlation_id(kwargs, correlation_id)
                elif self.service_name == 'sns' and name == 'publish':
                    # Inject into message attributes
                    if 'MessageAttributes' not in kwargs:
                        kwargs['MessageAttributes'] = {}
                    kwargs['MessageAttributes']['CorrelationId'] = {
                        'DataType': 'String',
                        'StringValue': correlation_id
                    }
                elif self.service_name == 'sqs' and name == 'send_message':
                    # Inject into message attributes
                    if 'MessageAttributes' not in kwargs:
                        kwargs['MessageAttributes'] = {}
                    kwargs['MessageAttributes']['CorrelationId'] = {
                        'DataType': 'String',
                        'StringValue': correlation_id
                    }
            
            # Call original method
            return original_method(*args, **kwargs)
        
        return wrapper


def get_correlation_aware_client(service_name: str, **kwargs):
    """
    Get a correlation-aware boto3 client.
    
    Args:
        service_name: AWS service name
        **kwargs: Additional arguments for boto3.client()
    
    Returns:
        CorrelationAwareClient: Wrapped boto3 client
    
    Example:
        lambda_client = get_correlation_aware_client('lambda')
        lambda_client.invoke(
            FunctionName='downstream-function',
            Payload=json.dumps({'data': 'value'})
        )
        # Correlation ID is automatically injected
    """
    return CorrelationAwareClient(service_name, **kwargs)


# Example usage
if __name__ == '__main__':
    import json
    
    # Example API Gateway event
    event = {
        'headers': {
            'X-Correlation-ID': 'test-correlation-123'
        },
        'body': json.dumps({'key': 'value'})
    }
    
    # Extract correlation ID
    correlation_id = extract_correlation_id(event)
    print(f"Extracted correlation ID: {correlation_id}")
    
    # Set in context
    CorrelationContext.set(correlation_id)
    
    # Get from context
    retrieved_id = CorrelationContext.get()
    print(f"Retrieved correlation ID: {retrieved_id}")
    
    # Example Lambda handler with decorator
    @with_correlation_id
    def example_handler(event, context):
        correlation_id = CorrelationContext.get()
        print(f"Handler correlation ID: {correlation_id}")
        
        # Use correlation-aware client
        lambda_client = get_correlation_aware_client('lambda')
        # lambda_client.invoke(...) would automatically include correlation ID
        
        return {
            'statusCode': 200,
            'headers': {},
            'body': json.dumps({'message': 'Success'})
        }
    
    # Simulate Lambda context
    class MockContext:
        aws_request_id = 'mock-request-id'
        function_name = 'test-function'
    
    # Call handler
    result = example_handler(event, MockContext())
    print(f"Result: {json.dumps(result, indent=2)}")
    
    # Check that correlation ID was injected into response
    assert 'X-Correlation-ID' in result['headers']
    print(f"Response correlation ID: {result['headers']['X-Correlation-ID']}")
