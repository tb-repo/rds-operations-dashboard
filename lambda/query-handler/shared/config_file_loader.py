"""
Configuration File Loader for Lambda Functions

Generated by: claude-3.5-sonnet
Timestamp: 2025-11-12T18:45:00Z
Version: 1.0.0

Purpose: Load dashboard configuration from JSON file or S3.
Provides fallback to environment variables for backward compatibility.
"""

import json
import os
from typing import List, Dict, Any, Optional
from dataclasses import dataclass

import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from aws_clients import AWSClients
from logger import StructuredLogger

logger = StructuredLogger('config-file-loader')


@dataclass
class AccountConfig:
    """Target account configuration."""
    account_id: str
    account_name: str
    enabled: bool


@dataclass
class RegionConfig:
    """Target region configuration."""
    region: str
    region_name: str
    enabled: bool
    priority: int


@dataclass
class DashboardConfigFile:
    """Dashboard configuration from file."""
    version: str
    deployment: Dict[str, Any]
    cross_account: Dict[str, Any]
    discovery: Dict[str, Any]
    monitoring: Dict[str, Any]
    caching: Dict[str, Any]
    logging: Dict[str, Any]
    tags: Dict[str, str]


class ConfigFileLoader:
    """
    Load configuration from JSON file stored in S3 or local filesystem.
    
    Usage:
        config = ConfigFileLoader.load()
        accounts = ConfigFileLoader.get_enabled_accounts(config)
        regions = ConfigFileLoader.get_enabled_regions(config)
    """
    
    _instance: Optional[DashboardConfigFile] = None
    
    @classmethod
    def load(cls, s3_bucket: Optional[str] = None, s3_key: Optional[str] = None) -> DashboardConfigFile:
        """
        Load configuration from S3 or local file.
        
        Args:
            s3_bucket: S3 bucket name (optional)
            s3_key: S3 object key (optional)
        
        Returns:
            DashboardConfigFile: Loaded configuration
        """
        if cls._instance:
            return cls._instance
        
        try:
            # Try loading from S3 first
            if s3_bucket and s3_key:
                config_data = cls._load_from_s3(s3_bucket, s3_key)
            # Fall back to local file
            elif os.path.exists('/opt/config/dashboard-config.json'):
                config_data = cls._load_from_file('/opt/config/dashboard-config.json')
            # Fall back to relative path (for local testing)
            elif os.path.exists('../../config/dashboard-config.json'):
                config_data = cls._load_from_file('../../config/dashboard-config.json')
            else:
                logger.warn('Config file not found, using environment variables')
                return None
            
            cls._instance = DashboardConfigFile(**config_data)
            logger.info('Configuration loaded from file',
                       version=cls._instance.version,
                       environment=cls._instance.deployment['environment'])
            
            return cls._instance
            
        except Exception as e:
            logger.error('Failed to load configuration file',
                        error=str(e))
            return None
    
    @classmethod
    def _load_from_s3(cls, bucket: str, key: str) -> Dict[str, Any]:
        """Load configuration from S3."""
        try:
            s3 = AWSClients.get_s3_client()
            response = s3.get_object(Bucket=bucket, Key=key)
            content = response['Body'].read().decode('utf-8')
            return json.loads(content)
        except Exception as e:
            logger.error('Failed to load config from S3',
                        bucket=bucket,
                        key=key,
                        error=str(e))
            raise
    
    @classmethod
    def _load_from_file(cls, file_path: str) -> Dict[str, Any]:
        """Load configuration from local file."""
        try:
            with open(file_path, 'r') as f:
                return json.load(f)
        except Exception as e:
            logger.error('Failed to load config from file',
                        file_path=file_path,
                        error=str(e))
            raise
    
    @classmethod
    def get_enabled_accounts(cls, config: Optional[DashboardConfigFile]) -> List[str]:
        """
        Get list of enabled account IDs.
        
        Args:
            config: Dashboard configuration
        
        Returns:
            list: Enabled account IDs
        """
        if not config:
            # Fallback to environment variable
            accounts_str = os.environ.get('TARGET_ACCOUNTS', '[]')
            return json.loads(accounts_str)
        
        accounts = config.cross_account.get('target_accounts', [])
        return [
            acc['account_id']
            for acc in accounts
            if acc.get('enabled', True)
        ]
    
    @classmethod
    def get_enabled_regions(cls, config: Optional[DashboardConfigFile]) -> List[str]:
        """
        Get list of enabled regions sorted by priority.
        
        Args:
            config: Dashboard configuration
        
        Returns:
            list: Enabled regions
        """
        if not config:
            # Fallback to environment variable
            regions_str = os.environ.get('TARGET_REGIONS', 
                                        '["ap-southeast-1","eu-west-2","ap-south-1","us-east-1"]')
            return json.loads(regions_str)
        
        regions = config.cross_account.get('target_regions', [])
        enabled_regions = [
            reg for reg in regions
            if reg.get('enabled', True)
        ]
        
        # Sort by priority
        enabled_regions.sort(key=lambda r: r.get('priority', 999))
        
        return [reg['region'] for reg in enabled_regions]
    
    @classmethod
    def get_external_id(cls, config: Optional[DashboardConfigFile]) -> str:
        """Get external ID for cross-account access."""
        if not config:
            return os.environ.get('EXTERNAL_ID', '')
        
        return config.cross_account.get('external_id', '')
    
    @classmethod
    def get_role_name(cls, config: Optional[DashboardConfigFile]) -> str:
        """Get cross-account role name."""
        if not config:
            return os.environ.get('CROSS_ACCOUNT_ROLE_NAME', 'RDSDashboardCrossAccountRole')
        
        return config.cross_account.get('role_name', 'RDSDashboardCrossAccountRole')
    
    @classmethod
    def clear_cache(cls):
        """Clear cached configuration."""
        cls._instance = None
