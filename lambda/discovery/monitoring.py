"""
RDS Discovery Monitoring and Alerting Module

Generated by: claude-3.5-sonnet
Timestamp: 2025-11-12T18:00:00Z
Version: 1.0.0
Policy Version: v1.0.0
Traceability: REQ-1.5, REQ-9.4, REQ-10.5 → DESIGN-001 → TASK-2.2
Review Status: Pending
Risk Level: Level 2

Purpose: Send CloudWatch metrics and SNS notifications for discovery events.
Handles success/failure tracking and significant inventory changes.

Design Decisions:
- CloudWatch custom metrics for monitoring
- SNS notifications for critical events only
- Threshold-based alerting (> 10% inventory change)
"""

import os
from typing import Dict, Any
from datetime import datetime

import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from shared import AWSClients, StructuredLogger

logger = StructuredLogger('discovery-monitoring')


def publish_discovery_metrics(
    discovery_results: Dict[str, Any],
    persistence_results: Dict[str, Any],
    config: Any
) -> None:
    """
    Publish discovery metrics to CloudWatch.
    
    Args:
        discovery_results: Results from discovery process
        persistence_results: Results from persistence process
        config: Application configuration
    
    Requirements: REQ-10.5 (monitoring metrics)
    """
    try:
        cloudwatch = AWSClients.get_cloudwatch_client()
        namespace = config.monitoring.cloudwatch_namespace
        
        metrics = [
            {
                'MetricName': 'InstancesDiscovered',
                'Value': discovery_results['total_instances'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'AccountsScanned',
                'Value': discovery_results['accounts_scanned'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'RegionsScanned',
                'Value': discovery_results['regions_scanned'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'NewInstances',
                'Value': persistence_results['new_instances'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'UpdatedInstances',
                'Value': persistence_results['updated_instances'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'DeletedInstances',
                'Value': persistence_results['deleted_instances'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'DiscoveryErrors',
                'Value': len(discovery_results['errors']) + persistence_results['errors'],
                'Unit': 'Count'
            },
            {
                'MetricName': 'DiscoverySuccess',
                'Value': 1 if len(discovery_results['errors']) == 0 else 0,
                'Unit': 'Count'
            }
        ]
        
        # Publish metrics
        cloudwatch.put_metric_data(
            Namespace=namespace,
            MetricData=metrics
        )
        
        logger.info('Published discovery metrics to CloudWatch',
                   metrics_count=len(metrics))
        
    except Exception as e:
        logger.error('Failed to publish CloudWatch metrics',
                    error=str(e))


def send_discovery_notification(
    discovery_results: Dict[str, Any],
    persistence_results: Dict[str, Any],
    config: Any
) -> None:
    """
    Send SNS notification for significant discovery events.
    
    Args:
        discovery_results: Results from discovery process
        persistence_results: Results from persistence process
        config: Application configuration
    
    Requirements: REQ-1.5 (alerting), REQ-9.4 (notifications)
    """
    # Determine if notification is needed
    should_notify, reason = should_send_notification(
        discovery_results,
        persistence_results
    )
    
    if not should_notify:
        logger.debug('No notification needed')
        return
    
    try:
        sns = AWSClients.get_sns_client()
        
        # Build notification message
        message = build_notification_message(
            discovery_results,
            persistence_results,
            reason
        )
        
        # Publish to SNS
        sns.publish(
            TopicArn=config.monitoring.sns_topic_arn,
            Subject=f'RDS Discovery Alert: {reason}',
            Message=message
        )
        
        logger.info('Sent discovery notification',
                   reason=reason)
        
    except Exception as e:
        logger.error('Failed to send SNS notification',
                    error=str(e))



def should_send_notification(
    discovery_results: Dict[str, Any],
    persistence_results: Dict[str, Any]
) -> tuple[bool, str]:
    """
    Determine if SNS notification should be sent.
    
    Args:
        discovery_results: Results from discovery
        persistence_results: Results from persistence
    
    Returns:
        tuple: (should_notify, reason)
    """
    # Notify on discovery failures
    if len(discovery_results['errors']) > 0:
        return True, 'Discovery Failures'
    
    # Notify on significant new instances (> 5)
    if persistence_results['new_instances'] > 5:
        return True, f"{persistence_results['new_instances']} New Instances"
    
    # Notify on significant deletions (> 3)
    if persistence_results['deleted_instances'] > 3:
        return True, f"{persistence_results['deleted_instances']} Deleted Instances"
    
    # Notify on persistence errors
    if persistence_results['errors'] > 0:
        return True, 'Persistence Errors'
    
    return False, ''


def build_notification_message(
    discovery_results: Dict[str, Any],
    persistence_results: Dict[str, Any],
    reason: str
) -> str:
    """
    Build SNS notification message.
    
    Args:
        discovery_results: Results from discovery
        persistence_results: Results from persistence
        reason: Reason for notification
    
    Returns:
        str: Formatted notification message
    """
    message = f"""
RDS Discovery Alert: {reason}

Discovery Summary:
- Total Instances Discovered: {discovery_results['total_instances']}
- Accounts Scanned: {discovery_results['accounts_scanned']}
- Regions Scanned: {discovery_results['regions_scanned']}
- Discovery Timestamp: {discovery_results['discovery_timestamp']}

Persistence Summary:
- New Instances: {persistence_results['new_instances']}
- Updated Instances: {persistence_results['updated_instances']}
- Unchanged Instances: {persistence_results['unchanged_instances']}
- Deleted Instances: {persistence_results['deleted_instances']}
- Persistence Errors: {persistence_results['errors']}

"""
    
    # Add error details if present
    if discovery_results['errors']:
        message += "\nDiscovery Errors:\n"
        for error in discovery_results['errors'][:5]:  # Limit to first 5
            message += f"- Account: {error.get('account_id', 'N/A')}, "
            message += f"Region: {error.get('region', 'N/A')}, "
            message += f"Error: {error.get('error', 'Unknown')}\n"
        
        if len(discovery_results['errors']) > 5:
            message += f"... and {len(discovery_results['errors']) - 5} more errors\n"
    
    message += "\nPlease check CloudWatch Logs for detailed information."
    
    return message
