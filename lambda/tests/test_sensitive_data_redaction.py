#!/usr/bin/env python3
"""
Tests for Sensitive Data Redaction

Generated by: claude-3.5-sonnet
Timestamp: 2025-12-03T00:00:00Z
Version: 1.0.0
Policy Version: v1.0.0
Traceability: REQ-6.4 → DESIGN-6.4 → TASK-4.4
Review Status: Pending
Risk Level: Level 2

Purpose: Verify that sensitive data is properly redacted from logs.
"""

import pytest
import sys
import os

# Add parent directory to path
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from shared.structured_logger import sanitize_log_data, redact_patterns


class TestSensitiveDataRedaction:
    """Test suite for sensitive data redaction."""
    
    def test_password_redaction(self):
        """Test that password fields are redacted."""
        data = {
            'username': 'john.doe',
            'password': 'secret123',
            'email': 'john.doe@example.com'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['password'] == '[REDACTED]'
        assert sanitized['username'] == 'john.doe'
    
    def test_api_key_redaction(self):
        """Test that API keys are redacted."""
        data = {
            'api_key': 'sk_live_1234567890abcdef',
            'api_secret': 'secret_key_value',
            'instance_id': 'i-1234567890'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['api_key'] == '[REDACTED]'
        assert sanitized['api_secret'] == '[REDACTED]'
        assert sanitized['instance_id'] == 'i-1234567890'
    
    def test_aws_credentials_redaction(self):
        """Test that AWS credentials are redacted."""
        data = {
            'aws_access_key_id': 'AKIAIOSFODNN7EXAMPLE',
            'aws_secret_access_key': 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY',
            'aws_session_token': 'FwoGZXIvYXdzEBYaDH...',
            'region': 'us-east-1'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['aws_access_key_id'] == '[REDACTED]'
        assert sanitized['aws_secret_access_key'] == '[REDACTED]'
        assert sanitized['aws_session_token'] == '[REDACTED]'
        assert sanitized['region'] == 'us-east-1'
    
    def test_nested_dict_redaction(self):
        """Test that nested dictionaries are sanitized."""
        data = {
            'user': {
                'username': 'john.doe',
                'password': 'secret123',
                'email': 'john.doe@example.com'
            },
            'config': {
                'api_key': 'sk_live_1234567890',
                'endpoint': 'https://api.example.com'
            }
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['user']['password'] == '[REDACTED]'
        assert sanitized['user']['username'] == 'john.doe'
        assert sanitized['config']['api_key'] == '[REDACTED]'
        assert sanitized['config']['endpoint'] == 'https://api.example.com'
    
    def test_list_of_dicts_redaction(self):
        """Test that lists of dictionaries are sanitized."""
        data = {
            'users': [
                {'username': 'user1', 'password': 'pass1'},
                {'username': 'user2', 'password': 'pass2'}
            ]
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['users'][0]['password'] == '[REDACTED]'
        assert sanitized['users'][1]['password'] == '[REDACTED]'
        assert sanitized['users'][0]['username'] == 'user1'
        assert sanitized['users'][1]['username'] == 'user2'
    
    def test_case_insensitive_redaction(self):
        """Test that redaction is case-insensitive."""
        data = {
            'Password': 'secret123',
            'API_KEY': 'key123',
            'Secret': 'value123'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['Password'] == '[REDACTED]'
        assert sanitized['API_KEY'] == '[REDACTED]'
        assert sanitized['Secret'] == '[REDACTED]'
    
    def test_aws_key_pattern_redaction(self):
        """Test that AWS access key patterns are redacted in strings."""
        text = "Using access key AKIAIOSFODNN7EXAMPLE for authentication"
        
        redacted = redact_patterns(text)
        
        assert 'AKIAIOSFODNN7EXAMPLE' not in redacted
        assert '[REDACTED_AWS_KEY]' in redacted
    
    def test_jwt_token_redaction(self):
        """Test that JWT tokens are redacted in strings."""
        # Using a fake JWT-like pattern for testing (not a real token)
        fake_jwt = "eyJTEST.eyJTEST.FAKE_SIGNATURE_FOR_TESTING_ONLY"
        text = f"Authorization: Bearer {fake_jwt}"
        
        redacted = redact_patterns(text)
        
        assert 'eyJTEST' not in redacted
        assert '[REDACTED_JWT]' in redacted
    
    def test_email_partial_redaction(self):
        """Test that email addresses are partially redacted."""
        text = "User email is john.doe@example.com"
        
        redacted = redact_patterns(text)
        
        assert 'john.doe' not in redacted
        assert '@example.com' in redacted
        assert '[REDACTED]@example.com' in redacted
    
    def test_database_password_redaction(self):
        """Test that database passwords are redacted."""
        data = {
            'db_password': 'dbpass123',
            'database_password': 'dbpass456',
            'connection_string': 'postgresql://user:pass@localhost:5432/db',
            'database_name': 'mydb'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['db_password'] == '[REDACTED]'
        assert sanitized['database_password'] == '[REDACTED]'
        assert sanitized['connection_string'] == '[REDACTED]'
        assert sanitized['database_name'] == 'mydb'
    
    def test_authorization_header_redaction(self):
        """Test that authorization headers are redacted."""
        data = {
            'headers': {
                'Authorization': 'Bearer token123',
                'Content-Type': 'application/json'
            }
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['headers']['Authorization'] == '[REDACTED]'
        assert sanitized['headers']['Content-Type'] == 'application/json'
    
    def test_non_sensitive_data_preserved(self):
        """Test that non-sensitive data is preserved."""
        data = {
            'instance_id': 'i-1234567890',
            'region': 'us-east-1',
            'account_id': '123456789012',
            'instance_type': 'db.t3.medium',
            'engine': 'postgres',
            'status': 'available'
        }
        
        sanitized = sanitize_log_data(data)
        
        # All fields should be preserved
        assert sanitized == data
    
    def test_empty_data(self):
        """Test that empty data is handled correctly."""
        data = {}
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized == {}
    
    def test_none_values(self):
        """Test that None values are handled correctly."""
        data = {
            'username': 'john.doe',
            'password': None,
            'email': 'john.doe@example.com'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['username'] == 'john.doe'
        assert sanitized['password'] == '[REDACTED]'  # Still redacted even if None
        assert sanitized['email'] != None
    
    def test_multiple_patterns_in_string(self):
        """Test that multiple sensitive patterns in a string are all redacted."""
        # Using fake patterns for testing (not real credentials)
        fake_jwt = "eyJTEST.eyJTEST.FAKE_SIG"
        text = f"Access key AKIAIOSFODNN7EXAMPLE and JWT {fake_jwt}"
        
        redacted = redact_patterns(text)
        
        assert 'AKIAIOSFODNN7EXAMPLE' not in redacted
        assert 'eyJTEST' not in redacted
        assert '[REDACTED_AWS_KEY]' in redacted
        assert '[REDACTED_JWT]' in redacted
    
    def test_bearer_token_redaction(self):
        """Test that bearer tokens are redacted."""
        data = {
            'bearer': 'token123',
            'bearer_token': 'token456',
            'instance_id': 'i-123'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['bearer'] == '[REDACTED]'
        assert sanitized['bearer_token'] == '[REDACTED]'
        assert sanitized['instance_id'] == 'i-123'
    
    def test_private_key_redaction(self):
        """Test that private keys are redacted."""
        data = {
            'private_key': '-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...',
            'public_key': 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC...'
        }
        
        sanitized = sanitize_log_data(data)
        
        assert sanitized['private_key'] == '[REDACTED]'
        # Public keys are not sensitive, but the key contains 'key' so might be redacted
        # depending on implementation


class TestRedactionPatterns:
    """Test suite for pattern-based redaction."""
    
    def test_aws_secret_key_pattern(self):
        """Test AWS secret key pattern redaction."""
        text = "Secret: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        
        redacted = redact_patterns(text)
        
        # 40-character base64-like strings should be redacted
        assert 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY' not in redacted
    
    def test_short_strings_not_redacted(self):
        """Test that short strings are not incorrectly redacted."""
        text = "Instance ID: i-1234567890"
        
        redacted = redact_patterns(text)
        
        # Short strings should not be redacted
        assert text == redacted
    
    def test_multiple_emails_redacted(self):
        """Test that multiple email addresses are redacted."""
        text = "Contact john.doe@example.com or jane.smith@example.org"
        
        redacted = redact_patterns(text)
        
        assert 'john.doe' not in redacted
        assert 'jane.smith' not in redacted
        assert '@example.com' in redacted
        assert '@example.org' in redacted


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
