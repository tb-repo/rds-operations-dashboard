# Cross-Account Setup Guide

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-11-12T17:00:00Z  
**Version:** 1.0.0  
**Policy Version:** v1.0.0  
**Traceability:** REQ-9.1, REQ-9.2, REQ-9.4 → DESIGN-001 → TASK-1.3

## Overview

This guide explains how to set up cross-account IAM roles to allow the RDS Dashboard (deployed in the management account) to access RDS instances and CloudWatch metrics in target accounts.

## Architecture

```
┌─────────────────────────────────────┐
│   Management Account                │
│   (RDS Dashboard Deployed Here)     │
│                                     │
│   ┌─────────────────────────────┐  │
│   │ Lambda Functions            │  │
│   │ Role: RDSDashboardLambdaRole│  │
│   └─────────────────────────────┘  │
│              │                      │
│              │ STS AssumeRole       │
│              │ (with External ID)   │
└──────────────┼──────────────────────┘
               │
               ├──────────────────────────────────┐
               │                                  │
               ▼                                  ▼
┌──────────────────────────────┐  ┌──────────────────────────────┐
│  Target Account 1 (Prod)     │  │  Target Account 2 (Dev)      │
│                              │  │                              │
│  ┌────────────────────────┐ │  │  ┌────────────────────────┐ │
│  │ Cross-Account Role     │ │  │  │ Cross-Account Role     │ │
│  │ RDSDashboardCrossAccount│ │  │  │ RDSDashboardCrossAccount│ │
│  │ Role                   │ │  │  │ Role                   │ │
│  └────────────────────────┘ │  │  └────────────────────────┘ │
│              │               │  │              │               │
│              ▼               │  │              ▼               │
│  ┌────────────────────────┐ │  │  ┌────────────────────────┐ │
│  │ RDS Instances          │ │  │  │ RDS Instances          │ │
│  │ CloudWatch Metrics     │ │  │  │ CloudWatch Metrics     │ │
│  └────────────────────────┘ │  │  └────────────────────────┘ │
└──────────────────────────────┘  └──────────────────────────────┘
```

## Prerequisites

- Management account ID where RDS Dashboard is deployed
- External ID (generated during dashboard deployment)
- AWS CLI or CloudFormation access in each target account
- Permissions to create IAM roles in target accounts

## Step 1: Get Required Information

After deploying the RDS Dashboard in the management account, retrieve:

```bash
# Get management account ID
aws sts get-caller-identity --query Account --output text

# Get external ID from CloudFormation outputs
aws cloudformation describe-stacks \
  --stack-name RDSDashboard-IAM-prod \
  --query 'Stacks[0].Outputs[?OutputKey==`ExternalId`].OutputValue' \
  --output text
```

**Example Output:**
- Management Account ID: `123456789012`
- External ID: `rds-dashboard-unique-id-12345`

## Step 2: Deploy Cross-Account Role (Option A: CloudFormation)

### 2.1 Download Template

The CloudFormation template is generated during infrastructure deployment:

```bash
# From management account
aws s3 cp s3://rds-dashboard-data-{account-id}-prod/templates/cross-account-role.yaml ./
```

Or use the template from the infrastructure deployment output.

### 2.2 Deploy in Target Account

```bash
# Switch to target account credentials
export AWS_PROFILE=target-account-prod

# Deploy CloudFormation stack
aws cloudformation create-stack \
  --stack-name RDSDashboard-CrossAccountRole \
  --template-body file://cross-account-role.yaml \
  --parameters \
    ParameterKey=ManagementAccountId,ParameterValue=123456789012 \
    ParameterKey=ExternalId,ParameterValue=rds-dashboard-unique-id-12345 \
  --capabilities CAPABILITY_NAMED_IAM \
  --region ap-southeast-1

# Wait for stack creation
aws cloudformation wait stack-create-complete \
  --stack-name RDSDashboard-CrossAccountRole \
  --region ap-southeast-1

# Get role ARN
aws cloudformation describe-stacks \
  --stack-name RDSDashboard-CrossAccountRole \
  --query 'Stacks[0].Outputs[?OutputKey==`RoleArn`].OutputValue' \
  --output text
```

## Step 3: Deploy Cross-Account Role (Option B: AWS Console)

### 3.1 Navigate to CloudFormation

1. Log in to target AWS account
2. Go to CloudFormation console
3. Click "Create stack" → "With new resources"

### 3.2 Upload Template

1. Select "Upload a template file"
2. Upload `cross-account-role.yaml`
3. Click "Next"

### 3.3 Configure Parameters

- **Stack name:** `RDSDashboard-CrossAccountRole`
- **ManagementAccountId:** `123456789012` (your management account)
- **ExternalId:** `rds-dashboard-unique-id-12345` (from Step 1)

### 3.4 Review and Create

1. Acknowledge IAM resource creation
2. Click "Create stack"
3. Wait for `CREATE_COMPLETE` status

## Step 4: Verify Role Creation

```bash
# In target account
aws iam get-role --role-name RDSDashboardCrossAccountRole

# Verify trust policy
aws iam get-role --role-name RDSDashboardCrossAccountRole \
  --query 'Role.AssumeRolePolicyDocument' \
  --output json
```

**Expected Trust Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/RDSDashboardLambdaRole-prod"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "rds-dashboard-unique-id-12345"
        }
      }
    }
  ]
}
```

## Step 5: Test Cross-Account Access

From the management account, test assuming the role:

```bash
# Switch back to management account
export AWS_PROFILE=management-account

# Assume role in target account
aws sts assume-role \
  --role-arn arn:aws:iam::TARGET_ACCOUNT_ID:role/RDSDashboardCrossAccountRole \
  --role-session-name test-session \
  --external-id rds-dashboard-unique-id-12345

# If successful, you'll receive temporary credentials
```

## Step 6: Update Dashboard Configuration

Add the target account to the dashboard configuration:

```bash
# Edit infrastructure/.env
TARGET_ACCOUNTS=["123456789012","TARGET_ACCOUNT_ID"]

# Redeploy Lambda functions with updated configuration
cd infrastructure
cdk deploy RDSDashboard-Compute-prod
```

## Step 7: Verify Discovery

After deployment, check CloudWatch Logs for the discovery Lambda:

```bash
aws logs tail /aws/lambda/rds-discovery-prod --follow
```

Look for log entries indicating successful discovery in the new account:

```json
{
  "timestamp": "2025-11-12T16:00:00Z",
  "level": "INFO",
  "service": "discovery",
  "account_id": "TARGET_ACCOUNT_ID",
  "region": "ap-southeast-1",
  "message": "Discovery completed",
  "instances_found": 12
}
```

## Permissions Summary

### RDS Read-Only Policy
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "rds:Describe*",
        "rds:ListTagsForResource"
      ],
      "Resource": "*"
    }
  ]
}
```

### CloudWatch Read-Only Policy
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:GetMetricData",
        "cloudwatch:ListMetrics"
      ],
      "Resource": "*"
    }
  ]
}
```

### RDS Write Policy (Non-Production Only)
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "rds:CreateDBSnapshot",
        "rds:RebootDBInstance",
        "rds:ModifyDBInstance"
      ],
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "aws:ResourceTag/Environment": "Production"
        }
      }
    }
  ]
}
```

## Security Best Practices

### 1. External ID
- **Purpose:** Prevents confused deputy problem
- **Requirement:** Must match exactly between management and target accounts
- **Storage:** Store securely (AWS Secrets Manager or Parameter Store)
- **Rotation:** Rotate annually or after security incidents

### 2. Least Privilege
- **Read-Only:** Discovery and monitoring use read-only permissions
- **Write Operations:** Limited to non-production instances only
- **Condition Keys:** Use resource tags to enforce environment restrictions

### 3. Monitoring
- **CloudTrail:** Enable in all accounts to track AssumeRole calls
- **CloudWatch Alarms:** Alert on unexpected AssumeRole failures
- **Regular Audits:** Review IAM Access Analyzer findings

### 4. Role Naming
- **Consistent Naming:** Use `RDSDashboardCrossAccountRole` in all accounts
- **Rationale:** Simplifies management and STS AssumeRole calls

## Troubleshooting

### Error: "User is not authorized to perform: sts:AssumeRole"

**Cause:** Trust policy not configured correctly

**Solution:**
1. Verify management account ID in trust policy
2. Verify external ID matches
3. Check Lambda execution role has `sts:AssumeRole` permission

### Error: "Access Denied" when querying RDS

**Cause:** Cross-account role missing RDS permissions

**Solution:**
1. Verify `RDSReadOnlyPolicy` is attached to role
2. Check for SCPs (Service Control Policies) blocking RDS access
3. Verify region is enabled in target account

### Error: "External ID mismatch"

**Cause:** External ID in trust policy doesn't match Lambda configuration

**Solution:**
1. Get external ID from management account CloudFormation outputs
2. Update target account role trust policy
3. Redeploy cross-account role stack

### Discovery Not Finding Instances

**Possible Causes:**
1. Cross-account role not deployed in target account
2. Target account ID not added to Lambda configuration
3. Region not included in discovery configuration
4. RDS instances have no tags (check tag-based filtering)

**Solution:**
1. Verify role exists: `aws iam get-role --role-name RDSDashboardCrossAccountRole`
2. Check Lambda environment variables for account list
3. Review CloudWatch Logs for error messages
4. Test AssumeRole manually (Step 5)

## Automation Script

For deploying to multiple accounts, use this script:

```bash
#!/bin/bash
# deploy-cross-account-roles.sh

MANAGEMENT_ACCOUNT_ID="123456789012"
EXTERNAL_ID="rds-dashboard-unique-id-12345"
TARGET_ACCOUNTS=("234567890123" "345678901234" "456789012345")

for ACCOUNT_ID in "${TARGET_ACCOUNTS[@]}"; do
  echo "Deploying to account: $ACCOUNT_ID"
  
  # Assume role in target account (requires pre-configured access)
  CREDENTIALS=$(aws sts assume-role \
    --role-arn "arn:aws:iam::${ACCOUNT_ID}:role/OrganizationAccountAccessRole" \
    --role-session-name deploy-rds-dashboard \
    --query 'Credentials' \
    --output json)
  
  export AWS_ACCESS_KEY_ID=$(echo $CREDENTIALS | jq -r '.AccessKeyId')
  export AWS_SECRET_ACCESS_KEY=$(echo $CREDENTIALS | jq -r '.SecretAccessKey')
  export AWS_SESSION_TOKEN=$(echo $CREDENTIALS | jq -r '.SessionToken')
  
  # Deploy CloudFormation stack
  aws cloudformation create-stack \
    --stack-name RDSDashboard-CrossAccountRole \
    --template-body file://cross-account-role.yaml \
    --parameters \
      ParameterKey=ManagementAccountId,ParameterValue=$MANAGEMENT_ACCOUNT_ID \
      ParameterKey=ExternalId,ParameterValue=$EXTERNAL_ID \
    --capabilities CAPABILITY_NAMED_IAM \
    --region ap-southeast-1
  
  echo "Stack creation initiated for account: $ACCOUNT_ID"
  
  # Clear credentials
  unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
done

echo "Deployment complete for all accounts"
```

## Maintenance

### Adding New Target Accounts
1. Deploy cross-account role in new account (Steps 2-4)
2. Update `TARGET_ACCOUNTS` in infrastructure/.env
3. Redeploy compute stack: `cdk deploy RDSDashboard-Compute-prod`

### Removing Target Accounts
1. Remove account ID from `TARGET_ACCOUNTS` configuration
2. Redeploy compute stack
3. Delete cross-account role stack in target account (optional)

### Updating Permissions
1. Modify cross-account role template
2. Update CloudFormation stack in all target accounts
3. No changes needed in management account

## Support

For issues or questions:
- Check CloudWatch Logs: `/aws/lambda/rds-discovery-prod`
- Review CloudTrail events for AssumeRole calls
- Contact DBA team or AWS support
