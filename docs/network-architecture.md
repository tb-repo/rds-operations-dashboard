# Network Architecture and Cross-Account Communication

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-11-12T17:30:00Z  
**Version:** 1.0.0  
**Policy Version:** v1.0.0

## Overview

The RDS Operations Dashboard uses **AWS IAM-based cross-account access**, which operates entirely through AWS service APIs. This means **no network connectivity is required between VPCs or environments**.

## Communication Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ Management Account (ap-southeast-1)                         │
│                                                             │
│  ┌──────────────────────────────────────┐                 │
│  │ Lambda Function                      │                 │
│  │ (No VPC attachment)                  │                 │
│  └──────────────┬───────────────────────┘                 │
│                 │                                           │
│                 │ HTTPS (AWS Service APIs)                 │
│                 │                                           │
└─────────────────┼───────────────────────────────────────────┘
                  │
                  │ AWS Control Plane (IAM/STS)
                  │ No VPC-to-VPC traffic
                  │
        ┌─────────┴─────────┬─────────────────┐
        │                   │                 │
        ▼                   ▼                 ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ Dev Account   │   │ UAT Account   │   │ Prod Account  │
│               │   │               │   │               │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │ IAM Role  │ │   │ │ IAM Role  │ │   │ │ IAM Role  │ │
│ │ (Trust)   │ │   │ │ (Trust)   │ │   │ │ (Trust)   │ │
│ └─────┬─────┘ │   │ └─────┬─────┘ │   │ └─────┬─────┘ │
│       │       │   │       │       │   │       │       │
│       ▼       │   │       ▼       │   │       ▼       │
│ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │
│ │ RDS API   │ │   │ │ RDS API   │ │   │ │ RDS API   │ │
│ │ CW API    │ │   │ │ CW API    │ │   │ │ CW API    │ │
│ └───────────┘ │   │ └───────────┘ │   │ └───────────┘ │
└───────────────┘   └───────────────┘   └───────────────┘
```

## How It Works

### Step 1: Lambda Invocation
```
Lambda function starts in Management Account
No VPC attachment required
```

### Step 2: Role Assumption (STS)
```python
# Lambda calls AWS STS API (HTTPS)
sts_client = boto3.client('sts')
response = sts_client.assume_role(
    RoleArn='arn:aws:iam::TARGET_ACCOUNT:role/RDSDashboardCrossAccountRole',
    RoleSessionName='rds-dashboard-session',
    ExternalId='rds-dashboard-unique-id-12345'
)

# STS returns temporary credentials
# No network traffic between accounts
```

### Step 3: API Calls with Assumed Role
```python
# Lambda uses temporary credentials to call RDS API
rds_client = boto3.client(
    'rds',
    aws_access_key_id=credentials['AccessKeyId'],
    aws_secret_access_key=credentials['SecretAccessKey'],
    aws_session_token=credentials['SessionToken']
)

# API call goes through AWS service endpoints
# No direct connection to target account VPC
instances = rds_client.describe_db_instances()
```

## Network Requirements

### ✅ Required
- **Internet Gateway or NAT Gateway**: If Lambda is in a VPC (optional)
- **AWS Service Endpoints**: Access to AWS public endpoints or VPC endpoints
- **HTTPS (443)**: Outbound to AWS service endpoints

### ❌ NOT Required
- VPC peering between accounts
- Transit Gateway connections
- VPN connections between environments
- Direct Connect between accounts
- Security group rules allowing cross-account traffic
- Network ACLs allowing cross-environment traffic
- Firewall rules between Dev/Prod networks

## Lambda Deployment Options

### Option 1: No VPC (Recommended)
```
Lambda → AWS Public Endpoints → Target Account APIs
```

**Advantages:**
- No network configuration needed
- No NAT Gateway costs
- Faster cold starts
- Simpler architecture

**Use Case:** Perfect for this dashboard (no VPC resources accessed)

### Option 2: VPC with NAT Gateway
```
Lambda (VPC) → NAT Gateway → Internet Gateway → AWS Endpoints
```

**Advantages:**
- Can access VPC resources if needed
- More control over network routing

**Disadvantages:**
- NAT Gateway costs (~$32/month)
- Slower cold starts
- More complex configuration

**Use Case:** Only if Lambda needs to access VPC resources (not needed here)

### Option 3: VPC with VPC Endpoints (PrivateLink)
```
Lambda (VPC) → VPC Endpoints → AWS Services
```

**Advantages:**
- Private connectivity to AWS services
- No Internet Gateway needed
- Better security posture

**Disadvantages:**
- VPC Endpoint costs (~$7/month per endpoint)
- More complex configuration

**Use Case:** High-security environments requiring private connectivity

## Recommended Configuration

For the RDS Dashboard, we recommend **Option 1: No VPC attachment**.

### Why?
1. **No VPC Resources**: Lambda doesn't need to access RDS instances directly (only APIs)
2. **Cost Optimization**: Saves $32/month on NAT Gateway
3. **Simplicity**: No network configuration required
4. **Performance**: Faster cold starts
5. **Cross-Account Works**: IAM-based access works regardless of VPC configuration

## Network Isolation Between Environments

Your network isolation between Dev/Stage/SIT and UAT/Prod is **completely independent** of this solution.

### What's Isolated (Your Network Rules)
```
Dev VPC ─┐
Stage VPC├─ Network Firewall ─X─ UAT VPC
SIT VPC ─┘                        Prod VPC
```

### What's Not Affected (AWS APIs)
```
Management Account Lambda
    │
    ├─> AWS STS API (Global)
    │
    ├─> Dev Account RDS API ✓
    ├─> Stage Account RDS API ✓
    ├─> UAT Account RDS API ✓
    └─> Prod Account RDS API ✓
```

## Security Considerations

### IAM-Based Security
- **Trust Policy**: Only Management Account Lambda role can assume cross-account roles
- **External ID**: Prevents confused deputy attacks
- **Least Privilege**: Cross-account roles have minimal permissions
- **Conditional Access**: Write operations restricted to non-prod (via resource tags)

### Network Security (Not Applicable)
- Security groups: Not relevant (no VPC-to-VPC traffic)
- NACLs: Not relevant (no subnet-to-subnet traffic)
- Firewall rules: Not relevant (no inter-environment traffic)

## Firewall Considerations

If your organization has **egress firewalls** on Lambda execution, you may need to allow:

### Required Endpoints (HTTPS/443)
```
# STS (for role assumption)
sts.amazonaws.com
sts.ap-southeast-1.amazonaws.com

# RDS (for instance discovery)
rds.amazonaws.com
rds.*.amazonaws.com  # All regions

# CloudWatch (for metrics)
monitoring.amazonaws.com
monitoring.*.amazonaws.com  # All regions

# DynamoDB (for data storage)
dynamodb.ap-southeast-1.amazonaws.com

# S3 (for reports)
s3.ap-southeast-1.amazonaws.com

# SNS (for alerts)
sns.ap-southeast-1.amazonaws.com
```

### VPC Endpoint Alternative
If egress is restricted, use VPC endpoints:
- `com.amazonaws.ap-southeast-1.sts`
- `com.amazonaws.ap-southeast-1.rds`
- `com.amazonaws.ap-southeast-1.monitoring`
- `com.amazonaws.ap-southeast-1.dynamodb`
- `com.amazonaws.ap-southeast-1.s3`
- `com.amazonaws.ap-southeast-1.sns`

## Common Misconceptions

### ❌ Myth: "Cross-account access requires VPC peering"
**Reality:** IAM role assumption works through AWS APIs, no VPC peering needed.

### ❌ Myth: "Lambda needs to be in the same VPC as RDS"
**Reality:** Lambda only calls RDS APIs (DescribeDBInstances), not database connections.

### ❌ Myth: "Network isolation breaks cross-account access"
**Reality:** Network isolation is at the VPC level; IAM operates at the control plane level.

### ❌ Myth: "Firewall rules between environments affect this"
**Reality:** Firewall rules control VPC-to-VPC traffic; this solution uses AWS service APIs.

## Testing Cross-Account Access

### Test from Management Account
```bash
# Assume role in target account
aws sts assume-role \
  --role-arn arn:aws:iam::TARGET_ACCOUNT:role/RDSDashboardCrossAccountRole \
  --role-session-name test-session \
  --external-id rds-dashboard-unique-id-12345

# If successful, you'll get temporary credentials
# This proves cross-account access works regardless of network isolation
```

### Test RDS API Access
```bash
# Export temporary credentials from assume-role output
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=...

# List RDS instances in target account
aws rds describe-db-instances --region ap-southeast-1

# This works even if VPCs are completely isolated
```

## Troubleshooting

### Issue: "Access Denied" when assuming role
**Cause:** IAM trust policy or permissions issue, NOT network issue

**Solution:**
1. Verify trust policy in target account role
2. Verify external ID matches
3. Check Lambda execution role has `sts:AssumeRole` permission

### Issue: "Network timeout" when calling AWS APIs
**Cause:** Lambda can't reach AWS service endpoints

**Solution:**
1. If Lambda is in VPC: Add NAT Gateway or VPC endpoints
2. If Lambda is not in VPC: Check AWS service health
3. Check egress firewall rules (if applicable)

### Issue: "Cannot connect to RDS instance"
**Cause:** Misunderstanding - Lambda doesn't connect to RDS instances directly

**Clarification:** Lambda only calls RDS APIs (DescribeDBInstances, etc.), not database connections

## Internet vs Private Network Communication

### Default Configuration (Internet-Based)

**Backend Communication:**
```
Lambda → AWS Public Endpoints (HTTPS over Internet)
  ├─> sts.amazonaws.com
  ├─> rds.amazonaws.com
  ├─> monitoring.amazonaws.com
  ├─> dynamodb.ap-southeast-1.amazonaws.com
  ├─> s3.ap-southeast-1.amazonaws.com
  └─> sns.ap-southeast-1.amazonaws.com
```

**Frontend Communication:**
```
User Browser → CloudFront (Internet) → API Gateway → Lambda
```

**Important Notes:**
- Traffic uses AWS public endpoints (internet-routable)
- All data stays within AWS infrastructure (AWS global network)
- HTTPS encryption (TLS 1.2+) for all communication
- No data traverses public internet providers

### Private Network Configuration (VPC Endpoints)

If your organization requires fully private communication:

**Backend Communication:**
```
Lambda (VPC) → VPC Endpoints (PrivateLink) → AWS Services
  ├─> vpce-xxx (STS)
  ├─> vpce-xxx (RDS)
  ├─> vpce-xxx (CloudWatch)
  ├─> vpce-xxx (DynamoDB)
  ├─> vpce-xxx (S3)
  └─> vpce-xxx (SNS)
```

**Frontend Communication Options:**

**Option A: CloudFront with IP Whitelist**
```
Corporate Users (Whitelisted IPs) → CloudFront → API Gateway
```

**Option B: Internal ALB via VPN/Direct Connect**
```
Corporate Users → VPN/Direct Connect → VPC → Internal ALB → API Gateway
```

### Decision Matrix

| Requirement | Recommended Configuration | Monthly Cost |
|-------------|--------------------------|--------------|
| **Cost-optimized, AWS-only traffic** | Default (No VPC, Public Endpoints) | $17 |
| **Private AWS service communication** | Lambda in VPC + VPC Endpoints | $59 |
| **Internal-only dashboard access** | CloudFront + IP Whitelist | $17 |
| **Fully private (no internet routing)** | VPC Endpoints + Internal ALB + VPN | $110+ |
| **Compliance: Private connectivity** | VPC Endpoints + Private API Gateway | $75 |

### Configuration Comparison

| Aspect | Internet (Default) | Private (VPC Endpoints) |
|--------|-------------------|------------------------|
| **Lambda Deployment** | No VPC | VPC with private subnets |
| **AWS Service Access** | Public endpoints | VPC endpoints (PrivateLink) |
| **Data Path** | AWS global network | AWS private network |
| **Internet Routing** | Yes (AWS backbone) | No |
| **Setup Complexity** | Low | Medium |
| **Monthly Cost** | $17 | $59 |
| **Cold Start Time** | Fast (~1s) | Slower (~2-3s) |
| **Security Posture** | Good (HTTPS, IAM) | Better (Private, no internet) |

### Recommended Configuration by Use Case

#### Use Case 1: Standard Deployment (Most Organizations)
**Configuration:** Default (No VPC, Public Endpoints)

**Rationale:**
- Cost-effective ($17/month)
- Simple to deploy and maintain
- All traffic encrypted (HTTPS)
- Data stays within AWS infrastructure
- Meets most security requirements

**When to Use:**
- Standard AWS deployments
- Cost is a priority
- No strict private network requirements
- Trust AWS's network security

#### Use Case 2: High-Security / Compliance Requirements
**Configuration:** VPC Endpoints + Private API Gateway

**Rationale:**
- Fully private communication
- No internet routing
- Meets compliance requirements (PCI-DSS, HIPAA, etc.)
- Better audit trail

**When to Use:**
- Regulatory compliance requires private connectivity
- Organization policy prohibits internet routing
- Handling sensitive data
- Security is top priority

#### Use Case 3: Internal-Only Access
**Configuration:** Default Backend + CloudFront IP Whitelist

**Rationale:**
- Cost-effective backend
- Restricted frontend access
- Simple to implement

**When to Use:**
- Dashboard should only be accessible from corporate network
- Backend can use AWS public endpoints
- Want to minimize costs

### Implementation Guide for Private Configuration

If you need fully private communication, here's what to change:

#### 1. Update Lambda Configuration (data-stack.ts)

```typescript
// Add VPC configuration
const vpc = new ec2.Vpc(this, 'DashboardVpc', {
  maxAzs: 2,
  natGateways: 0, // No NAT Gateway needed with VPC endpoints
});

// Create VPC endpoints
const vpcEndpoints = [
  'sts', 'rds', 'monitoring', 'dynamodb', 's3', 'sns', 'logs'
].map(service => 
  vpc.addInterfaceEndpoint(`${service}Endpoint`, {
    service: ec2.InterfaceVpcEndpointAwsService[service.toUpperCase()],
  })
);
```

#### 2. Update Lambda Deployment

```typescript
const lambdaFunction = new lambda.Function(this, 'Function', {
  // ... other config
  vpc: vpc,
  vpcSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});
```

#### 3. Cost Impact

**Additional Monthly Costs:**
- VPC Endpoints (7 endpoints × $7): $49/month
- Data processing: ~$0.50/month
- **Total increase:** ~$50/month
- **New total:** ~$67/month

### Data Security Considerations

**Both configurations are secure:**

| Security Aspect | Internet (Default) | Private (VPC Endpoints) |
|----------------|-------------------|------------------------|
| **Encryption** | ✅ TLS 1.2+ | ✅ TLS 1.2+ |
| **Authentication** | ✅ IAM | ✅ IAM |
| **Data in Transit** | ✅ Encrypted | ✅ Encrypted |
| **Network Isolation** | ⚠️ Uses internet routing | ✅ Fully private |
| **Audit Trail** | ✅ CloudTrail | ✅ CloudTrail + VPC Flow Logs |
| **Compliance** | ✅ Most standards | ✅ All standards |

**Key Point:** The default configuration is secure for most use cases. Private configuration adds defense-in-depth but at higher cost and complexity.

## Summary

✅ **Cross-account access works regardless of network isolation**  
✅ **No VPC peering or network connectivity required**  
✅ **IAM-based security, not network-based**  
✅ **Dev/Prod network isolation does not affect this solution**  

### Communication Type

**Default Configuration:**
- ⚠️ **Internet-based** (AWS public endpoints)
- ✅ Data stays within AWS infrastructure
- ✅ HTTPS encrypted
- ✅ Cost-effective ($17/month)

**Private Configuration (Optional):**
- ✅ **Fully private** (VPC endpoints)
- ✅ No internet routing
- ✅ Better compliance posture
- ⚠️ Higher cost ($67/month)

**Recommendation:** Start with default configuration. Migrate to private configuration only if required by compliance or security policy.

Your network traffic restrictions between lower and upper environments are completely compatible with both configurations.
