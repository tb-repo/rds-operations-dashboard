# Deployment Guide

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-11-12T17:00:00Z  
**Version:** 1.0.0  
**Policy Version:** v1.0.0  
**Traceability:** TASK-1 → Infrastructure Setup

## Prerequisites

Before deploying the RDS Operations Dashboard, ensure you have:

### Required Tools
- **AWS CLI** v2.x or later
- **Node.js** v18.x or later
- **npm** v9.x or later
- **Python** 3.11 or later
- **pip** (Python package manager)
- **AWS CDK CLI** v2.110.0 or later

### AWS Permissions
- Administrator access to management account (for initial deployment)
- Permissions to create:
  - IAM roles and policies
  - DynamoDB tables
  - S3 buckets
  - Lambda functions
  - API Gateway
  - CloudWatch resources
  - EventBridge rules

### Installation

```bash
# Install AWS CDK CLI globally
npm install -g aws-cdk@2.110.0

# Verify installation
cdk --version
aws --version
python --version
node --version
```

## Step 1: Clone and Setup Project

```bash
# Navigate to project directory
cd rds-operations-dashboard

# Install infrastructure dependencies
cd infrastructure
npm install

# Install Lambda dependencies
cd ../lambda
pip install -r requirements.txt

# Return to root
cd ..
```

## Step 2: Configure Environment

```bash
# Copy environment template
cd infrastructure
cp .env.example .env

# Edit configuration
nano .env  # or use your preferred editor
```

### Required Configuration

Update `.env` with your values:

```bash
# Your AWS account ID
AWS_ACCOUNT_ID=123456789012

# Primary region (Singapore recommended)
AWS_REGION=ap-southeast-1

# Environment name
ENVIRONMENT=prod

# Generate a unique external ID (use uuidgen or similar)
EXTERNAL_ID=rds-dashboard-$(uuidgen | tr '[:upper:]' '[:lower:]')

# Target accounts to monitor (JSON array)
TARGET_ACCOUNTS=["123456789012","234567890123"]

# Regions to scan (JSON array)
TARGET_REGIONS=["ap-southeast-1","eu-west-2","ap-south-1","us-east-1"]

# Email for alerts
SNS_EMAIL=dba-team@company.com
```

## Step 3: Deploy Data Stack (DynamoDB + S3)

Deploy the data layer first to create DynamoDB tables and S3 bucket:

```bash
cd infrastructure

# Bootstrap CDK (first time only)
cdk bootstrap aws://123456789012/ap-southeast-1

# Deploy data stack
cdk deploy DataStack --context environment=prod
```

This creates:
- DynamoDB tables: `rds_inventory`, `metrics_cache`, `health_alerts`, `audit_log`
- S3 bucket: `rds-dashboard-data-{account-id}-prod`
- Lifecycle policies and encryption

**Expected Output:**
```
✅  DataStack

Outputs:
DataStack.RdsInventoryTableName = rds-inventory-prod
DataStack.MetricsCacheTableName = metrics-cache-prod
DataStack.HealthAlertsTableName = health-alerts-prod
DataStack.AuditLogTableName = audit-log-prod
DataStack.DataBucketName = rds-dashboard-data-123456789012-prod
```

## Step 4: Initialize S3 Bucket Structure

After the S3 bucket is created, initialize the folder structure and upload CloudOps templates:

### Option A: Python Script (Recommended)

```bash
cd ../scripts
python setup-s3-structure.py --bucket-name rds-dashboard-data-123456789012-prod
```

### Option B: PowerShell Script (Windows)

```powershell
cd ..\scripts
.\setup-s3-structure.ps1 -BucketName "rds-dashboard-data-123456789012-prod"
```

**What this does:**
- Creates folder structure: `historical-metrics/`, `compliance-reports/`, `cost-reports/`, `cloudops-requests/`, `templates/`
- Uploads 3 CloudOps request templates
- Verifies bucket configuration

**See:** [S3 Setup Guide](./s3-setup-guide.md) for detailed instructions and troubleshooting

## Step 3: Bootstrap CDK (First Time Only)

```bash
# Bootstrap CDK in your account and region
cdk bootstrap aws://123456789012/ap-southeast-1

# If deploying to multiple regions, bootstrap each
cdk bootstrap aws://123456789012/eu-west-2
cdk bootstrap aws://123456789012/ap-south-1
cdk bootstrap aws://123456789012/us-east-1
```

## Step 4: Review Infrastructure

```bash
# Synthesize CloudFormation templates
cdk synth

# Review what will be created
cdk diff
```

## Step 5: Deploy Infrastructure

### Option A: Deploy All Stacks

```bash
# Deploy all stacks at once
cdk deploy --all --require-approval never

# Or with approval prompts
cdk deploy --all
```

### Option B: Deploy Stacks Individually

```bash
# Deploy data stack (DynamoDB + S3)
cdk deploy RDSDashboard-Data-prod

# Deploy IAM stack (roles and policies)
cdk deploy RDSDashboard-IAM-prod
```

### Deployment Output

After successful deployment, you'll see outputs like:

```
✅  RDSDashboard-Data-prod

Outputs:
RDSDashboard-Data-prod.RdsInventoryTableName = rds-inventory-prod
RDSDashboard-Data-prod.MetricsCacheTableName = metrics-cache-prod
RDSDashboard-Data-prod.HealthAlertsTableName = health-alerts-prod
RDSDashboard-Data-prod.AuditLogTableName = audit-log-prod
RDSDashboard-Data-prod.DataBucketName = rds-dashboard-data-123456789012-prod

✅  RDSDashboard-IAM-prod

Outputs:
RDSDashboard-IAM-prod.LambdaExecutionRoleArn = arn:aws:iam::123456789012:role/RDSDashboardLambdaRole-prod
RDSDashboard-IAM-prod.ExternalId = rds-dashboard-unique-id-12345
```

**Save these outputs** - you'll need them for cross-account setup and Lambda configuration.

## Step 6: Set Up Cross-Account Roles

Follow the [Cross-Account Setup Guide](cross-account-setup.md) to deploy roles in target accounts.

Quick summary:

```bash
# For each target account, deploy the cross-account role
aws cloudformation create-stack \
  --stack-name RDSDashboard-CrossAccountRole \
  --template-body file://cross-account-role.yaml \
  --parameters \
    ParameterKey=ManagementAccountId,ParameterValue=123456789012 \
    ParameterKey=ExternalId,ParameterValue=rds-dashboard-unique-id-12345 \
  --capabilities CAPABILITY_NAMED_IAM \
  --region ap-southeast-1 \
  --profile target-account-prod
```

## Step 7: Verify Deployment

### Check DynamoDB Tables

```bash
# List tables
aws dynamodb list-tables --region ap-southeast-1

# Describe inventory table
aws dynamodb describe-table \
  --table-name rds-inventory-prod \
  --region ap-southeast-1
```

### Check S3 Bucket

```bash
# List buckets
aws s3 ls | grep rds-dashboard

# Check bucket structure
aws s3 ls s3://rds-dashboard-data-123456789012-prod/ --recursive
```

### Check IAM Roles

```bash
# Get Lambda execution role
aws iam get-role --role-name RDSDashboardLambdaRole-prod

# List attached policies
aws iam list-attached-role-policies --role-name RDSDashboardLambdaRole-prod
```

## Step 8: Deploy Lambda Functions (Next Phase)

Lambda functions will be deployed in Task 2 (RDS Discovery Service).

## Troubleshooting

### Error: "Unable to resolve AWS account"

**Cause:** AWS credentials not configured

**Solution:**
```bash
# Configure AWS CLI
aws configure

# Or use environment variables
export AWS_ACCESS_KEY_ID=your-access-key
export AWS_SECRET_ACCESS_KEY=your-secret-key
export AWS_DEFAULT_REGION=ap-southeast-1
```

### Error: "Stack already exists"

**Cause:** Previous deployment exists

**Solution:**
```bash
# Update existing stack
cdk deploy --all

# Or destroy and redeploy
cdk destroy --all
cdk deploy --all
```

### Error: "Insufficient permissions"

**Cause:** IAM user/role lacks required permissions

**Solution:**
- Ensure you have AdministratorAccess or equivalent
- Check IAM policies for required permissions
- Contact AWS administrator

### Error: "CDK bootstrap required"

**Cause:** CDK not bootstrapped in account/region

**Solution:**
```bash
cdk bootstrap aws://ACCOUNT_ID/REGION
```

### Error: "Resource limit exceeded"

**Cause:** AWS service limits reached (e.g., DynamoDB tables, S3 buckets)

**Solution:**
- Check AWS service quotas in console
- Request limit increase if needed
- Clean up unused resources

## Cost Estimation

After deployment, estimated monthly costs:

| Resource | Estimated Cost |
|----------|---------------|
| DynamoDB (4 tables, on-demand) | $4.00 |
| S3 (5 GB storage) | $0.12 |
| Lambda (not yet deployed) | $3.50 |
| CloudWatch Logs | $1.00 |
| **Total (infrastructure only)** | **$8.62** |

Full system cost (with Lambda functions): ~$17/month

## Next Steps

1. ✅ Infrastructure deployed
2. ⏭️ Deploy Lambda functions (Task 2: RDS Discovery Service)
3. ⏭️ Deploy API Gateway (Task 8)
4. ⏭️ Deploy frontend dashboard (Task 10)
5. ⏭️ Configure monitoring and alerts (Task 11)

## Rollback

If you need to rollback the deployment:

```bash
# Destroy all stacks
cdk destroy --all

# Confirm deletion
# Type 'y' when prompted
```

**Warning:** This will delete all resources including DynamoDB tables and S3 buckets. Data will be lost unless you have backups.

## Production Checklist

Before going to production:

- [ ] External ID is unique and stored securely
- [ ] SNS email subscription confirmed
- [ ] Cross-account roles deployed in all target accounts
- [ ] IAM policies reviewed for least-privilege
- [ ] CloudWatch Logs retention configured (7 days)
- [ ] S3 lifecycle policies verified
- [ ] DynamoDB tables have appropriate capacity mode
- [ ] Backup strategy defined (if needed)
- [ ] Monitoring and alerting configured
- [ ] Documentation updated with account-specific details

## Support

For issues or questions:
- Check CloudFormation events in AWS Console
- Review CDK logs: `cdk deploy --verbose`
- Contact DBA team or AWS support
