# IAM Permissions Audit Report

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-12-03T00:00:00Z  
**Version:** 1.0.0  
**Policy Version:** v1.0.0  
**Traceability:** REQ-6.3 → DESIGN-6.3 → TASK-9.2  
**Review Status:** Pending  
**Risk Level:** Level 2

## Executive Summary

This document audits the IAM permissions for the RDS Operations Dashboard Lambda functions and provides recommendations for implementing least-privilege access.

## Current IAM Configuration

### Lambda Execution Role: `RDSDashboardLambdaRole`

#### Managed Policies
- `AWSLambdaBasicExecutionRole` - CloudWatch Logs access ✅ **APPROPRIATE**

#### Custom Policies

##### 1. DynamoDB Policy (`RDSDashboard-DynamoDB`)
**Current Permissions:**
```
dynamodb:PutItem
dynamodb:GetItem
dynamodb:Query
dynamodb:Scan
dynamodb:UpdateItem
dynamodb:DeleteItem
dynamodb:BatchWriteItem
dynamodb:BatchGetItem
```

**Resources:**
- RDS Inventory Table + GSIs
- Metrics Cache Table
- Health Alerts Table + GSIs
- Audit Log Table + GSIs
- Approvals Table + GSIs

**Assessment:** ✅ **APPROPRIATE** - Scoped to specific tables
**Recommendation:** Consider separating read-only vs read-write permissions per Lambda function

##### 2. S3 Policy (`RDSDashboard-S3`)
**Current Permissions:**
```
s3:PutObject
s3:GetObject
s3:DeleteObject
s3:ListBucket
```

**Resources:**
- Data Bucket + all objects

**Assessment:** ⚠️ **NEEDS REFINEMENT**
**Issues:**
- `s3:DeleteObject` may not be needed by all functions
- No prefix-based restrictions

**Recommendations:**
1. Restrict CloudOps templates to `cloudops-templates/*` prefix
2. Restrict cost reports to `cost-reports/*` prefix
3. Remove `s3:DeleteObject` unless specifically needed
4. Add `s3:GetBucketLocation` for better error handling

##### 3. SNS Policy (`RDSDashboard-SNS`)
**Current Permissions:**
```
sns:Publish
```

**Resources:**
- `arn:aws:sns:${region}:${account}:rds-dashboard-alerts`

**Assessment:** ✅ **APPROPRIATE** - Scoped to specific topic

##### 4. STS Policy (`RDSDashboard-STS`)
**Current Permissions:**
```
sts:AssumeRole
```

**Resources:**
- `arn:aws:iam::*:role/RDSDashboardCrossAccountRole`

**Assessment:** ⚠️ **NEEDS REFINEMENT**
**Issues:**
- Allows assuming role in ANY account (wildcard)

**Recommendations:**
1. Replace wildcard with explicit list of target account IDs
2. Add condition for external ID validation
3. Consider using AWS Organizations condition keys

##### 5. CloudWatch Policy (`RDSDashboard-CloudWatch`)
**Current Permissions:**
```
cloudwatch:PutMetricData
```

**Resources:** `*` (with namespace condition)

**Assessment:** ✅ **APPROPRIATE** - Namespace-scoped

##### 6. RDS Policy (`RDSDashboard-RDS`)
**Current Permissions:**
```
rds:DescribeDBInstances
rds:DescribeDBClusters
rds:ListTagsForResource
rds:DescribeDBSnapshots
rds:DescribeDBClusterSnapshots
```

**Resources:** `*`

**Assessment:** ✅ **APPROPRIATE** - Read-only discovery operations

##### 7. RDS Operations Policy (`RDSDashboard-RDS-Operations`)
**Current Permissions:**
```
rds:CreateDBSnapshot
rds:CreateDBClusterSnapshot
rds:DescribeDBSnapshots
rds:DescribeDBClusterSnapshots
rds:RebootDBInstance
rds:ModifyDBInstance
rds:ModifyDBCluster
rds:StartDBInstance
rds:StopDBInstance
rds:StartDBCluster
rds:StopDBCluster
```

**Resources:** `*`

**Assessment:** ⚠️ **HIGH RISK - NEEDS IMMEDIATE REFINEMENT**
**Issues:**
- Write operations on ALL RDS instances
- No resource-level restrictions
- No condition-based restrictions
- Application logic is the only safeguard

**Recommendations:**
1. **CRITICAL:** Add resource tag conditions to prevent production modifications
2. Add explicit deny for production environment tag
3. Consider separate roles for read-only vs operations
4. Implement approval workflow before granting write permissions
5. Add CloudTrail monitoring for all write operations

## Cross-Account Role Configuration

### Role: `RDSDashboardCrossAccountRole`

#### Trust Policy
**Current:**
```json
{
  "Principal": {
    "AWS": "arn:aws:iam::${ManagementAccountId}:role/RDSDashboardLambdaRole-prod"
  },
  "Condition": {
    "StringEquals": {
      "sts:ExternalId": "${ExternalId}"
    }
  }
}
```

**Assessment:** ✅ **APPROPRIATE** - Uses external ID for security

#### Policies

##### RDS Read-Only Policy
**Permissions:** `rds:Describe*`, `rds:ListTagsForResource`
**Assessment:** ✅ **APPROPRIATE**

##### CloudWatch Read-Only Policy
**Permissions:** `cloudwatch:GetMetricStatistics`, `cloudwatch:GetMetricData`, `cloudwatch:ListMetrics`
**Assessment:** ✅ **APPROPRIATE**

##### RDS Write Non-Prod Policy
**Permissions:** `rds:CreateDBSnapshot`, `rds:RebootDBInstance`, `rds:ModifyDBInstance`
**Condition:** `aws:ResourceTag/Environment != Production`

**Assessment:** ✅ **GOOD** - Tag-based protection
**Recommendation:** Add additional safeguards:
- Require approval workflow
- Add time-based restrictions (business hours only)
- Add notification on all write operations

## Recommended Changes

### Priority 1: Critical Security Issues

#### 1. Restrict RDS Operations Policy
```typescript
const rdsOperationsPolicy = new iam.Policy(this, 'RdsOperationsPolicy', {
  policyName: 'RDSDashboard-RDS-Operations',
  statements: [
    // Explicit DENY for production instances
    new iam.PolicyStatement({
      effect: iam.Effect.DENY,
      actions: [
        'rds:CreateDBSnapshot',
        'rds:RebootDBInstance',
        'rds:ModifyDBInstance',
        'rds:ModifyDBCluster',
        'rds:StartDBInstance',
        'rds:StopDBInstance',
        'rds:StartDBCluster',
        'rds:StopDBCluster',
      ],
      resources: ['*'],
      conditions: {
        StringEquals: {
          'aws:ResourceTag/Environment': ['Production', 'Prod', 'PROD'],
        },
      },
    }),
    // Allow operations on non-production instances
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: [
        'rds:CreateDBSnapshot',
        'rds:CreateDBClusterSnapshot',
        'rds:RebootDBInstance',
        'rds:ModifyDBInstance',
        'rds:ModifyDBCluster',
        'rds:StartDBInstance',
        'rds:StopDBInstance',
        'rds:StartDBCluster',
        'rds:StopDBCluster',
      ],
      resources: ['*'],
      conditions: {
        StringNotEquals: {
          'aws:ResourceTag/Environment': ['Production', 'Prod', 'PROD'],
        },
      },
    }),
    // Read-only operations (no restrictions)
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: [
        'rds:DescribeDBSnapshots',
        'rds:DescribeDBClusterSnapshots',
      ],
      resources: ['*'],
    }),
  ],
});
```

#### 2. Restrict STS AssumeRole to Specific Accounts
```typescript
const stsPolicy = new iam.Policy(this, 'StsPolicy', {
  policyName: 'RDSDashboard-STS',
  statements: [
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['sts:AssumeRole'],
      resources: [
        // Replace with actual target account IDs
        'arn:aws:iam::111111111111:role/RDSDashboardCrossAccountRole',
        'arn:aws:iam::222222222222:role/RDSDashboardCrossAccountRole',
        'arn:aws:iam::333333333333:role/RDSDashboardCrossAccountRole',
      ],
      conditions: {
        StringEquals: {
          'sts:ExternalId': externalId,
        },
      },
    }),
  ],
});
```

### Priority 2: Enhanced Security

#### 3. Refine S3 Policy with Prefix Restrictions
```typescript
const s3Policy = new iam.Policy(this, 'S3Policy', {
  policyName: 'RDSDashboard-S3',
  statements: [
    // Read access to entire bucket
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['s3:GetObject', 's3:ListBucket', 's3:GetBucketLocation'],
      resources: [
        dataBucket.bucketArn,
        `${dataBucket.bucketArn}/*`,
      ],
    }),
    // Write access restricted to specific prefixes
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['s3:PutObject'],
      resources: [
        `${dataBucket.bucketArn}/cloudops-templates/*`,
        `${dataBucket.bucketArn}/cost-reports/*`,
        `${dataBucket.bucketArn}/compliance-reports/*`,
        `${dataBucket.bucketArn}/audit-logs/*`,
      ],
    }),
    // Delete access only for temporary files
    new iam.PolicyStatement({
      effect: iam.Effect.ALLOW,
      actions: ['s3:DeleteObject'],
      resources: [
        `${dataBucket.bucketArn}/temp/*`,
      ],
    }),
  ],
});
```

### Priority 3: Function-Specific Roles

#### 4. Consider Separate Roles per Lambda Function
Instead of one role for all Lambda functions, create specific roles:

- **Discovery Role:** RDS read-only, DynamoDB write (inventory table only)
- **Cost Analyzer Role:** RDS read-only, CloudWatch read-only, DynamoDB write (metrics table only)
- **Compliance Checker Role:** RDS read-only, DynamoDB write (compliance table only)
- **Operations Role:** RDS write (non-prod only), DynamoDB write (audit table only), SNS publish
- **Query Handler Role:** DynamoDB read-only
- **Health Monitor Role:** RDS read-only, CloudWatch read-only, DynamoDB write (alerts table only)

## Monitoring and Compliance

### CloudTrail Monitoring
Enable CloudTrail logging for:
- All `rds:*` write operations
- All `sts:AssumeRole` operations
- All `dynamodb:DeleteItem` operations

### CloudWatch Alarms
Create alarms for:
- Unauthorized access attempts (AccessDenied errors)
- RDS write operations in production accounts
- Unusual STS AssumeRole patterns

### Regular Audits
- Monthly review of IAM policies
- Quarterly access review
- Annual penetration testing

## Implementation Plan

1. **Immediate (Week 1):**
   - Add explicit DENY for production RDS operations
   - Restrict STS AssumeRole to specific accounts
   - Enable CloudTrail logging

2. **Short-term (Month 1):**
   - Refine S3 policy with prefix restrictions
   - Implement CloudWatch alarms
   - Document all IAM changes

3. **Medium-term (Quarter 1):**
   - Migrate to function-specific roles
   - Implement automated IAM policy testing
   - Set up regular audit schedule

## Compliance Checklist

- [ ] All policies follow least-privilege principle
- [ ] Production resources protected with explicit DENY
- [ ] Cross-account access restricted to known accounts
- [ ] External ID used for all cross-account access
- [ ] CloudTrail enabled for all write operations
- [ ] CloudWatch alarms configured for security events
- [ ] IAM policies documented and version-controlled
- [ ] Regular audit schedule established
- [ ] Incident response plan includes IAM compromise scenarios

## References

- AWS IAM Best Practices: https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html
- Least Privilege Principle: https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege
- Cross-Account Access: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html

---

**Next Review Date:** 2026-03-03  
**Reviewed By:** [Pending]  
**Approved By:** [Pending]
