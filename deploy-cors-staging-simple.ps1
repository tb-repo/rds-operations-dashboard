<#\n.SYNOPSIS\n    Simple CORS staging deployment using existing infrastructure\n    \n.DESCRIPTION\n    Creates a staging BFF Lambda function and deploys CORS-enabled code\n#>\n\n# Configuration\n$ErrorActionPreference = \"Stop\"\n$StagingFunctionName = \"rds-dashboard-bff-staging\"\n$ProductionFunctionName = \"rds-dashboard-bff-prod\"\n$Region = \"ap-southeast-1\"\n$StagingCorsOrigins = \"https://staging-d2qvaswtmn22om.cloudfront.net,http://localhost:3000,http://localhost:5173\"\n\nfunction Write-ColorOutput {\n    param(\n        [string]$Message,\n        [string]$Color = \"White\"\n    )\n    $Colors = @{\n        Success = \"Green\"\n        Warning = \"Yellow\"\n        Error = \"Red\"\n        Info = \"Cyan\"\n        Header = \"Magenta\"\n    }\n    Write-Host $Message -ForegroundColor $Colors[$Color]\n}\n\nWrite-ColorOutput \"üöÄ CORS Staging Deployment - Simple Method\" -Color Header\nWrite-Host \"\"\n\n# Step 1: Check if staging function exists\nWrite-ColorOutput \"Step 1: Checking if staging function exists...\" -Color Info\ntry {\n    $existingFunction = aws lambda get-function --function-name $StagingFunctionName --region $Region 2>$null\n    if ($LASTEXITCODE -eq 0) {\n        Write-ColorOutput \"‚úÖ Staging function exists, will update it\" -Color Success\n        $functionExists = $true\n    } else {\n        Write-ColorOutput \"‚ÑπÔ∏è Staging function doesn't exist, will create it\" -Color Info\n        $functionExists = $false\n    }\n} catch {\n    Write-ColorOutput \"‚ÑπÔ∏è Staging function doesn't exist, will create it\" -Color Info\n    $functionExists = $false\n}\n\n# Step 2: Build the BFF code\nWrite-ColorOutput \"Step 2: Building BFF code...\" -Color Info\ntry {\n    Push-Location \"bff\"\n    npm run build\n    if ($LASTEXITCODE -ne 0) {\n        throw \"Build failed\"\n    }\n    Write-ColorOutput \"‚úÖ Build completed successfully\" -Color Success\n} catch {\n    Write-ColorOutput \"‚ùå Build failed: $($_.Exception.Message)\" -Color Error\n    exit 1\n} finally {\n    Pop-Location\n}\n\n# Step 3: Create deployment package\nWrite-ColorOutput \"Step 3: Creating deployment package...\" -Color Info\n\n$deploymentDir = \"staging-deployment\"\nif (Test-Path $deploymentDir) {\n    Remove-Item $deploymentDir -Recurse -Force\n}\n\ntry {\n    New-Item -ItemType Directory -Path $deploymentDir -Force | Out-Null\n    \n    # Copy built files\n    Copy-Item \"bff/dist/*\" -Destination $deploymentDir -Recurse -Force\n    Copy-Item \"bff/node_modules\" -Destination $deploymentDir -Recurse -Force\n    Copy-Item \"bff/package.json\" -Destination $deploymentDir -Force\n    \n    # Create ZIP file using Python (most reliable)\n    $zipPath = \"staging-deployment.zip\"\n    if (Test-Path $zipPath) {\n        Remove-Item $zipPath -Force\n    }\n    \n    python -c @\"\nimport zipfile\nimport os\n\ndef create_zip(source_dir, output_file):\n    with zipfile.ZipFile(output_file, 'w', zipfile.ZIP_DEFLATED) as zipf:\n        for root, dirs, files in os.walk(source_dir):\n            for file in files:\n                file_path = os.path.join(root, file)\n                arc_name = os.path.relpath(file_path, source_dir)\n                zipf.write(file_path, arc_name)\n\ncreate_zip('$deploymentDir', '$zipPath')\nprint('Deployment package created successfully')\n\"@\n    \n    if (-not (Test-Path $zipPath)) {\n        throw \"Failed to create deployment package\"\n    }\n    \n    $zipSize = (Get-Item $zipPath).Length / 1MB\n    Write-ColorOutput \"‚úÖ Package created: $([math]::Round($zipSize, 2)) MB\" -Color Success\n    \n} catch {\n    Write-ColorOutput \"‚ùå Failed to create deployment package: $($_.Exception.Message)\" -Color Error\n    exit 1\n}\n\n# Step 4: Create or update Lambda function\nif (-not $functionExists) {\n    Write-ColorOutput \"Step 4: Creating staging Lambda function...\" -Color Info\n    \n    # Get IAM role from existing function (use any RDS dashboard function as template)\n    try {\n        $existingFunctionConfig = aws lambda get-function-configuration --function-name \"rds-query-handler\" --region $Region | ConvertFrom-Json\n        $roleArn = $existingFunctionConfig.Role\n        \n        Write-ColorOutput \"Using IAM role: $roleArn\" -Color Info\n        \n        # Create the function\n        aws lambda create-function `\n            --function-name $StagingFunctionName `\n            --runtime \"nodejs18.x\" `\n            --role $roleArn `\n            --handler \"index.handler\" `\n            --zip-file \"fileb://$zipPath\" `\n            --description \"RDS Dashboard BFF - Staging Environment with CORS fixes\" `\n            --timeout 30 `\n            --memory-size 512 `\n            --region $Region `\n            --environment \"Variables={CORS_ORIGINS='$StagingCorsOrigins',NODE_ENV='staging'}\" `\n            --publish\n            \n        if ($LASTEXITCODE -ne 0) {\n            throw \"Failed to create Lambda function\"\n        }\n        \n        Write-ColorOutput \"‚úÖ Staging function created successfully\" -Color Success\n        \n    } catch {\n        Write-ColorOutput \"‚ùå Failed to create function: $($_.Exception.Message)\" -Color Error\n        exit 1\n    }\n} else {\n    Write-ColorOutput \"Step 4: Updating existing staging function...\" -Color Info\n    \n    try {\n        # Update environment variables first\n        aws lambda update-function-configuration `\n            --function-name $StagingFunctionName `\n            --environment \"Variables={CORS_ORIGINS='$StagingCorsOrigins',NODE_ENV='staging'}\" `\n            --region $Region\n            \n        if ($LASTEXITCODE -ne 0) {\n            throw \"Failed to update environment variables\"\n        }\n        \n        # Update function code\n        aws lambda update-function-code `\n            --function-name $StagingFunctionName `\n            --zip-file \"fileb://$zipPath\" `\n            --region $Region\n            \n        if ($LASTEXITCODE -ne 0) {\n            throw \"Failed to update function code\"\n        }\n        \n        Write-ColorOutput \"‚úÖ Staging function updated successfully\" -Color Success\n        \n    } catch {\n        Write-ColorOutput \"‚ùå Failed to update function: $($_.Exception.Message)\" -Color Error\n        exit 1\n    }\n}\n\n# Step 5: Test the deployment\nWrite-ColorOutput \"Step 5: Testing deployment...\" -Color Info\n\ntry {\n    # Test function invocation\n    $testPayload = @{\n        httpMethod = \"GET\"\n        path = \"/health\"\n        headers = @{\n            Origin = \"https://staging-d2qvaswtmn22om.cloudfront.net\"\n            \"Content-Type\" = \"application/json\"\n        }\n        body = $null\n        isBase64Encoded = $false\n    } | ConvertTo-Json -Depth 3\n    \n    $testPayload | Out-File -FilePath \"test-payload.json\" -Encoding UTF8\n    \n    $result = aws lambda invoke `\n        --function-name $StagingFunctionName `\n        --payload \"file://test-payload.json\" `\n        --region $Region `\n        \"response.json\"\n        \n    if ($LASTEXITCODE -eq 0) {\n        Write-ColorOutput \"‚úÖ Function invocation successful\" -Color Success\n        \n        if (Test-Path \"response.json\") {\n            $response = Get-Content \"response.json\" | ConvertFrom-Json\n            Write-ColorOutput \"üìä Response Status: $($response.statusCode)\" -Color Info\n            \n            if ($response.headers -and $response.headers.\"Access-Control-Allow-Origin\") {\n                Write-ColorOutput \"‚úÖ CORS Header Present: $($response.headers.'Access-Control-Allow-Origin')\" -Color Success\n            } else {\n                Write-ColorOutput \"‚ö†Ô∏è CORS headers may need verification\" -Color Warning\n            }\n        }\n    } else {\n        Write-ColorOutput \"‚ö†Ô∏è Function test had issues, but deployment may still be successful\" -Color Warning\n    }\n    \n} catch {\n    Write-ColorOutput \"‚ö†Ô∏è Test failed, but deployment may still be successful: $($_.Exception.Message)\" -Color Warning\n} finally {\n    # Cleanup test files\n    if (Test-Path \"test-payload.json\") { Remove-Item \"test-payload.json\" -Force }\n    if (Test-Path \"response.json\") { Remove-Item \"response.json\" -Force }\n}\n\n# Step 6: Get function details\nWrite-ColorOutput \"Step 6: Getting function details...\" -Color Info\n\ntry {\n    $functionConfig = aws lambda get-function-configuration --function-name $StagingFunctionName --region $Region | ConvertFrom-Json\n    \n    Write-ColorOutput \"‚úÖ Function Details:\" -Color Success\n    Write-ColorOutput \"   Name: $($functionConfig.FunctionName)\" -Color Info\n    Write-ColorOutput \"   Runtime: $($functionConfig.Runtime)\" -Color Info\n    Write-ColorOutput \"   Last Modified: $($functionConfig.LastModified)\" -Color Info\n    Write-ColorOutput \"   Memory: $($functionConfig.MemorySize) MB\" -Color Info\n    Write-ColorOutput \"   Timeout: $($functionConfig.Timeout) seconds\" -Color Info\n    \n    if ($functionConfig.Environment.Variables.CORS_ORIGINS) {\n        Write-ColorOutput \"   CORS Origins: $($functionConfig.Environment.Variables.CORS_ORIGINS)\" -Color Info\n    }\n    \n    if ($functionConfig.Environment.Variables.NODE_ENV) {\n        Write-ColorOutput \"   Environment: $($functionConfig.Environment.Variables.NODE_ENV)\" -Color Info\n    }\n    \n} catch {\n    Write-ColorOutput \"‚ö†Ô∏è Could not get function details, but deployment likely successful\" -Color Warning\n}\n\n# Cleanup\nif (Test-Path $deploymentDir) {\n    Remove-Item $deploymentDir -Recurse -Force\n}\nif (Test-Path $zipPath) {\n    Remove-Item $zipPath -Force\n}\n\n# Summary\nWrite-ColorOutput \"\" -Color Info\nWrite-ColorOutput \"üéâ CORS Staging Deployment Complete!\" -Color Success\nWrite-ColorOutput \"\" -Color Info\nWrite-ColorOutput \"üìã Deployment Summary:\" -Color Header\nWrite-ColorOutput \"   Function: $StagingFunctionName\" -Color Info\nWrite-ColorOutput \"   Region: $Region\" -Color Info\nWrite-ColorOutput \"   CORS Origins: $StagingCorsOrigins\" -Color Info\nWrite-ColorOutput \"   Environment: staging\" -Color Info\nWrite-ColorOutput \"\" -Color Info\nWrite-ColorOutput \"üß™ Next Steps:\" -Color Header\nWrite-ColorOutput \"   1. Test CORS functionality from browser\" -Color Info\nWrite-ColorOutput \"   2. Run: ./scripts/verify-cors-deployment.ps1 -Environment staging\" -Color Info\nWrite-ColorOutput \"   3. If successful, deploy to production\" -Color Info\nWrite-ColorOutput \"\" -Color Info\nWrite-ColorOutput \"üåê Test URLs:\" -Color Header\nWrite-ColorOutput \"   Staging: https://staging-d2qvaswtmn22om.cloudfront.net\" -Color Info\nWrite-ColorOutput \"   Local Dev: http://localhost:3000\" -Color Info\nWrite-ColorOutput \"   Vite Dev: http://localhost:5173\" -Color Info\n\nWrite-Host \"\"\nWrite-ColorOutput \"‚úÖ Staging deployment ready for testing!\" -Color Success