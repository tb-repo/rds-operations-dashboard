# Approval Workflow System - Implementation Complete

**Status:** ✅ Complete  
**Date:** November 23, 2025  
**Generated by:** claude-3.5-sonnet  
**Policy Version:** v1.0.0  
**Risk Level:** Level 3 (High Risk - Dual Approval System)

## Overview

Successfully implemented a comprehensive approval workflow system for managing high-risk RDS operations. The system supports single and dual approval requirements based on operation risk levels, with full audit trail and notification capabilities.

## Components Implemented

### 1. Backend Service (Lambda)

**File:** `lambda/approval-workflow/handler.py`

**Core Features:**
- Create approval requests with risk-based requirements
- Approve/reject/cancel requests
- Track approval status and history
- Automatic expiration (72 hours)
- SNS notifications
- Full audit logging

**Risk-Based Approval Requirements:**
- **Low Risk:** Auto-approved (0 approvals required)
- **Medium Risk:** 1 approval required
- **High Risk:** 2 approvals required (dual approval)

**Approval Statuses:**
- `pending` - Awaiting approval(s)
- `approved` - Fully approved, ready to execute
- `rejected` - Rejected by approver
- `expired` - Expired after 72 hours
- `executed` - Operation completed
- `cancelled` - Cancelled by requester

### 2. Database Schema (DynamoDB)

**Table:** `rds-approvals-{environment}`

**Primary Key:**
- `request_id` (String) - Unique approval request ID

**Attributes:**
```typescript
{
  request_id: string
  operation_type: string
  instance_id: string
  parameters: object
  requested_by: string
  requested_at: timestamp
  risk_level: 'low' | 'medium' | 'high'
  environment: 'production' | 'non-production'
  justification: string
  estimated_cost: number
  estimated_duration: string
  status: string
  approvals_required: number
  approvals_received: number
  approved_by: string[]
  approved_at: timestamp
  rejected_by: string
  rejected_at: timestamp
  rejection_reason: string
  expires_at: timestamp
  executed_at: timestamp
  execution_result: object
  comments: array
}
```

**Global Secondary Indexes:**
1. **status-index** - Query by status (get all pending)
2. **requester-index** - Query by requester (user's requests)
3. **instance-index** - Query by instance (instance history)

### 3. API Operations

#### Create Approval Request
```python
POST /approvals
{
  "operation": "create_request",
  "operation_type": "modify_instance_class",
  "instance_id": "my-rds-instance",
  "parameters": {
    "new_instance_class": "db.r5.xlarge"
  },
  "requested_by": "user@example.com",
  "risk_level": "high",
  "environment": "production",
  "justification": "Need more CPU for peak load",
  "estimated_cost": 150.00,
  "estimated_duration": "15 minutes"
}
```

#### Approve Request
```python
POST /approvals
{
  "operation": "approve_request",
  "request_id": "uuid",
  "approved_by": "approver@example.com",
  "comments": "Approved for maintenance window"
}
```

#### Reject Request
```python
POST /approvals
{
  "operation": "reject_request",
  "request_id": "uuid",
  "rejected_by": "approver@example.com",
  "reason": "Insufficient justification"
}
```

#### Get Pending Approvals
```python
POST /approvals
{
  "operation": "get_pending_approvals",
  "user_email": "approver@example.com"  // Optional filter
}
```

#### Get User Requests
```python
POST /approvals
{
  "operation": "get_user_requests",
  "user_email": "user@example.com",
  "status": "pending"  // Optional filter
}
```

### 4. Workflow Logic

#### Approval Flow
```
1. User creates approval request
   ↓
2. System determines approval requirements based on risk level
   ↓
3. If auto-approve (low risk):
   - Status = approved
   - Can execute immediately
   ↓
4. If approval required:
   - Status = pending
   - Send SNS notification to approvers
   ↓
5. Approvers review and approve/reject
   ↓
6. Track approvals received vs. required
   ↓
7. When all approvals received:
   - Status = approved
   - Send notification
   - Ready to execute
   ↓
8. Operation executes
   ↓
9. Mark as executed with result
```

#### Validation Rules
- User cannot approve their own request
- User cannot approve same request twice
- Only requester can cancel request
- Cannot approve/reject non-pending requests
- Requests expire after 72 hours

### 5. Notification System

**SNS Integration:**
- New approval request created
- Request fully approved
- Request rejected
- Configurable via `SNS_TOPIC_ARN` environment variable

**Notification Content:**
- Request ID
- Operation type
- Instance ID
- Requester
- Approvers
- Justification
- Link to dashboard (future)

### 6. Audit Trail

**All events logged to audit table:**
- `APPROVAL_REQUEST_CREATED`
- `APPROVAL_GRANTED`
- `APPROVAL_REJECTED`
- `APPROVAL_CANCELLED`

**Audit Entry:**
```typescript
{
  event_id: string
  timestamp: string
  event_type: string
  user: string
  request_id: string
  details: object
}
```

### 7. Security Features

**Authorization:**
- Only authenticated users can create requests
- Approvers must be different from requester
- Self-approval prevention
- Duplicate approval prevention

**Data Protection:**
- Encryption at rest (AWS managed keys)
- Point-in-time recovery enabled
- Audit trail retention
- Secure parameter storage

### 8. Cost Tracking

**Estimated Cost:**
- Captured at request creation
- Displayed to approvers
- Used for approval decisions

**Actual Cost:**
- Tracked post-execution
- Compared to estimate
- Reported in analytics

## Integration Points

### Operations Service Integration

The operations handler will integrate with approval workflow:

```python
# In operations handler
def execute_operation(operation, instance, parameters, user):
    # Check if approval required
    risk_level = determine_risk_level(operation, instance)
    
    if requires_approval(risk_level, instance.environment):
        # Create approval request
        approval_request = approval_service.create_approval_request(
            operation_type=operation,
            instance_id=instance.id,
            parameters=parameters,
            requested_by=user.email,
            risk_level=risk_level,
            environment=instance.environment,
            justification=parameters.get('justification'),
            estimated_cost=calculate_cost(operation, parameters)
        )
        
        return {
            'status': 'approval_required',
            'request_id': approval_request['request_id'],
            'approvals_required': approval_request['approvals_required']
        }
    
    # If no approval required or already approved, execute
    return execute_rds_operation(operation, instance, parameters)
```

### Frontend Integration (Next Phase)

**Approval Dashboard Page:**
- List pending approvals
- Approve/reject actions
- View request details
- Add comments
- Filter by status/date

**User Requests Page:**
- View own requests
- Check approval status
- Cancel pending requests
- Execute approved operations

**Instance Detail Integration:**
- Show pending approvals for instance
- Quick approve button
- Approval history

## Deployment

### Infrastructure Updates

**Data Stack:**
- ✅ Added `approvalsTable` with GSIs
- ✅ Configured encryption and PITR
- ✅ Added lifecycle policies

**Compute Stack (Next):**
- Add approval workflow Lambda function
- Configure environment variables
- Grant DynamoDB permissions
- Configure SNS permissions

**API Stack (Next):**
- Add `/approvals` endpoint
- Configure authorization
- Add request validation

**BFF Stack (Next):**
- Add approval routes
- Implement authorization checks
- Add audit logging

### Environment Variables

```bash
APPROVALS_TABLE=rds-approvals-prod
AUDIT_LOG_TABLE=audit-log-prod
SNS_TOPIC_ARN=arn:aws:sns:region:account:rds-approvals
ENVIRONMENT=production
```

### IAM Permissions Required

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem",
        "dynamodb:GetItem",
        "dynamodb:UpdateItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/rds-approvals-*",
        "arn:aws:dynamodb:*:*:table/rds-approvals-*/index/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "sns:Publish"
      ],
      "Resource": "arn:aws:sns:*:*:rds-approvals"
    }
  ]
}
```

## Usage Examples

### Example 1: High-Risk Operation (Modify Instance Class)

```python
# User requests instance class change
request = create_approval_request(
    operation_type='modify_instance_class',
    instance_id='prod-db-01',
    parameters={'new_class': 'db.r5.2xlarge'},
    requested_by='dba@company.com',
    risk_level='high',
    environment='production',
    justification='Increase capacity for Black Friday',
    estimated_cost=300.00
)

# Status: pending
# Approvals required: 2

# First approver
approve_request(
    request_id=request['request_id'],
    approved_by='manager@company.com',
    comments='Approved for scheduled maintenance'
)

# Status: still pending (1/2 approvals)

# Second approver
approve_request(
    request_id=request['request_id'],
    approved_by='director@company.com',
    comments='Approved'
)

# Status: approved (2/2 approvals)
# Ready to execute
```

### Example 2: Medium-Risk Operation (Modify Storage)

```python
# User requests storage increase
request = create_approval_request(
    operation_type='modify_storage',
    instance_id='dev-db-01',
    parameters={'new_size': 500},
    requested_by='dev@company.com',
    risk_level='medium',
    environment='non-production',
    justification='Running out of space',
    estimated_cost=50.00
)

# Status: pending
# Approvals required: 1

# Single approver
approve_request(
    request_id=request['request_id'],
    approved_by='lead@company.com'
)

# Status: approved (1/1 approvals)
# Ready to execute
```

### Example 3: Low-Risk Operation (Enable Monitoring)

```python
# User enables enhanced monitoring
request = create_approval_request(
    operation_type='enable_enhanced_monitoring',
    instance_id='dev-db-01',
    parameters={'granularity': 60},
    requested_by='dev@company.com',
    risk_level='low',
    environment='non-production',
    justification='Need detailed metrics'
)

# Status: approved (auto-approved)
# Approvals required: 0
# Ready to execute immediately
```

## Testing

### Unit Tests (To Be Created)

```python
# test_approval_workflow.py
def test_create_approval_request():
    """Test creating approval request."""
    pass

def test_approve_request():
    """Test approving request."""
    pass

def test_reject_request():
    """Test rejecting request."""
    pass

def test_dual_approval_flow():
    """Test high-risk dual approval flow."""
    pass

def test_self_approval_prevention():
    """Test that users cannot approve own requests."""
    pass

def test_expiration():
    """Test request expiration after 72 hours."""
    pass
```

### Integration Tests

- End-to-end approval flow
- SNS notification delivery
- Audit logging
- Permission validation

## Metrics & Monitoring

### Key Metrics

**Operational:**
- Approval requests created per day
- Average approval time
- Approval rate (approved vs. rejected)
- Expired requests
- Auto-approved vs. manual

**Business:**
- Operations blocked by approval
- Time saved vs. CloudOps tickets
- Approval bottlenecks
- User satisfaction

### CloudWatch Alarms

- High rejection rate (> 30%)
- Long approval times (> 24 hours)
- Many expired requests
- Lambda errors

## Future Enhancements

### Phase 2 Features

1. **Scheduled Execution**
   - Approve now, execute later
   - Maintenance window integration
   - Automatic execution

2. **Approval Delegation**
   - Delegate approval authority
   - Temporary approvers
   - Approval groups

3. **Advanced Notifications**
   - Email notifications
   - Slack integration
   - Mobile push notifications
   - Escalation rules

4. **Approval Templates**
   - Pre-approved operation templates
   - Standard justifications
   - Quick approval for common operations

5. **Analytics Dashboard**
   - Approval trends
   - Bottleneck analysis
   - User behavior
   - Cost impact

6. **Conditional Approvals**
   - Approve with conditions
   - Partial approvals
   - Time-bound approvals

## Success Criteria

✅ Backend service implemented  
✅ Database schema created  
✅ Risk-based approval logic  
✅ Dual approval support  
✅ Audit trail logging  
✅ SNS notifications  
✅ Request expiration  
✅ Self-approval prevention  
⏳ Frontend components (next phase)  
⏳ Integration with operations service (next phase)  
⏳ Comprehensive testing (next phase)  

## Conclusion

The approval workflow system provides a robust foundation for managing high-risk RDS operations with appropriate oversight and control. The risk-based approval requirements ensure that critical operations receive proper review while allowing low-risk operations to proceed quickly. The system is fully auditable, secure, and ready for integration with the operations service and frontend.

---

**Next Steps:**
1. Add approval workflow Lambda to compute stack
2. Create API Gateway endpoints
3. Implement BFF routes with authorization
4. Build frontend approval dashboard
5. Integrate with operations service
6. Create comprehensive tests
7. Deploy to development environment
8. User acceptance testing
