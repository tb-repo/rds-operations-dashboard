# Simple CORS staging deployment\nparam(\n    [string]$FunctionName = \"rds-dashboard-bff-staging\",\n    [string]$Region = \"ap-southeast-1\"\n)\n\nWrite-Host \"=== CORS Staging Deployment ===\" -ForegroundColor Cyan\n\n# Configuration\n$StagingCorsOrigins = \"https://staging-d2qvaswtmn22om.cloudfront.net,http://localhost:3000,http://localhost:5173\"\n\n# Step 1: Build BFF\nWrite-Host \"Building BFF code...\" -ForegroundColor Yellow\nPush-Location \"bff\"\nnpm run build\nif ($LASTEXITCODE -ne 0) {\n    Write-Error \"Build failed\"\n    exit 1\n}\nPop-Location\n\n# Step 2: Create deployment package\nWrite-Host \"Creating deployment package...\" -ForegroundColor Yellow\n\n$tempDir = \"temp-staging\"\nif (Test-Path $tempDir) { Remove-Item $tempDir -Recurse -Force }\nNew-Item -ItemType Directory -Path $tempDir -Force | Out-Null\n\n# Copy files\nCopy-Item \"bff/dist/index.js\" \"$tempDir/\" -Force\nCopy-Item \"bff/package.json\" \"$tempDir/\" -Force\n\n# Install minimal dependencies\nPush-Location $tempDir\nnpm install --production --no-audit --no-fund --silent\nPop-Location\n\n# Create zip\nWrite-Host \"Creating zip file...\" -ForegroundColor Yellow\ntry {\n    python -c \"\nimport zipfile\nimport os\n\ndef create_zip(source_dir, output_file):\n    with zipfile.ZipFile(output_file, 'w', zipfile.ZIP_DEFLATED) as zipf:\n        for root, dirs, files in os.walk(source_dir):\n            for file in files:\n                file_path = os.path.join(root, file)\n                arc_name = os.path.relpath(file_path, source_dir)\n                zipf.write(file_path, arc_name)\n\ncreate_zip('$tempDir', 'staging-deployment.zip')\nprint('Zip created successfully')\n\"\n    Write-Host \"Package created successfully\" -ForegroundColor Green\n} catch {\n    Write-Error \"Failed to create package: $($_.Exception.Message)\"\n    exit 1\n}\n\n# Step 3: Check if function exists\nWrite-Host \"Checking if function exists...\" -ForegroundColor Yellow\n$functionExists = $false\ntry {\n    aws lambda get-function --function-name $FunctionName --region $Region | Out-Null\n    if ($LASTEXITCODE -eq 0) {\n        $functionExists = $true\n        Write-Host \"Function exists, will update\" -ForegroundColor Green\n    }\n} catch {\n    Write-Host \"Function doesn't exist, will create\" -ForegroundColor Yellow\n}\n\n# Step 4: Deploy function\nif (-not $functionExists) {\n    Write-Host \"Creating new Lambda function...\" -ForegroundColor Yellow\n    \n    # Get role from existing function\n    $existingConfig = aws lambda get-function-configuration --function-name \"rds-query-handler\" --region $Region | ConvertFrom-Json\n    $roleArn = $existingConfig.Role\n    \n    aws lambda create-function `\n        --function-name $FunctionName `\n        --runtime \"nodejs18.x\" `\n        --role $roleArn `\n        --handler \"index.handler\" `\n        --zip-file \"fileb://staging-deployment.zip\" `\n        --description \"RDS Dashboard BFF - Staging with CORS\" `\n        --timeout 30 `\n        --memory-size 512 `\n        --region $Region `\n        --environment \"Variables={CORS_ORIGINS='$StagingCorsOrigins',NODE_ENV='staging'}\"\n        \n    if ($LASTEXITCODE -eq 0) {\n        Write-Host \"Function created successfully!\" -ForegroundColor Green\n    } else {\n        Write-Error \"Failed to create function\"\n        exit 1\n    }\n} else {\n    Write-Host \"Updating existing function...\" -ForegroundColor Yellow\n    \n    # Update environment variables\n    aws lambda update-function-configuration `\n        --function-name $FunctionName `\n        --environment \"Variables={CORS_ORIGINS='$StagingCorsOrigins',NODE_ENV='staging'}\" `\n        --region $Region\n        \n    # Update code\n    aws lambda update-function-code `\n        --function-name $FunctionName `\n        --zip-file \"fileb://staging-deployment.zip\" `\n        --region $Region\n        \n    if ($LASTEXITCODE -eq 0) {\n        Write-Host \"Function updated successfully!\" -ForegroundColor Green\n    } else {\n        Write-Error \"Failed to update function\"\n        exit 1\n    }\n}\n\n# Step 5: Test function\nWrite-Host \"Testing function...\" -ForegroundColor Yellow\n\n$testPayload = @{\n    httpMethod = \"GET\"\n    path = \"/health\"\n    headers = @{\n        Origin = \"https://staging-d2qvaswtmn22om.cloudfront.net\"\n    }\n} | ConvertTo-Json\n\n$testPayload | Out-File \"test.json\" -Encoding UTF8\n\naws lambda invoke `\n    --function-name $FunctionName `\n    --payload \"file://test.json\" `\n    --region $Region `\n    \"response.json\"\n\nif (Test-Path \"response.json\") {\n    $response = Get-Content \"response.json\" | ConvertFrom-Json\n    Write-Host \"Response Status: $($response.statusCode)\" -ForegroundColor Cyan\n    \n    if ($response.headers -and $response.headers.'Access-Control-Allow-Origin') {\n        Write-Host \"CORS Header: $($response.headers.'Access-Control-Allow-Origin')\" -ForegroundColor Green\n    }\n}\n\n# Cleanup\nRemove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue\nRemove-Item \"staging-deployment.zip\" -Force -ErrorAction SilentlyContinue\nRemove-Item \"test.json\" -Force -ErrorAction SilentlyContinue\nRemove-Item \"response.json\" -Force -ErrorAction SilentlyContinue\n\nWrite-Host \"\" \nWrite-Host \"=== Staging Deployment Complete! ===\" -ForegroundColor Green\nWrite-Host \"Function: $FunctionName\" -ForegroundColor Cyan\nWrite-Host \"CORS Origins: $StagingCorsOrigins\" -ForegroundColor Cyan\nWrite-Host \"Environment: staging\" -ForegroundColor Cyan\nWrite-Host \"\"\nWrite-Host \"Next: Test from browser or run verification script\" -ForegroundColor Yellow