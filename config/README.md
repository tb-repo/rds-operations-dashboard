# Dashboard Configuration

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-11-12T18:45:00Z  
**Version:** 1.0.0

## Overview

The RDS Operations Dashboard uses a centralized JSON configuration file (`dashboard-config.json`) for managing dynamic parameters like account IDs, regions, and settings. This approach provides:

- ✅ **Single Source of Truth** - All configuration in one place
- ✅ **Easy Updates** - No code changes needed to add/remove accounts or regions
- ✅ **Version Control** - Track configuration changes over time
- ✅ **Validation** - Automatic validation on load
- ✅ **Environment Separation** - Different configs for dev/staging/prod

## Configuration File Structure

```json
{
  "version": "1.0.0",
  "deployment": {
    "environment": "prod",
    "region": "ap-southeast-1",
    "management_account_id": "123456789012"
  },
  "cross_account": {
    "external_id": "unique-id",
    "role_name": "RDSDashboardCrossAccountRole",
    "target_accounts": [...],
    "target_regions": [...]
  },
  "discovery": {...},
  "monitoring": {...},
  "caching": {...},
  "logging": {...},
  "tags": {...}
}
```

## Configuration Sections

### 1. Deployment

Basic deployment configuration:

```json
"deployment": {
  "environment": "prod",              // Environment name (prod, dev, test)
  "region": "ap-southeast-1",         // Primary AWS region
  "management_account_id": "123456789012"  // Management account ID
}
```

### 2. Cross-Account Configuration

Target accounts and regions to scan:

```json
"cross_account": {
  "external_id": "rds-dashboard-unique-id-12345",
  "role_name": "RDSDashboardCrossAccountRole",
  "target_accounts": [
    {
      "account_id": "123456789012",
      "account_name": "Production",
      "enabled": true                 // Set to false to disable
    },
    {
      "account_id": "234567890123",
      "account_name": "Development",
      "enabled": true
    }
  ],
  "target_regions": [
    {
      "region": "ap-southeast-1",
      "region_name": "Singapore",
      "enabled": true,
      "priority": 1                   // Lower = scanned first
    },
    {
      "region": "eu-west-2",
      "region_name": "London",
      "enabled": false,               // Disabled region
      "priority": 2
    }
  ]
}
```

### 3. Discovery Settings

Lambda function configuration for discovery:

```json
"discovery": {
  "schedule": "rate(1 hour)",        // EventBridge schedule
  "timeout_minutes": 15,             // Lambda timeout
  "memory_mb": 512,                  // Lambda memory
  "parallel_workers": 4,             // Concurrent region scans
  "retry_attempts": 3                // Retry on failure
}
```

### 4. Monitoring Settings

CloudWatch and SNS configuration:

```json
"monitoring": {
  "cloudwatch_namespace": "RDSDashboard",
  "sns_email": "dba-team@company.com",
  "alert_thresholds": {
    "new_instances_threshold": 5,    // Alert if > 5 new instances
    "deleted_instances_threshold": 3, // Alert if > 3 deleted
    "error_rate_threshold": 0.1      // Alert if > 10% errors
  }
}
```

### 5. Caching Settings

Metrics cache configuration:

```json
"caching": {
  "metrics_ttl_seconds": 300,        // 5 minutes cache TTL
  "cache_hit_threshold": 0.7         // Target 70% cache hit rate
}
```

### 6. Logging Settings

Log level and retention:

```json
"logging": {
  "log_level": "INFO",               // DEBUG, INFO, WARN, ERROR
  "log_retention_days": 7            // CloudWatch Logs retention
}
```

### 7. Tags

Resource tags for cost tracking:

```json
"tags": {
  "Project": "RDSDashboard",
  "ManagedBy": "CDK",
  "CostCenter": "DBA-Team",
  "Owner": "DBA-Team"
}
```

## Usage

### CDK Deployment

The configuration is automatically loaded during CDK deployment:

```bash
# Deploy with config file
cd infrastructure
cdk deploy --all

# Config is loaded from: ../config/dashboard-config.json
```

### Lambda Functions

Lambda functions load configuration at runtime:

```python
from shared import Config

# Load config (tries file first, falls back to env vars)
config = Config.load()

# Access configuration
accounts = config.cross_account.target_accounts
regions = config.cross_account.target_regions
```

## Configuration Locations

### 1. Local Development
```
rds-operations-dashboard/config/dashboard-config.json
```

### 2. Lambda Layer (Deployed)
```
/opt/config/dashboard-config.json
```

### 3. S3 (Optional)
```
s3://rds-dashboard-data-{account-id}-{env}/config/dashboard-config.json
```

## Adding/Removing Accounts

### Add a New Account

1. Edit `dashboard-config.json`:
```json
{
  "account_id": "456789012345",
  "account_name": "UAT",
  "enabled": true
}
```

2. Deploy cross-account role in the new account (see [cross-account-setup.md](../docs/cross-account-setup.md))

3. Redeploy infrastructure:
```bash
cdk deploy RDSDashboard-Compute-prod
```

4. Next discovery run will include the new account

### Disable an Account

1. Edit `dashboard-config.json`:
```json
{
  "account_id": "234567890123",
  "account_name": "Development",
  "enabled": false    // Changed from true
}
```

2. Redeploy:
```bash
cdk deploy RDSDashboard-Compute-prod
```

3. Account will be skipped in future discovery runs

## Adding/Removing Regions

### Add a New Region

1. Edit `dashboard-config.json`:
```json
{
  "region": "us-west-2",
  "region_name": "Oregon",
  "enabled": true,
  "priority": 5
}
```

2. Redeploy:
```bash
cdk deploy RDSDashboard-Compute-prod
```

### Disable a Region

1. Edit `dashboard-config.json`:
```json
{
  "region": "ap-south-1",
  "region_name": "Mumbai",
  "enabled": false,   // Changed from true
  "priority": 3
}
```

2. Redeploy:
```bash
cdk deploy RDSDashboard-Compute-prod
```

## Configuration Validation

The configuration is automatically validated on load:

### CDK Validation
```typescript
// Validates:
- Required fields present
- At least one account enabled
- At least one region enabled
- Account ID format (12 digits)
```

### Lambda Validation
```python
# Falls back to environment variables if config file not found
# Logs warning if validation fails
```

## Environment-Specific Configs

### Development
```bash
cp dashboard-config.json dashboard-config.dev.json
# Edit dev-specific values
# Deploy: cdk deploy --all -c config=dashboard-config.dev.json
```

### Production
```bash
# Use default dashboard-config.json
cdk deploy --all
```

## Updating Configuration

### Option 1: Redeploy (Recommended)

```bash
# 1. Edit config file
vim config/dashboard-config.json

# 2. Redeploy compute stack
cd infrastructure
cdk deploy RDSDashboard-Compute-prod

# 3. Changes take effect on next Lambda invocation
```

### Option 2: Update S3 (If using S3 config)

```bash
# Upload updated config to S3
aws s3 cp config/dashboard-config.json \
  s3://rds-dashboard-data-{account-id}-prod/config/

# Changes take effect on next Lambda invocation
```

### Option 3: Environment Variables (Fallback)

```bash
# Update Lambda environment variables
aws lambda update-function-configuration \
  --function-name rds-discovery-prod \
  --environment Variables="{TARGET_ACCOUNTS='[\"123\",\"456\"]'}"
```

## Best Practices

1. **Version Control** - Commit config file to Git
2. **Separate Environments** - Use different configs for dev/prod
3. **Validate Before Deploy** - Test config changes in dev first
4. **Document Changes** - Update `last_updated` field
5. **Backup** - Keep backups of working configurations
6. **Security** - Don't commit sensitive values (use AWS Secrets Manager)

## Troubleshooting

### Config Not Loading

**Symptom:** Lambda uses environment variables instead of config file

**Solution:**
1. Check config file exists in Lambda layer
2. Verify S3 bucket/key if using S3
3. Check CloudWatch Logs for config loading errors

### Invalid Configuration

**Symptom:** CDK deployment fails with validation error

**Solution:**
1. Check JSON syntax (use `jq . dashboard-config.json`)
2. Verify required fields are present
3. Ensure at least one account/region is enabled
4. Validate account ID format (12 digits)

### Changes Not Taking Effect

**Symptom:** Configuration changes not reflected in Lambda

**Solution:**
1. Redeploy compute stack: `cdk deploy RDSDashboard-Compute-prod`
2. Wait for next Lambda invocation (or invoke manually)
3. Check Lambda environment variables are updated

## Migration from Environment Variables

If you're currently using environment variables:

1. Create `dashboard-config.json` with current values
2. Deploy with config file
3. Verify Lambda loads config correctly
4. Remove environment variables (optional, kept as fallback)

## Example Configurations

### Minimal (Single Account, Single Region)
```json
{
  "cross_account": {
    "target_accounts": [
      {"account_id": "123456789012", "account_name": "Prod", "enabled": true}
    ],
    "target_regions": [
      {"region": "ap-southeast-1", "region_name": "Singapore", "enabled": true, "priority": 1}
    ]
  }
}
```

### Multi-Account, Multi-Region
```json
{
  "cross_account": {
    "target_accounts": [
      {"account_id": "111111111111", "account_name": "Prod", "enabled": true},
      {"account_id": "222222222222", "account_name": "Dev", "enabled": true},
      {"account_id": "333333333333", "account_name": "Test", "enabled": true}
    ],
    "target_regions": [
      {"region": "ap-southeast-1", "region_name": "Singapore", "enabled": true, "priority": 1},
      {"region": "eu-west-2", "region_name": "London", "enabled": true, "priority": 2},
      {"region": "us-east-1", "region_name": "N. Virginia", "enabled": true, "priority": 3}
    ]
  }
}
```

## Support

For questions or issues with configuration:
- Check CloudWatch Logs: `/aws/lambda/rds-discovery-prod`
- Review CDK deployment output
- Contact DBA team
