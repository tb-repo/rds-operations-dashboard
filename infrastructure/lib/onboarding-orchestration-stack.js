"use strict";
/**
 * Onboarding Orchestration Stack - EventBridge Rules for Account Onboarding
 *
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-12-08T00:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-1.1 → DESIGN-001 → TASK-2.2, TASK-2.3
 * Review Status: Pending
 * Risk Level: Level 2
 *
 * Purpose: Define EventBridge rules for automated account discovery and onboarding.
 * Implements event-driven discovery (Organizations events) and scheduled discovery
 * (every 15 minutes) with dead letter queue for failed invocations.
 *
 * Design Decisions:
 * - Event-driven: Trigger on CreateAccountResult from AWS Organizations
 * - Scheduled: Run every 15 minutes to catch any missed events
 * - DLQ: Capture failed invocations for manual investigation
 * - Retry: 2 attempts with exponential backoff
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.OnboardingOrchestrationStack = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const events = __importStar(require("aws-cdk-lib/aws-events"));
const targets = __importStar(require("aws-cdk-lib/aws-events-targets"));
const sqs = __importStar(require("aws-cdk-lib/aws-sqs"));
class OnboardingOrchestrationStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const { accountDiscoveryFunction, discoverySchedule } = props;
        // ========================================
        // Dead Letter Queue for Failed Invocations
        // ========================================
        // Purpose: Capture failed Lambda invocations for manual investigation
        // Requirements: REQ-2.5 (error handling)
        this.deadLetterQueue = new sqs.Queue(this, 'OnboardingDiscoveryDLQ', {
            queueName: 'rds-dashboard-onboarding-discovery-dlq',
            retentionPeriod: cdk.Duration.days(14),
            encryption: sqs.QueueEncryption.KMS_MANAGED,
            visibilityTimeout: cdk.Duration.minutes(5),
        });
        // CloudWatch alarm for DLQ depth > 0
        const dlqAlarm = this.deadLetterQueue.metricApproximateNumberOfMessagesVisible()
            .createAlarm(this, 'OnboardingDLQAlarm', {
            alarmName: 'rds-dashboard-onboarding-dlq-depth',
            alarmDescription: 'Alert when onboarding discovery DLQ has messages',
            threshold: 0,
            evaluationPeriods: 1,
            comparisonOperator: cdk.aws_cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            treatMissingData: cdk.aws_cloudwatch.TreatMissingData.NOT_BREACHING,
        });
        // ========================================
        // EventBridge Rule: Organizations Account Created Event
        // ========================================
        // Purpose: Trigger discovery when new account is created in Organizations
        // Requirements: REQ-1.1 (detect new accounts within 15 minutes)
        this.organizationsEventRule = new events.Rule(this, 'OrganizationsAccountCreatedRule', {
            ruleName: 'rds-dashboard-organizations-account-created',
            description: 'Triggers account discovery when new account is created in AWS Organizations',
            eventPattern: {
                source: ['aws.organizations'],
                detailType: ['AWS API Call via CloudTrail'],
                detail: {
                    eventName: ['CreateAccountResult'],
                    eventSource: ['organizations.amazonaws.com'],
                },
            },
            enabled: true,
        });
        // Add discovery Lambda as target with DLQ
        this.organizationsEventRule.addTarget(new targets.LambdaFunction(accountDiscoveryFunction, {
            retryAttempts: 2,
            maxEventAge: cdk.Duration.hours(2),
            deadLetterQueue: this.deadLetterQueue,
        }));
        // ========================================
        // EventBridge Rule: Scheduled Discovery (Every 15 minutes)
        // ========================================
        // Purpose: Periodic discovery to catch any missed events or manual account additions
        // Requirements: REQ-1.1 (detect new accounts within 15 minutes)
        const scheduleExpression = discoverySchedule || 'rate(15 minutes)';
        this.scheduledDiscoveryRule = new events.Rule(this, 'ScheduledAccountDiscoveryRule', {
            ruleName: 'rds-dashboard-scheduled-account-discovery',
            description: 'Triggers account discovery every 15 minutes to catch new accounts',
            schedule: events.Schedule.expression(scheduleExpression),
            enabled: true,
        });
        // Add discovery Lambda as target with DLQ
        this.scheduledDiscoveryRule.addTarget(new targets.LambdaFunction(accountDiscoveryFunction, {
            retryAttempts: 2,
            maxEventAge: cdk.Duration.hours(1),
            deadLetterQueue: this.deadLetterQueue,
        }));
        // ========================================
        // CloudFormation Outputs
        // ========================================
        new cdk.CfnOutput(this, 'OrganizationsEventRuleName', {
            value: this.organizationsEventRule.ruleName,
            description: 'EventBridge rule name for Organizations account created events',
            exportName: 'OnboardingOrganizationsEventRuleName',
        });
        new cdk.CfnOutput(this, 'ScheduledDiscoveryRuleName', {
            value: this.scheduledDiscoveryRule.ruleName,
            description: 'EventBridge rule name for scheduled account discovery',
            exportName: 'OnboardingScheduledDiscoveryRuleName',
        });
        new cdk.CfnOutput(this, 'DeadLetterQueueUrl', {
            value: this.deadLetterQueue.queueUrl,
            description: 'SQS Dead Letter Queue URL for failed discovery invocations',
            exportName: 'OnboardingDiscoveryDLQUrl',
        });
        new cdk.CfnOutput(this, 'DeadLetterQueueArn', {
            value: this.deadLetterQueue.queueArn,
            description: 'SQS Dead Letter Queue ARN for failed discovery invocations',
            exportName: 'OnboardingDiscoveryDLQArn',
        });
        // Add tags
        cdk.Tags.of(this).add('Component', 'OnboardingOrchestration');
        cdk.Tags.of(this).add('Feature', 'AutomatedAccountOnboarding');
    }
}
exports.OnboardingOrchestrationStack = OnboardingOrchestrationStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib25ib2FyZGluZy1vcmNoZXN0cmF0aW9uLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib25ib2FyZGluZy1vcmNoZXN0cmF0aW9uLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGlEQUFtQztBQUNuQywrREFBaUQ7QUFDakQsd0VBQTBEO0FBRTFELHlEQUEyQztBQVEzQyxNQUFhLDRCQUE2QixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBS3pELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBd0M7UUFDaEYsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSxFQUFFLHdCQUF3QixFQUFFLGlCQUFpQixFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRTlELDJDQUEyQztRQUMzQywyQ0FBMkM7UUFDM0MsMkNBQTJDO1FBQzNDLHNFQUFzRTtRQUN0RSx5Q0FBeUM7UUFDekMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQ25FLFNBQVMsRUFBRSx3Q0FBd0M7WUFDbkQsZUFBZSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN0QyxVQUFVLEVBQUUsR0FBRyxDQUFDLGVBQWUsQ0FBQyxXQUFXO1lBQzNDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUMzQyxDQUFDLENBQUM7UUFFSCxxQ0FBcUM7UUFDckMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyx3Q0FBd0MsRUFBRTthQUM3RSxXQUFXLENBQUMsSUFBSSxFQUFFLG9CQUFvQixFQUFFO1lBQ3ZDLFNBQVMsRUFBRSxvQ0FBb0M7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O1lBQ3BDLFdBQVcsRUFBRSw0REFBNEQ7WUFDekUsVUFBVSxFQUFFLDJCQUEyQjtTQUN4QyxDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLG9CQUFvQixFQUFFO1lBQzVDLEtBQUssRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVE7WUFDcEMsV0FBVyxFQUFFLDREQUE0RDtZQUN6RSxVQUFVLEVBQUUsMkJBQTJCO1NBQ3hDLENBQUMsQ0FBQztRQUVILFdBQVc7UUFDWCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLHlCQUF5QixDQUFDLENBQUM7UUFDOUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7Q0FDRjtBQW5IRCxvRUFtSEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogT25ib2FyZGluZyBPcmNoZXN0cmF0aW9uIFN0YWNrIC0gRXZlbnRCcmlkZ2UgUnVsZXMgZm9yIEFjY291bnQgT25ib2FyZGluZ1xyXG4gKiBcclxuICogR2VuZXJhdGVkIGJ5OiBjbGF1ZGUtMy41LXNvbm5ldFxyXG4gKiBUaW1lc3RhbXA6IDIwMjUtMTItMDhUMDA6MDA6MDBaXHJcbiAqIFZlcnNpb246IDEuMC4wXHJcbiAqIFBvbGljeSBWZXJzaW9uOiB2MS4wLjBcclxuICogVHJhY2VhYmlsaXR5OiBSRVEtMS4xIOKGkiBERVNJR04tMDAxIOKGkiBUQVNLLTIuMiwgVEFTSy0yLjNcclxuICogUmV2aWV3IFN0YXR1czogUGVuZGluZ1xyXG4gKiBSaXNrIExldmVsOiBMZXZlbCAyXHJcbiAqIFxyXG4gKiBQdXJwb3NlOiBEZWZpbmUgRXZlbnRCcmlkZ2UgcnVsZXMgZm9yIGF1dG9tYXRlZCBhY2NvdW50IGRpc2NvdmVyeSBhbmQgb25ib2FyZGluZy5cclxuICogSW1wbGVtZW50cyBldmVudC1kcml2ZW4gZGlzY292ZXJ5IChPcmdhbml6YXRpb25zIGV2ZW50cykgYW5kIHNjaGVkdWxlZCBkaXNjb3ZlcnlcclxuICogKGV2ZXJ5IDE1IG1pbnV0ZXMpIHdpdGggZGVhZCBsZXR0ZXIgcXVldWUgZm9yIGZhaWxlZCBpbnZvY2F0aW9ucy5cclxuICogXHJcbiAqIERlc2lnbiBEZWNpc2lvbnM6XHJcbiAqIC0gRXZlbnQtZHJpdmVuOiBUcmlnZ2VyIG9uIENyZWF0ZUFjY291bnRSZXN1bHQgZnJvbSBBV1MgT3JnYW5pemF0aW9uc1xyXG4gKiAtIFNjaGVkdWxlZDogUnVuIGV2ZXJ5IDE1IG1pbnV0ZXMgdG8gY2F0Y2ggYW55IG1pc3NlZCBldmVudHNcclxuICogLSBETFE6IENhcHR1cmUgZmFpbGVkIGludm9jYXRpb25zIGZvciBtYW51YWwgaW52ZXN0aWdhdGlvblxyXG4gKiAtIFJldHJ5OiAyIGF0dGVtcHRzIHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XHJcbmltcG9ydCAqIGFzIGV2ZW50cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcclxuaW1wb3J0ICogYXMgdGFyZ2V0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzLXRhcmdldHMnO1xyXG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XHJcbmltcG9ydCAqIGFzIHNxcyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3FzJztcclxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE9uYm9hcmRpbmdPcmNoZXN0cmF0aW9uU3RhY2tQcm9wcyBleHRlbmRzIGNkay5TdGFja1Byb3BzIHtcclxuICByZWFkb25seSBhY2NvdW50RGlzY292ZXJ5RnVuY3Rpb246IGxhbWJkYS5JRnVuY3Rpb247XHJcbiAgcmVhZG9ubHkgZGlzY292ZXJ5U2NoZWR1bGU/OiBzdHJpbmc7ICAvLyBEZWZhdWx0OiBldmVyeSAxNSBtaW51dGVzXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBPbmJvYXJkaW5nT3JjaGVzdHJhdGlvblN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcclxuICBwdWJsaWMgcmVhZG9ubHkgb3JnYW5pemF0aW9uc0V2ZW50UnVsZTogZXZlbnRzLlJ1bGU7XHJcbiAgcHVibGljIHJlYWRvbmx5IHNjaGVkdWxlZERpc2NvdmVyeVJ1bGU6IGV2ZW50cy5SdWxlO1xyXG4gIHB1YmxpYyByZWFkb25seSBkZWFkTGV0dGVyUXVldWU6IHNxcy5RdWV1ZTtcclxuXHJcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE9uYm9hcmRpbmdPcmNoZXN0cmF0aW9uU3RhY2tQcm9wcykge1xyXG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XHJcblxyXG4gICAgY29uc3QgeyBhY2NvdW50RGlzY292ZXJ5RnVuY3Rpb24sIGRpc2NvdmVyeVNjaGVkdWxlIH0gPSBwcm9wcztcclxuXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICAvLyBEZWFkIExldHRlciBRdWV1ZSBmb3IgRmFpbGVkIEludm9jYXRpb25zXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICAvLyBQdXJwb3NlOiBDYXB0dXJlIGZhaWxlZCBMYW1iZGEgaW52b2NhdGlvbnMgZm9yIG1hbnVhbCBpbnZlc3RpZ2F0aW9uXHJcbiAgICAvLyBSZXF1aXJlbWVudHM6IFJFUS0yLjUgKGVycm9yIGhhbmRsaW5nKVxyXG4gICAgdGhpcy5kZWFkTGV0dGVyUXVldWUgPSBuZXcgc3FzLlF1ZXVlKHRoaXMsICdPbmJvYXJkaW5nRGlzY292ZXJ5RExRJywge1xyXG4gICAgICBxdWV1ZU5hbWU6ICdyZHMtZGFzaGJvYXJkLW9uYm9hcmRpbmctZGlzY292ZXJ5LWRscScsXHJcbiAgICAgIHJldGVudGlvblBlcmlvZDogY2RrLkR1cmF0aW9uLmRheXMoMTQpLFxyXG4gICAgICBlbmNyeXB0aW9uOiBzcXMuUXVldWVFbmNyeXB0aW9uLktNU19NQU5BR0VELFxyXG4gICAgICB2aXNpYmlsaXR5VGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBDbG91ZFdhdGNoIGFsYXJtIGZvciBETFEgZGVwdGggPiAwXHJcbiAgICBjb25zdCBkbHFBbGFybSA9IHRoaXMuZGVhZExldHRlclF1ZXVlLm1ldHJpY0FwcHJveGltYXRlTnVtYmVyT2ZNZXNzYWdlc1Zpc2libGUoKVxyXG4gICAgICAuY3JlYXRlQWxhcm0odGhpcywgJ09uYm9hcmRpbmdETFFBbGFybScsIHtcclxuICAgICAgICBhbGFybU5hbWU6ICdyZHMtZGFzaGJvYXJkLW9uYm9hcmRpbmctZGxxLWRlcHRoJyxcclxuICAgICAgICBhbGFybURlc2NyaXB0aW9uOiAnQWxlcnQgd2hlbiBvbmJvYXJkaW5nIGRpc2NvdmVyeSBETFEgaGFzIG1lc3NhZ2VzJyxcclxuICAgICAgICB0aHJlc2hvbGQ6IDAsXHJcbiAgICAgICAgZXZhbHVhdGlvblBlcmlvZHM6IDEsXHJcbiAgICAgICAgY29tcGFyaXNvbk9wZXJhdG9yOiBjZGsuYXdzX2Nsb3Vkd2F0Y2guQ29tcGFyaXNvbk9wZXJhdG9yLkdSRUFURVJfVEhBTl9USFJFU0hPTEQsXHJcbiAgICAgICAgdHJlYXRNaXNzaW5nRGF0YTogY2RrLmF3c19jbG91ZHdhdGNoLlRyZWF0TWlzc2luZ0RhdGEuTk9UX0JSRUFDSElORyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gRXZlbnRCcmlkZ2UgUnVsZTogT3JnYW5pemF0aW9ucyBBY2NvdW50IENyZWF0ZWQgRXZlbnRcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIFB1cnBvc2U6IFRyaWdnZXIgZGlzY292ZXJ5IHdoZW4gbmV3IGFjY291bnQgaXMgY3JlYXRlZCBpbiBPcmdhbml6YXRpb25zXHJcbiAgICAvLyBSZXF1aXJlbWVudHM6IFJFUS0xLjEgKGRldGVjdCBuZXcgYWNjb3VudHMgd2l0aGluIDE1IG1pbnV0ZXMpXHJcbiAgICB0aGlzLm9yZ2FuaXphdGlvbnNFdmVudFJ1bGUgPSBuZXcgZXZlbnRzLlJ1bGUodGhpcywgJ09yZ2FuaXphdGlvbnNBY2NvdW50Q3JlYXRlZFJ1bGUnLCB7XHJcbiAgICAgIHJ1bGVOYW1lOiAncmRzLWRhc2hib2FyZC1vcmdhbml6YXRpb25zLWFjY291bnQtY3JlYXRlZCcsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiAnVHJpZ2dlcnMgYWNjb3VudCBkaXNjb3Zlcnkgd2hlbiBuZXcgYWNjb3VudCBpcyBjcmVhdGVkIGluIEFXUyBPcmdhbml6YXRpb25zJyxcclxuICAgICAgZXZlbnRQYXR0ZXJuOiB7XHJcbiAgICAgICAgc291cmNlOiBbJ2F3cy5vcmdhbml6YXRpb25zJ10sXHJcbiAgICAgICAgZGV0YWlsVHlwZTogWydBV1MgQVBJIENhbGwgdmlhIENsb3VkVHJhaWwnXSxcclxuICAgICAgICBkZXRhaWw6IHtcclxuICAgICAgICAgIGV2ZW50TmFtZTogWydDcmVhdGVBY2NvdW50UmVzdWx0J10sXHJcbiAgICAgICAgICBldmVudFNvdXJjZTogWydvcmdhbml6YXRpb25zLmFtYXpvbmF3cy5jb20nXSxcclxuICAgICAgICB9LFxyXG4gICAgICB9LFxyXG4gICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQWRkIGRpc2NvdmVyeSBMYW1iZGEgYXMgdGFyZ2V0IHdpdGggRExRXHJcbiAgICB0aGlzLm9yZ2FuaXphdGlvbnNFdmVudFJ1bGUuYWRkVGFyZ2V0KFxyXG4gICAgICBuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihhY2NvdW50RGlzY292ZXJ5RnVuY3Rpb24sIHtcclxuICAgICAgICByZXRyeUF0dGVtcHRzOiAyLFxyXG4gICAgICAgIG1heEV2ZW50QWdlOiBjZGsuRHVyYXRpb24uaG91cnMoMiksXHJcbiAgICAgICAgZGVhZExldHRlclF1ZXVlOiB0aGlzLmRlYWRMZXR0ZXJRdWV1ZSxcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gRXZlbnRCcmlkZ2UgUnVsZTogU2NoZWR1bGVkIERpc2NvdmVyeSAoRXZlcnkgMTUgbWludXRlcylcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIFB1cnBvc2U6IFBlcmlvZGljIGRpc2NvdmVyeSB0byBjYXRjaCBhbnkgbWlzc2VkIGV2ZW50cyBvciBtYW51YWwgYWNjb3VudCBhZGRpdGlvbnNcclxuICAgIC8vIFJlcXVpcmVtZW50czogUkVRLTEuMSAoZGV0ZWN0IG5ldyBhY2NvdW50cyB3aXRoaW4gMTUgbWludXRlcylcclxuICAgIGNvbnN0IHNjaGVkdWxlRXhwcmVzc2lvbiA9IGRpc2NvdmVyeVNjaGVkdWxlIHx8ICdyYXRlKDE1IG1pbnV0ZXMpJztcclxuICAgIFxyXG4gICAgdGhpcy5zY2hlZHVsZWREaXNjb3ZlcnlSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdTY2hlZHVsZWRBY2NvdW50RGlzY292ZXJ5UnVsZScsIHtcclxuICAgICAgcnVsZU5hbWU6ICdyZHMtZGFzaGJvYXJkLXNjaGVkdWxlZC1hY2NvdW50LWRpc2NvdmVyeScsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiAnVHJpZ2dlcnMgYWNjb3VudCBkaXNjb3ZlcnkgZXZlcnkgMTUgbWludXRlcyB0byBjYXRjaCBuZXcgYWNjb3VudHMnLFxyXG4gICAgICBzY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlLmV4cHJlc3Npb24oc2NoZWR1bGVFeHByZXNzaW9uKSxcclxuICAgICAgZW5hYmxlZDogdHJ1ZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFkZCBkaXNjb3ZlcnkgTGFtYmRhIGFzIHRhcmdldCB3aXRoIERMUVxyXG4gICAgdGhpcy5zY2hlZHVsZWREaXNjb3ZlcnlSdWxlLmFkZFRhcmdldChcclxuICAgICAgbmV3IHRhcmdldHMuTGFtYmRhRnVuY3Rpb24oYWNjb3VudERpc2NvdmVyeUZ1bmN0aW9uLCB7XHJcbiAgICAgICAgcmV0cnlBdHRlbXB0czogMixcclxuICAgICAgICBtYXhFdmVudEFnZTogY2RrLkR1cmF0aW9uLmhvdXJzKDEpLFxyXG4gICAgICAgIGRlYWRMZXR0ZXJRdWV1ZTogdGhpcy5kZWFkTGV0dGVyUXVldWUsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIENsb3VkRm9ybWF0aW9uIE91dHB1dHNcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdPcmdhbml6YXRpb25zRXZlbnRSdWxlTmFtZScsIHtcclxuICAgICAgdmFsdWU6IHRoaXMub3JnYW5pemF0aW9uc0V2ZW50UnVsZS5ydWxlTmFtZSxcclxuICAgICAgZGVzY3JpcHRpb246ICdFdmVudEJyaWRnZSBydWxlIG5hbWUgZm9yIE9yZ2FuaXphdGlvbnMgYWNjb3VudCBjcmVhdGVkIGV2ZW50cycsXHJcbiAgICAgIGV4cG9ydE5hbWU6ICdPbmJvYXJkaW5nT3JnYW5pemF0aW9uc0V2ZW50UnVsZU5hbWUnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ1NjaGVkdWxlZERpc2NvdmVyeVJ1bGVOYW1lJywge1xyXG4gICAgICB2YWx1ZTogdGhpcy5zY2hlZHVsZWREaXNjb3ZlcnlSdWxlLnJ1bGVOYW1lLFxyXG4gICAgICBkZXNjcmlwdGlvbjogJ0V2ZW50QnJpZGdlIHJ1bGUgbmFtZSBmb3Igc2NoZWR1bGVkIGFjY291bnQgZGlzY292ZXJ5JyxcclxuICAgICAgZXhwb3J0TmFtZTogJ09uYm9hcmRpbmdTY2hlZHVsZWREaXNjb3ZlcnlSdWxlTmFtZScsXHJcbiAgICB9KTtcclxuXHJcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnRGVhZExldHRlclF1ZXVlVXJsJywge1xyXG4gICAgICB2YWx1ZTogdGhpcy5kZWFkTGV0dGVyUXVldWUucXVldWVVcmwsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiAnU1FTIERlYWQgTGV0dGVyIFF1ZXVlIFVSTCBmb3IgZmFpbGVkIGRpc2NvdmVyeSBpbnZvY2F0aW9ucycsXHJcbiAgICAgIGV4cG9ydE5hbWU6ICdPbmJvYXJkaW5nRGlzY292ZXJ5RExRVXJsJyxcclxuICAgIH0pO1xyXG5cclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdEZWFkTGV0dGVyUXVldWVBcm4nLCB7XHJcbiAgICAgIHZhbHVlOiB0aGlzLmRlYWRMZXR0ZXJRdWV1ZS5xdWV1ZUFybixcclxuICAgICAgZGVzY3JpcHRpb246ICdTUVMgRGVhZCBMZXR0ZXIgUXVldWUgQVJOIGZvciBmYWlsZWQgZGlzY292ZXJ5IGludm9jYXRpb25zJyxcclxuICAgICAgZXhwb3J0TmFtZTogJ09uYm9hcmRpbmdEaXNjb3ZlcnlETFFBcm4nLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQWRkIHRhZ3NcclxuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnQ29tcG9uZW50JywgJ09uYm9hcmRpbmdPcmNoZXN0cmF0aW9uJyk7XHJcbiAgICBjZGsuVGFncy5vZih0aGlzKS5hZGQoJ0ZlYXR1cmUnLCAnQXV0b21hdGVkQWNjb3VudE9uYm9hcmRpbmcnKTtcclxuICB9XHJcbn1cclxuIl19