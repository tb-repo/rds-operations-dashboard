/**
 * IAM Stack - Lambda Execution Role and Cross-Account Role Template
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-11-12T17:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-9.1, REQ-9.2, REQ-9.4 → DESIGN-001 → TASK-1.3
 * Review Status: Pending
 * Risk Level: Level 2
 * 
 * Purpose: Create Lambda execution role in management account with permissions
 * for DynamoDB, S3, SNS, CloudWatch Logs, and STS AssumeRole. Generate
 * cross-account role template for target accounts.
 * 
 * Design Decisions:
 * - Least-privilege permissions (only required actions)
 * - External ID for cross-account security
 * - Separate policies for different service interactions
 * - Conditional permissions for write operations (non-prod only)
 */

import * as cdk from 'aws-cdk-lib';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as dynamodb from 'aws-cdk-lib/aws-dynamodb';
import * as s3 from 'aws-cdk-lib/aws-s3';
import { Construct } from 'constructs';

export interface IamStackProps extends cdk.StackProps {
  readonly externalId: string;
  readonly rdsInventoryTable: dynamodb.ITable;
  readonly metricsCacheTable: dynamodb.ITable;
  readonly healthAlertsTable: dynamodb.ITable;
  readonly auditLogTable: dynamodb.ITable;
  readonly approvalsTable: dynamodb.ITable;
  readonly dataBucket: s3.IBucket;
}

export class IamStack extends cdk.Stack {
  public readonly lambdaExecutionRole: iam.Role;
  public readonly crossAccountRoleTemplate: string;

  constructor(scope: Construct, id: string, props: IamStackProps) {
    super(scope, id, props);

    const { externalId, rdsInventoryTable, metricsCacheTable, 
            healthAlertsTable, auditLogTable, approvalsTable, dataBucket } = props;

    // ========================================
    // Lambda Execution Role (Management Account)
    // ========================================
    // Purpose: Role assumed by Lambda functions to access AWS services
    // Requirements: REQ-9.1 (IAM roles), REQ-9.2 (least-privilege)
    this.lambdaExecutionRole = new iam.Role(this, 'LambdaExecutionRole', {
      roleName: 'RDSDashboardLambdaRole',
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
      description: 'Execution role for RDS Dashboard Lambda functions',
      managedPolicies: [
        // Basic Lambda execution (CloudWatch Logs)
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'),
      ],
    });

    // ========================================
    // Policy: DynamoDB Access
    // ========================================
    // Purpose: Read/write access to DynamoDB tables
    const dynamoDbPolicy = new iam.Policy(this, 'DynamoDbPolicy', {
      policyName: 'RDSDashboard-DynamoDB',
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: [
            'dynamodb:PutItem',
            'dynamodb:GetItem',
            'dynamodb:Query',
            'dynamodb:Scan',
            'dynamodb:UpdateItem',
            'dynamodb:DeleteItem',
            'dynamodb:BatchWriteItem',
            'dynamodb:BatchGetItem',
          ],
          resources: [
            rdsInventoryTable.tableArn,
            metricsCacheTable.tableArn,
            healthAlertsTable.tableArn,
            auditLogTable.tableArn,
            approvalsTable.tableArn,
            // Include GSI ARNs
            `${rdsInventoryTable.tableArn}/index/*`,
            `${healthAlertsTable.tableArn}/index/*`,
            `${auditLogTable.tableArn}/index/*`,
            `${approvalsTable.tableArn}/index/*`,
          ],
        }),
      ],
    });
    dynamoDbPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: S3 Access
    // ========================================
    // Purpose: Read/write access to data bucket with prefix restrictions
    // Requirements: REQ-6.3 (least-privilege)
    const s3Policy = new iam.Policy(this, 'S3Policy', {
      policyName: 'RDSDashboard-S3',
      statements: [
        // Read access to entire bucket (for listing and getting objects)
        new iam.PolicyStatement({
          sid: 'AllowS3Read',
          effect: iam.Effect.ALLOW,
          actions: [
            's3:GetObject',
            's3:ListBucket',
            's3:GetBucketLocation',
          ],
          resources: [
            dataBucket.bucketArn,
            `${dataBucket.bucketArn}/*`,
          ],
        }),
        // Write access restricted to specific prefixes
        new iam.PolicyStatement({
          sid: 'AllowS3WriteToSpecificPrefixes',
          effect: iam.Effect.ALLOW,
          actions: ['s3:PutObject'],
          resources: [
            `${dataBucket.bucketArn}/cloudops-templates/*`,
            `${dataBucket.bucketArn}/cost-reports/*`,
            `${dataBucket.bucketArn}/compliance-reports/*`,
            `${dataBucket.bucketArn}/audit-logs/*`,
            `${dataBucket.bucketArn}/discovery-results/*`,
          ],
        }),
        // Delete access only for temporary files
        new iam.PolicyStatement({
          sid: 'AllowS3DeleteTempFiles',
          effect: iam.Effect.ALLOW,
          actions: ['s3:DeleteObject'],
          resources: [
            `${dataBucket.bucketArn}/temp/*`,
          ],
        }),
      ],
    });
    s3Policy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: SNS Publishing
    // ========================================
    // Purpose: Publish alerts to SNS topics
    const snsPolicy = new iam.Policy(this, 'SnsPolicy', {
      policyName: 'RDSDashboard-SNS',
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: ['sns:Publish'],
          resources: [
            `arn:aws:sns:${this.region}:${this.account}:rds-dashboard-alerts`,
          ],
        }),
      ],
    });
    snsPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: STS AssumeRole (Cross-Account)
    // ========================================
    // Purpose: Assume roles in target accounts to access RDS and CloudWatch
    // Requirements: REQ-9.1 (cross-account access), REQ-6.3 (least-privilege)
    // 
    // SECURITY NOTE: This policy uses a wildcard (*) for account IDs.
    // For production deployments, replace with explicit account IDs:
    // 
    // resources: [
    //   'arn:aws:iam::111111111111:role/RDSDashboardCrossAccountRole',
    //   'arn:aws:iam::222222222222:role/RDSDashboardCrossAccountRole',
    //   'arn:aws:iam::333333333333:role/RDSDashboardCrossAccountRole',
    // ]
    // 
    // This can be configured via CDK context or environment variables.
    const stsPolicy = new iam.Policy(this, 'StsPolicy', {
      policyName: 'RDSDashboard-STS',
      statements: [
        new iam.PolicyStatement({
          sid: 'AllowAssumeRoleInTargetAccounts',
          effect: iam.Effect.ALLOW,
          actions: ['sts:AssumeRole'],
          resources: [
            // TODO: Replace wildcard with explicit account IDs for production
            // Role name must be RDSDashboardCrossAccountRole
            'arn:aws:iam::*:role/RDSDashboardCrossAccountRole',
          ],
          conditions: {
            StringEquals: {
              'sts:ExternalId': externalId,
            },
          },
        }),
      ],
    });
    stsPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: CloudWatch Metrics
    // ========================================
    // Purpose: Publish custom metrics
    const cloudWatchPolicy = new iam.Policy(this, 'CloudWatchPolicy', {
      policyName: 'RDSDashboard-CloudWatch',
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: [
            'cloudwatch:PutMetricData',
          ],
          resources: ['*'],
          conditions: {
            StringEquals: {
              'cloudwatch:namespace': 'RDSDashboard',
            },
          },
        }),
      ],
    });
    cloudWatchPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: RDS Read Access
    // ========================================
    // Purpose: Discover and describe RDS instances in current account
    // Requirements: REQ-1.1 (RDS discovery), REQ-1.2 (metadata extraction)
    const rdsPolicy = new iam.Policy(this, 'RdsPolicy', {
      policyName: 'RDSDashboard-RDS',
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: [
            'rds:DescribeDBInstances',
            'rds:DescribeDBClusters',
            'rds:ListTagsForResource',
            'rds:DescribeDBSnapshots',
            'rds:DescribeDBClusterSnapshots',
          ],
          resources: ['*'],
        }),
      ],
    });
    rdsPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Policy: RDS Operations (Write Access)
    // ========================================
    // Purpose: Execute self-service operations on RDS instances
    // Requirements: REQ-7 (Self-Service Operations), REQ-6.3 (least-privilege)
    // Security: Multi-layered protection with explicit DENY for production
    const rdsOperationsPolicy = new iam.Policy(this, 'RdsOperationsPolicy', {
      policyName: 'RDSDashboard-RDS-Operations',
      statements: [
        // EXPLICIT DENY for production instances (highest priority)
        // This ensures production instances cannot be modified even if other policies allow it
        new iam.PolicyStatement({
          sid: 'DenyProductionOperations',
          effect: iam.Effect.DENY,
          actions: [
            'rds:CreateDBSnapshot',
            'rds:CreateDBClusterSnapshot',
            'rds:RebootDBInstance',
            'rds:ModifyDBInstance',
            'rds:ModifyDBCluster',
            'rds:StartDBInstance',
            'rds:StopDBInstance',
            'rds:StartDBCluster',
            'rds:StopDBCluster',
          ],
          resources: ['*'],
          conditions: {
            StringEquals: {
              'aws:ResourceTag/Environment': ['Production', 'Prod', 'PROD', 'production', 'prod'],
            },
          },
        }),
        // ALLOW operations on non-production instances only
        new iam.PolicyStatement({
          sid: 'AllowNonProductionOperations',
          effect: iam.Effect.ALLOW,
          actions: [
            'rds:CreateDBSnapshot',
            'rds:CreateDBClusterSnapshot',
            'rds:RebootDBInstance',
            'rds:ModifyDBInstance',
            'rds:ModifyDBCluster',
            'rds:StartDBInstance',
            'rds:StopDBInstance',
            'rds:StartDBCluster',
            'rds:StopDBCluster',
          ],
          resources: ['*'],
          conditions: {
            StringNotEquals: {
              'aws:ResourceTag/Environment': ['Production', 'Prod', 'PROD', 'production', 'prod'],
            },
          },
        }),
        // Read-only operations (no restrictions needed)
        new iam.PolicyStatement({
          sid: 'AllowSnapshotDescribe',
          effect: iam.Effect.ALLOW,
          actions: [
            'rds:DescribeDBSnapshots',
            'rds:DescribeDBClusterSnapshots',
          ],
          resources: ['*'],
        }),
      ],
    });
    rdsOperationsPolicy.attachToRole(this.lambdaExecutionRole);

    // ========================================
    // Generate Cross-Account Role Template
    // ========================================
    // Purpose: CloudFormation template for target accounts to deploy
    // Requirements: REQ-9.2 (cross-account roles), REQ-9.4 (external ID)
    this.crossAccountRoleTemplate = this.generateCrossAccountRoleTemplate(externalId);

    // ========================================
    // CloudFormation Outputs
    // ========================================
    new cdk.CfnOutput(this, 'LambdaExecutionRoleArn', {
      value: this.lambdaExecutionRole.roleArn,
      description: 'ARN of Lambda execution role',
      exportName: 'LambdaExecutionRoleArn',
    });

    new cdk.CfnOutput(this, 'LambdaExecutionRoleName', {
      value: this.lambdaExecutionRole.roleName,
      description: 'Name of Lambda execution role',
      exportName: 'LambdaExecutionRoleName',
    });

    new cdk.CfnOutput(this, 'ExternalId', {
      value: externalId,
      description: 'External ID for cross-account role trust policy',
      exportName: 'ExternalId',
    });
  }

  /**
   * Generate CloudFormation template for cross-account role
   * This template should be deployed in each target account
   */
  private generateCrossAccountRoleTemplate(externalId: string): string {
    return `
AWSTemplateFormatVersion: '2010-09-09'
Description: 'RDS Dashboard Cross-Account Role - Deploy in target accounts'

Parameters:
  ManagementAccountId:
    Type: String
    Description: AWS Account ID of the management account hosting RDS Dashboard
    AllowedPattern: '^[0-9]{12}$'
  
  ExternalId:
    Type: String
    Description: External ID for secure cross-account access
    Default: '${externalId}'
    NoEcho: true

Resources:
  RDSDashboardCrossAccountRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: RDSDashboardCrossAccountRole
      Description: 'Cross-account role for RDS Dashboard to access RDS and CloudWatch'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::\${ManagementAccountId}:role/RDSDashboardLambdaRole-prod'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      ManagedPolicyArns:
        - !Ref RDSReadOnlyPolicy
        - !Ref CloudWatchReadOnlyPolicy
        - !Ref RDSWriteNonProdPolicy
      Tags:
        - Key: Project
          Value: RDSDashboard
        - Key: ManagedBy
          Value: CloudFormation

  # Policy: RDS Read-Only Access
  RDSReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: RDSDashboard-RDS-ReadOnly
      Description: 'Read-only access to RDS for discovery and monitoring'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'rds:Describe*'
              - 'rds:ListTagsForResource'
            Resource: '*'

  # Policy: CloudWatch Read-Only Access
  CloudWatchReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: RDSDashboard-CloudWatch-ReadOnly
      Description: 'Read-only access to CloudWatch metrics'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'cloudwatch:GetMetricStatistics'
              - 'cloudwatch:GetMetricData'
              - 'cloudwatch:ListMetrics'
            Resource: '*'

  # Policy: RDS Write Access (Non-Production Only)
  RDSWriteNonProdPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: RDSDashboard-RDS-WriteNonProd
      Description: 'Write access to RDS for self-service operations (non-prod only)'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'rds:CreateDBSnapshot'
              - 'rds:RebootDBInstance'
              - 'rds:ModifyDBInstance'
            Resource: '*'
            Condition:
              StringNotEquals:
                'aws:ResourceTag/Environment': 'Production'

Outputs:
  RoleArn:
    Description: ARN of the cross-account role
    Value: !GetAtt RDSDashboardCrossAccountRole.Arn
    Export:
      Name: RDSDashboardCrossAccountRoleArn
  
  RoleName:
    Description: Name of the cross-account role
    Value: !Ref RDSDashboardCrossAccountRole
    Export:
      Name: RDSDashboardCrossAccountRoleName
`;
  }
}
