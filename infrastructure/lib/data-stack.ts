/**
 * Data Stack - DynamoDB Tables and S3 Buckets
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-12-04T11:00:00Z
 * Version: 2.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-1.3, REQ-2.2, REQ-6.4, REQ-7.1, REQ-7.4, REQ-7.5 → DESIGN-001 → TASK-10.3
 * Review Status: Pending
 * Risk Level: Level 2
 * 
 * Purpose: Define DynamoDB tables for RDS inventory, metrics cache, health alerts,
 * and audit logs. Configure S3 buckets for historical data and reports.
 * 
 * Design Decisions:
 * - On-demand billing mode for cost optimization (no baseline cost, auto-scales automatically)
 * - On-demand mode provides built-in auto-scaling without configuration
 * - TTL enabled on metrics_cache for automatic expiration (5-min cache)
 * - GSIs for efficient querying patterns
 * - Point-in-time recovery enabled for data protection (35-day retention)
 * - Encryption enabled with AWS managed keys
 * 
 * Auto-Scaling Notes:
 * - PAY_PER_REQUEST (on-demand) mode automatically scales to handle traffic
 * - No need to configure read/write capacity units or auto-scaling policies
 * - Handles up to 40,000 read/write requests per second per table
 * - For predictable workloads, consider switching to PROVISIONED mode with auto-scaling
 */

import * as cdk from 'aws-cdk-lib';
import * as dynamodb from 'aws-cdk-lib/aws-dynamodb';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as kms from 'aws-cdk-lib/aws-kms';
import { Tags } from 'aws-cdk-lib';
import { Construct } from 'constructs';

export interface DataStackProps extends cdk.StackProps {
  // No environment parameter needed for centralized deployment
}

export class DataStack extends cdk.Stack {
  public readonly rdsInventoryTable: dynamodb.Table;
  public readonly metricsCacheTable: dynamodb.Table;
  public readonly healthAlertsTable: dynamodb.Table;
  public readonly auditLogTable: dynamodb.Table;
  public readonly costSnapshotsTable: dynamodb.Table;
  public readonly approvalsTable: dynamodb.Table;
  public readonly onboardingStateTable: dynamodb.Table;
  public readonly onboardingAuditLogTable: dynamodb.Table;
  public readonly externalIdKmsKey: kms.Key;
  public readonly dataBucket: s3.Bucket;

  constructor(scope: Construct, id: string, props: DataStackProps) {
    super(scope, id, props);

    // ========================================
    // DynamoDB Table: rds_inventory
    // ========================================
    // Purpose: Store RDS instance metadata and current status
    // Requirements: REQ-1.3 (inventory storage), REQ-7.1 (PITR)
    this.rdsInventoryTable = new dynamodb.Table(this, 'RdsInventoryTable', {
      tableName: 'rds-inventory',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enabled for data protection (35-day retention)
      removalPolicy: cdk.RemovalPolicy.RETAIN, // Prevent accidental deletion
    });

    Tags.of(this.rdsInventoryTable).add('Project', 'RDSDashboard');
    Tags.of(this.rdsInventoryTable).add('CostCenter', 'DBA-Team');

    // GSI: Query instances by account and region
    // Use case: Filter dashboard by account/region
    this.rdsInventoryTable.addGlobalSecondaryIndex({
      indexName: 'account-region-index',
      partitionKey: {
        name: 'account_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'region',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: metrics_cache
    // ========================================
    // Purpose: Cache CloudWatch metrics to reduce API calls and data transfer
    // Requirements: REQ-2.2 (metric caching), REQ-8.2 (cost optimization)
    this.metricsCacheTable = new dynamodb.Table(this, 'MetricsCacheTable', {
      tableName: 'metrics-cache',
      partitionKey: {
        name: 'cache_key',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      timeToLiveAttribute: 'ttl', // Enable TTL for automatic expiration
      pointInTimeRecovery: false,
      removalPolicy: cdk.RemovalPolicy.DESTROY, // Cache data is ephemeral
    });

    Tags.of(this.metricsCacheTable).add('Project', 'RDSDashboard');
    Tags.of(this.metricsCacheTable).add('CostCenter', 'DBA-Team');

    // ========================================
    // DynamoDB Table: health_alerts
    // ========================================
    // Purpose: Store active health and compliance alerts
    // Requirements: REQ-2.2 (alerting), REQ-6.4 (compliance violations), REQ-7.1 (PITR)
    this.healthAlertsTable = new dynamodb.Table(this, 'HealthAlertsTable', {
      tableName: 'health-alerts',
      partitionKey: {
        name: 'alert_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'created_at',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enabled for data protection (35-day retention)
      removalPolicy: cdk.RemovalPolicy.RETAIN,
    });

    Tags.of(this.healthAlertsTable).add('Project', 'RDSDashboard');
    Tags.of(this.healthAlertsTable).add('CostCenter', 'DBA-Team');

    // GSI: Query active alerts for a specific instance
    // Use case: Display alerts on instance detail page
    this.healthAlertsTable.addGlobalSecondaryIndex({
      indexName: 'instance-status-index',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'status',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: audit_log
    // ========================================
    // Purpose: Track all operations executed through the system
    // Requirements: REQ-7.5 (audit logging)
    this.auditLogTable = new dynamodb.Table(this, 'AuditLogTable', {
      tableName: 'audit-log',
      partitionKey: {
        name: 'operation_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'timestamp',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enable for audit compliance
      removalPolicy: cdk.RemovalPolicy.RETAIN,
    });

    Tags.of(this.auditLogTable).add('Project', 'RDSDashboard');
    Tags.of(this.auditLogTable).add('CostCenter', 'DBA-Team');

    // GSI: Query operation history for a specific instance
    // Use case: Display operation history on instance detail page
    this.auditLogTable.addGlobalSecondaryIndex({
      indexName: 'instance-timestamp-index',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'timestamp',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: cost_snapshots
    // ========================================
    // Purpose: Store daily cost snapshots for trend tracking
    // Requirements: REQ-4.2, REQ-4.5 (cost trend tracking), REQ-7.1 (PITR)
    this.costSnapshotsTable = new dynamodb.Table(this, 'CostSnapshotsTable', {
      tableName: 'cost-snapshots',
      partitionKey: {
        name: 'snapshot_date',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enabled for data protection (35-day retention)
      removalPolicy: cdk.RemovalPolicy.RETAIN,
    });

    Tags.of(this.costSnapshotsTable).add('Project', 'RDSDashboard');
    Tags.of(this.costSnapshotsTable).add('CostCenter', 'DBA-Team');

    // ========================================
    // DynamoDB Table: approvals
    // ========================================
    // Purpose: Store approval workflow requests for high-risk operations
    // Requirements: REQ-APPROVAL (Operations Approval Workflow)
    this.approvalsTable = new dynamodb.Table(this, 'ApprovalsTable', {
      tableName: 'rds-approvals',
      partitionKey: {
        name: 'request_id',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enable for audit compliance
      removalPolicy: cdk.RemovalPolicy.RETAIN,
    });

    Tags.of(this.approvalsTable).add('Project', 'RDSDashboard');
    Tags.of(this.approvalsTable).add('CostCenter', 'DBA-Team');

    // GSI: Query approvals by status
    // Use case: Get all pending approvals
    this.approvalsTable.addGlobalSecondaryIndex({
      indexName: 'status-index',
      partitionKey: {
        name: 'status',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'requested_at',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // GSI: Query approvals by requester
    // Use case: Get all requests by a specific user
    this.approvalsTable.addGlobalSecondaryIndex({
      indexName: 'requester-index',
      partitionKey: {
        name: 'requested_by',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'requested_at',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // GSI: Query approvals by instance
    // Use case: Get all approval requests for a specific instance
    this.approvalsTable.addGlobalSecondaryIndex({
      indexName: 'instance-index',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'requested_at',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: onboarding_state
    // ========================================
    // Purpose: Store account onboarding state and metadata
    // Requirements: REQ-1.3 (account metadata storage), REQ-3.1 (approval workflow), REQ-4.1 (audit logging)
    this.onboardingStateTable = new dynamodb.Table(this, 'OnboardingStateTable', {
      tableName: 'rds-dashboard-onboarding-state',
      partitionKey: {
        name: 'account_id',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enable for audit compliance
      removalPolicy: cdk.RemovalPolicy.RETAIN,
      timeToLiveAttribute: 'ttl', // Enable TTL for rejected/failed requests (90 days)
    });

    Tags.of(this.onboardingStateTable).add('Project', 'RDSDashboard');
    Tags.of(this.onboardingStateTable).add('CostCenter', 'DBA-Team');
    Tags.of(this.onboardingStateTable).add('Feature', 'AutomatedOnboarding');

    // GSI: Query accounts by status
    // Use case: Get all pending/provisioning/failed accounts
    this.onboardingStateTable.addGlobalSecondaryIndex({
      indexName: 'status-index',
      partitionKey: {
        name: 'status',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'created_at',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // GSI: Query accounts by organizational unit
    // Use case: Get all accounts in a specific OU
    this.onboardingStateTable.addGlobalSecondaryIndex({
      indexName: 'ou-index',
      partitionKey: {
        name: 'organizational_unit',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'created_at',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: onboarding_audit_log
    // ========================================
    // Purpose: Track all account onboarding activities
    // Requirements: REQ-4.1, REQ-4.2, REQ-4.3, REQ-4.4 (audit logging)
    this.onboardingAuditLogTable = new dynamodb.Table(this, 'OnboardingAuditLogTable', {
      tableName: 'rds-dashboard-onboarding-audit',
      partitionKey: {
        name: 'account_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'timestamp',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enable for audit compliance
      removalPolicy: cdk.RemovalPolicy.RETAIN,
      stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES, // Enable streams for real-time processing
    });

    Tags.of(this.onboardingAuditLogTable).add('Project', 'RDSDashboard');
    Tags.of(this.onboardingAuditLogTable).add('CostCenter', 'DBA-Team');
    Tags.of(this.onboardingAuditLogTable).add('Feature', 'AutomatedOnboarding');

    // ========================================
    // KMS Key: External ID Encryption
    // ========================================
    // Purpose: Encrypt external IDs for cross-account role trust policies
    // Requirements: REQ-9.2 (external ID encryption)
    this.externalIdKmsKey = new kms.Key(this, 'ExternalIdKmsKey', {
      description: 'KMS key for encrypting external IDs used in cross-account roles',
      enableKeyRotation: true, // Enable automatic key rotation (annual)
      removalPolicy: cdk.RemovalPolicy.RETAIN, // Prevent accidental deletion
      alias: 'rds-dashboard/external-id-encryption',
    });

    Tags.of(this.externalIdKmsKey).add('Project', 'RDSDashboard');
    Tags.of(this.externalIdKmsKey).add('CostCenter', 'DBA-Team');
    Tags.of(this.externalIdKmsKey).add('Feature', 'AutomatedOnboarding');

    // ========================================
    // S3 Bucket: Data Storage
    // ========================================
    // Purpose: Store historical metrics, compliance reports, cost reports, CloudOps requests
    // Requirements: REQ-1.3 (data storage), REQ-4.2 (cost reports), REQ-6.4 (compliance reports)
    this.dataBucket = new s3.Bucket(this, 'DataBucket', {
      bucketName: `rds-dashboard-data-${this.account}`,
      versioned: true, // Enable versioning for data protection
      encryption: s3.BucketEncryption.S3_MANAGED, // SSE-S3 encryption
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL, // Security best practice
      enforceSSL: true, // Require HTTPS
      removalPolicy: cdk.RemovalPolicy.RETAIN, // Prevent accidental deletion
      autoDeleteObjects: false,
      lifecycleRules: [
        {
          id: 'delete-historical-metrics',
          prefix: 'historical-metrics/',
          enabled: true,
          expiration: cdk.Duration.days(7), // 7-day retention for metrics
        },
        {
          id: 'glacier-compliance-reports',
          prefix: 'compliance-reports/',
          enabled: true,
          transitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: cdk.Duration.days(90), // Move to Glacier after 90 days
            },
          ],
        },
        {
          id: 'glacier-cost-reports',
          prefix: 'cost-reports/',
          enabled: true,
          transitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: cdk.Duration.days(90),
            },
          ],
        },
        {
          id: 'delete-cloudops-requests',
          prefix: 'cloudops-requests/',
          enabled: true,
          expiration: cdk.Duration.days(365), // 1-year retention
        },
      ],
    });

    Tags.of(this.dataBucket).add('Project', 'RDSDashboard');
    Tags.of(this.dataBucket).add('CostCenter', 'DBA-Team');

    // ========================================
    // CloudFormation Outputs
    // ========================================
    new cdk.CfnOutput(this, 'RdsInventoryTableName', {
      value: this.rdsInventoryTable.tableName,
      description: 'DynamoDB table for RDS inventory',
      exportName: 'RdsInventoryTableName',
    });

    new cdk.CfnOutput(this, 'MetricsCacheTableName', {
      value: this.metricsCacheTable.tableName,
      description: 'DynamoDB table for metrics cache',
      exportName: 'MetricsCacheTableName',
    });

    new cdk.CfnOutput(this, 'HealthAlertsTableName', {
      value: this.healthAlertsTable.tableName,
      description: 'DynamoDB table for health alerts',
      exportName: 'HealthAlertsTableName',
    });

    new cdk.CfnOutput(this, 'AuditLogTableName', {
      value: this.auditLogTable.tableName,
      description: 'DynamoDB table for audit logs',
      exportName: 'AuditLogTableName',
    });

    new cdk.CfnOutput(this, 'CostSnapshotsTableName', {
      value: this.costSnapshotsTable.tableName,
      description: 'DynamoDB table for cost snapshots',
      exportName: 'CostSnapshotsTableName',
    });

    new cdk.CfnOutput(this, 'DataBucketName', {
      value: this.dataBucket.bucketName,
      description: 'S3 bucket for historical data and reports',
      exportName: 'DataBucketName',
    });

    new cdk.CfnOutput(this, 'DataBucketArn', {
      value: this.dataBucket.bucketArn,
      description: 'S3 bucket ARN',
      exportName: 'DataBucketArn',
    });

    new cdk.CfnOutput(this, 'OnboardingStateTableName', {
      value: this.onboardingStateTable.tableName,
      description: 'DynamoDB table for account onboarding state',
      exportName: 'OnboardingStateTableName',
    });

    new cdk.CfnOutput(this, 'OnboardingAuditLogTableName', {
      value: this.onboardingAuditLogTable.tableName,
      description: 'DynamoDB table for onboarding audit logs',
      exportName: 'OnboardingAuditLogTableName',
    });

    new cdk.CfnOutput(this, 'ExternalIdKmsKeyId', {
      value: this.externalIdKmsKey.keyId,
      description: 'KMS key ID for external ID encryption',
      exportName: 'ExternalIdKmsKeyId',
    });

    new cdk.CfnOutput(this, 'ExternalIdKmsKeyArn', {
      value: this.externalIdKmsKey.keyArn,
      description: 'KMS key ARN for external ID encryption',
      exportName: 'ExternalIdKmsKeyArn',
    });
  }
}
