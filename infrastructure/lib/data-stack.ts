/**
 * Data Stack - DynamoDB Tables and S3 Buckets
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-11-12T17:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-1.3, REQ-2.2, REQ-6.4, REQ-7.5 → DESIGN-001 → TASK-1.1
 * Review Status: Pending
 * Risk Level: Level 2
 * 
 * Purpose: Define DynamoDB tables for RDS inventory, metrics cache, health alerts,
 * and audit logs. Configure S3 buckets for historical data and reports.
 * 
 * Design Decisions:
 * - On-demand billing mode for cost optimization (no baseline cost)
 * - TTL enabled on metrics_cache for automatic expiration (5-min cache)
 * - GSIs for efficient querying patterns
 * - Point-in-time recovery disabled to reduce costs (can enable for production)
 * - Encryption enabled with AWS managed keys
 */

import * as cdk from 'aws-cdk-lib';
import * as dynamodb from 'aws-cdk-lib/aws-dynamodb';
import * as s3 from 'aws-cdk-lib/aws-s3';
import { Construct } from 'constructs';

export interface DataStackProps extends cdk.StackProps {
  readonly environment: string;
}

export class DataStack extends cdk.Stack {
  public readonly rdsInventoryTable: dynamodb.Table;
  public readonly metricsCacheTable: dynamodb.Table;
  public readonly healthAlertsTable: dynamodb.Table;
  public readonly auditLogTable: dynamodb.Table;
  public readonly costSnapshotsTable: dynamodb.Table;
  public readonly dataBucket: s3.Bucket;

  constructor(scope: Construct, id: string, props: DataStackProps) {
    super(scope, id, props);

    const { environment } = props;

    // ========================================
    // DynamoDB Table: rds_inventory
    // ========================================
    // Purpose: Store RDS instance metadata and current status
    // Requirements: REQ-1.3 (inventory storage)
    this.rdsInventoryTable = new dynamodb.Table(this, 'RdsInventoryTable', {
      tableName: `rds-inventory-${environment}`,
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.ON_DEMAND,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: false, // Disabled for cost optimization
      removalPolicy: cdk.RemovalPolicy.RETAIN, // Prevent accidental deletion
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // GSI: Query instances by account and region
    // Use case: Filter dashboard by account/region
    this.rdsInventoryTable.addGlobalSecondaryIndex({
      indexName: 'account-region-index',
      partitionKey: {
        name: 'account_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'region',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: metrics_cache
    // ========================================
    // Purpose: Cache CloudWatch metrics to reduce API calls and data transfer
    // Requirements: REQ-2.2 (metric caching), REQ-8.2 (cost optimization)
    this.metricsCacheTable = new dynamodb.Table(this, 'MetricsCacheTable', {
      tableName: `metrics-cache-${environment}`,
      partitionKey: {
        name: 'cache_key',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.ON_DEMAND,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      timeToLiveAttribute: 'ttl', // Enable TTL for automatic expiration
      pointInTimeRecovery: false,
      removalPolicy: cdk.RemovalPolicy.DESTROY, // Cache data is ephemeral
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // ========================================
    // DynamoDB Table: health_alerts
    // ========================================
    // Purpose: Store active health and compliance alerts
    // Requirements: REQ-2.2 (alerting), REQ-6.4 (compliance violations)
    this.healthAlertsTable = new dynamodb.Table(this, 'HealthAlertsTable', {
      tableName: `health-alerts-${environment}`,
      partitionKey: {
        name: 'alert_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'created_at',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.ON_DEMAND,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: false,
      removalPolicy: cdk.RemovalPolicy.RETAIN,
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // GSI: Query active alerts for a specific instance
    // Use case: Display alerts on instance detail page
    this.healthAlertsTable.addGlobalSecondaryIndex({
      indexName: 'instance-status-index',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'status',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: audit_log
    // ========================================
    // Purpose: Track all operations executed through the system
    // Requirements: REQ-7.5 (audit logging)
    this.auditLogTable = new dynamodb.Table(this, 'AuditLogTable', {
      tableName: `audit-log-${environment}`,
      partitionKey: {
        name: 'operation_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'timestamp',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.ON_DEMAND,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: true, // Enable for audit compliance
      removalPolicy: cdk.RemovalPolicy.RETAIN,
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // GSI: Query operation history for a specific instance
    // Use case: Display operation history on instance detail page
    this.auditLogTable.addGlobalSecondaryIndex({
      indexName: 'instance-timestamp-index',
      partitionKey: {
        name: 'instance_id',
        type: dynamodb.AttributeType.STRING,
      },
      sortKey: {
        name: 'timestamp',
        type: dynamodb.AttributeType.STRING,
      },
      projectionType: dynamodb.ProjectionType.ALL,
    });

    // ========================================
    // DynamoDB Table: cost_snapshots
    // ========================================
    // Purpose: Store daily cost snapshots for trend tracking
    // Requirements: REQ-4.2, REQ-4.5 (cost trend tracking)
    this.costSnapshotsTable = new dynamodb.Table(this, 'CostSnapshotsTable', {
      tableName: `cost-snapshots-${environment}`,
      partitionKey: {
        name: 'snapshot_date',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.ON_DEMAND,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      pointInTimeRecovery: false,
      removalPolicy: cdk.RemovalPolicy.RETAIN,
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // ========================================
    // S3 Bucket: Data Storage
    // ========================================
    // Purpose: Store historical metrics, compliance reports, cost reports, CloudOps requests
    // Requirements: REQ-1.3 (data storage), REQ-4.2 (cost reports), REQ-6.4 (compliance reports)
    this.dataBucket = new s3.Bucket(this, 'DataBucket', {
      bucketName: `rds-dashboard-data-${this.account}-${environment}`,
      versioning: true, // Enable versioning for data protection
      encryption: s3.BucketEncryption.S3_MANAGED, // SSE-S3 encryption
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL, // Security best practice
      enforceSSL: true, // Require HTTPS
      removalPolicy: cdk.RemovalPolicy.RETAIN, // Prevent accidental deletion
      autoDeleteObjects: false,
      lifecycleRules: [
        {
          id: 'delete-historical-metrics',
          prefix: 'historical-metrics/',
          enabled: true,
          expiration: cdk.Duration.days(7), // 7-day retention for metrics
        },
        {
          id: 'glacier-compliance-reports',
          prefix: 'compliance-reports/',
          enabled: true,
          transitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: cdk.Duration.days(90), // Move to Glacier after 90 days
            },
          ],
        },
        {
          id: 'glacier-cost-reports',
          prefix: 'cost-reports/',
          enabled: true,
          transitions: [
            {
              storageClass: s3.StorageClass.GLACIER,
              transitionAfter: cdk.Duration.days(90),
            },
          ],
        },
        {
          id: 'delete-cloudops-requests',
          prefix: 'cloudops-requests/',
          enabled: true,
          expiration: cdk.Duration.days(365), // 1-year retention
        },
      ],
      tags: [
        { key: 'Project', value: 'RDSDashboard' },
        { key: 'Environment', value: environment },
        { key: 'CostCenter', value: 'DBA-Team' },
      ],
    });

    // ========================================
    // CloudFormation Outputs
    // ========================================
    new cdk.CfnOutput(this, 'RdsInventoryTableName', {
      value: this.rdsInventoryTable.tableName,
      description: 'DynamoDB table for RDS inventory',
      exportName: `${environment}-RdsInventoryTableName`,
    });

    new cdk.CfnOutput(this, 'MetricsCacheTableName', {
      value: this.metricsCacheTable.tableName,
      description: 'DynamoDB table for metrics cache',
      exportName: `${environment}-MetricsCacheTableName`,
    });

    new cdk.CfnOutput(this, 'HealthAlertsTableName', {
      value: this.healthAlertsTable.tableName,
      description: 'DynamoDB table for health alerts',
      exportName: `${environment}-HealthAlertsTableName`,
    });

    new cdk.CfnOutput(this, 'AuditLogTableName', {
      value: this.auditLogTable.tableName,
      description: 'DynamoDB table for audit logs',
      exportName: `${environment}-AuditLogTableName`,
    });

    new cdk.CfnOutput(this, 'CostSnapshotsTableName', {
      value: this.costSnapshotsTable.tableName,
      description: 'DynamoDB table for cost snapshots',
      exportName: `${environment}-CostSnapshotsTableName`,
    });

    new cdk.CfnOutput(this, 'DataBucketName', {
      value: this.dataBucket.bucketName,
      description: 'S3 bucket for historical data and reports',
      exportName: `${environment}-DataBucketName`,
    });

    new cdk.CfnOutput(this, 'DataBucketArn', {
      value: this.dataBucket.bucketArn,
      description: 'S3 bucket ARN',
      exportName: `${environment}-DataBucketArn`,
    });
  }
}
