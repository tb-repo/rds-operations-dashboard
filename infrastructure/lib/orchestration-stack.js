"use strict";
/**
 * Orchestration Stack - EventBridge Scheduled Rules
 *
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-11-12T20:45:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-1.1, REQ-2.1, REQ-4.1, REQ-6.1 → DESIGN-001 → TASK-9
 * Review Status: Pending
 * Risk Level: Level 2
 *
 * Purpose: Define EventBridge scheduled rules to automate Lambda function execution.
 * Implements hourly discovery, 5-minute health checks, and daily analysis tasks.
 *
 * Design Decisions:
 * - Hourly discovery to catch new/changed instances
 * - 5-minute health monitoring for timely alerts
 * - Daily compliance and cost analysis (off-peak hours)
 * - Configurable schedules via config file
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.OrchestrationStack = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const events = __importStar(require("aws-cdk-lib/aws-events"));
const targets = __importStar(require("aws-cdk-lib/aws-events-targets"));
class OrchestrationStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const { discoveryFunction, healthMonitorFunction, costAnalyzerFunction, complianceCheckerFunction, discoverySchedule, healthMonitorSchedule } = props;
        // ========================================
        // EventBridge Rule: RDS Discovery (Hourly)
        // ========================================
        // Purpose: Automatically discover RDS instances across accounts/regions
        // Requirements: REQ-1.1 (automated discovery)
        this.discoveryRule = new events.Rule(this, 'DiscoveryScheduleRule', {
            ruleName: 'rds-discovery-schedule',
            description: 'Triggers RDS discovery Lambda function hourly',
            schedule: events.Schedule.expression(discoverySchedule),
            enabled: true,
        });
        // Add discovery Lambda as target
        this.discoveryRule.addTarget(new targets.LambdaFunction(discoveryFunction, {
            retryAttempts: 2,
            maxEventAge: cdk.Duration.hours(2),
        }));
        // ========================================
        // EventBridge Rule: Health Monitor (Every 5 minutes)
        // ========================================
        // Purpose: Monitor RDS health metrics and generate alerts
        // Requirements: REQ-2.1 (health monitoring)
        if (healthMonitorFunction) {
            this.healthMonitorRule = new events.Rule(this, 'HealthMonitorScheduleRule', {
                ruleName: 'rds-health-monitor-schedule',
                description: 'Triggers RDS health monitor Lambda function every 5 minutes',
                schedule: events.Schedule.expression(healthMonitorSchedule),
                enabled: true,
            });
            // Add health monitor Lambda as target
            this.healthMonitorRule.addTarget(new targets.LambdaFunction(healthMonitorFunction, {
                retryAttempts: 2,
                maxEventAge: cdk.Duration.minutes(30),
            }));
        }
        // ========================================
        // EventBridge Rule: Compliance Checker (Daily at 02:00 SGT)
        // ========================================
        // Purpose: Check RDS compliance daily
        // Requirements: REQ-6.1 (compliance checking)
        if (complianceCheckerFunction) {
            const complianceRule = new events.Rule(this, 'ComplianceScheduleRule', {
                ruleName: 'rds-compliance-schedule',
                description: 'Triggers RDS compliance checker Lambda function daily at 02:00 SGT',
                schedule: events.Schedule.cron({
                    minute: '0',
                    hour: '18', // 02:00 SGT = 18:00 UTC (UTC+8)
                    day: '*',
                    month: '*',
                    year: '*',
                }),
                enabled: true,
            });
            complianceRule.addTarget(new targets.LambdaFunction(complianceCheckerFunction, {
                retryAttempts: 2,
                maxEventAge: cdk.Duration.hours(6),
            }));
        }
        // ========================================
        // EventBridge Rule: Cost Analyzer (Daily at 03:00 SGT)
        // ========================================
        // Purpose: Analyze RDS costs daily
        // Requirements: REQ-4.1 (cost analysis)
        if (costAnalyzerFunction) {
            const costAnalyzerRule = new events.Rule(this, 'CostAnalyzerScheduleRule', {
                ruleName: 'rds-cost-analyzer-schedule',
                description: 'Triggers RDS cost analyzer Lambda function daily at 03:00 SGT',
                schedule: events.Schedule.cron({
                    minute: '0',
                    hour: '19', // 03:00 SGT = 19:00 UTC (UTC+8)
                    day: '*',
                    month: '*',
                    year: '*',
                }),
                enabled: true,
            });
            costAnalyzerRule.addTarget(new targets.LambdaFunction(costAnalyzerFunction, {
                retryAttempts: 2,
                maxEventAge: cdk.Duration.hours(6),
            }));
        }
        // ========================================
        // CloudFormation Outputs
        // ========================================
        new cdk.CfnOutput(this, 'DiscoveryRuleName', {
            value: this.discoveryRule.ruleName,
            description: 'EventBridge rule name for RDS discovery',
            exportName: 'DiscoveryRuleName',
        });
        if (this.healthMonitorRule) {
            new cdk.CfnOutput(this, 'HealthMonitorRuleName', {
                value: this.healthMonitorRule.ruleName,
                description: 'EventBridge rule name for health monitoring',
                exportName: 'HealthMonitorRuleName',
            });
        }
        // Add tags
        cdk.Tags.of(this).add('Component', 'Orchestration');
    }
}
exports.OrchestrationStack = OrchestrationStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JjaGVzdHJhdGlvbi1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm9yY2hlc3RyYXRpb24tc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCxpREFBbUM7QUFDbkMsK0RBQWlEO0FBQ2pELHdFQUEwRDtBQWExRCxNQUFhLGtCQUFtQixTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBSS9DLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBOEI7UUFDdEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSxFQUFFLGlCQUFpQixFQUFFLHFCQUFxQixFQUN4QyxvQkFBb0IsRUFBRSx5QkFBeUIsRUFDL0MsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFFM0QsMkNBQTJDO1FBQzNDLDJDQUEyQztRQUMzQywyQ0FBMkM7UUFDM0Msd0VBQXdFO1FBQ3hFLDhDQUE4QztRQUM5QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLEVBQUU7WUFDbEUsUUFBUSxFQUFFLHdCQUF3QjtZQUNsQyxXQUFXLEVBQUUsK0NBQStDO1lBQzVELFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQztZQUN2RCxPQUFPLEVBQUUsSUFBSTtTQUNkLENBQUMsQ0FBQztRQUVILGlDQUFpQztRQUNqQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxjQUFjLENBQUMsaUJBQWlCLEVBQUU7WUFDekUsYUFBYSxFQUFFLENBQUM7WUFDaEIsV0FBVyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNu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LEVBQUU7WUFDM0MsS0FBSyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUTtZQUNsQyxXQUFXLEVBQUUseUNBQXlDO1lBQ3RELFVBQVUsRUFBRSxtQkFBbUI7U0FDaEMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUMzQixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLHVCQUF1QixFQUFFO2dCQUMvQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVE7Z0JBQ3RDLFdBQVcsRUFBRSw2Q0FBNkM7Z0JBQzFELFVBQVUsRUFBRSx1QkFBdUI7YUFDcEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELFdBQVc7UUFDWCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Q0FDRjtBQXZIRCxnREF1SEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogT3JjaGVzdHJhdGlvbiBTdGFjayAtIEV2ZW50QnJpZGdlIFNjaGVkdWxlZCBSdWxlc1xyXG4gKiBcclxuICogR2VuZXJhdGVkIGJ5OiBjbGF1ZGUtMy41LXNvbm5ldFxyXG4gKiBUaW1lc3RhbXA6IDIwMjUtMTEtMTJUMjA6NDU6MDBaXHJcbiAqIFZlcnNpb246IDEuMC4wXHJcbiAqIFBvbGljeSBWZXJzaW9uOiB2MS4wLjBcclxuICogVHJhY2VhYmlsaXR5OiBSRVEtMS4xLCBSRVEtMi4xLCBSRVEtNC4xLCBSRVEtNi4xIOKGkiBERVNJR04tMDAxIOKGkiBUQVNLLTlcclxuICogUmV2aWV3IFN0YXR1czogUGVuZGluZ1xyXG4gKiBSaXNrIExldmVsOiBMZXZlbCAyXHJcbiAqIFxyXG4gKiBQdXJwb3NlOiBEZWZpbmUgRXZlbnRCcmlkZ2Ugc2NoZWR1bGVkIHJ1bGVzIHRvIGF1dG9tYXRlIExhbWJkYSBmdW5jdGlvbiBleGVjdXRpb24uXHJcbiAqIEltcGxlbWVudHMgaG91cmx5IGRpc2NvdmVyeSwgNS1taW51dGUgaGVhbHRoIGNoZWNrcywgYW5kIGRhaWx5IGFuYWx5c2lzIHRhc2tzLlxyXG4gKiBcclxuICogRGVzaWduIERlY2lzaW9uczpcclxuICogLSBIb3VybHkgZGlzY292ZXJ5IHRvIGNhdGNoIG5ldy9jaGFuZ2VkIGluc3RhbmNlc1xyXG4gKiAtIDUtbWludXRlIGhlYWx0aCBtb25pdG9yaW5nIGZvciB0aW1lbHkgYWxlcnRzXHJcbiAqIC0gRGFpbHkgY29tcGxpYW5jZSBhbmQgY29zdCBhbmFseXNpcyAob2ZmLXBlYWsgaG91cnMpXHJcbiAqIC0gQ29uZmlndXJhYmxlIHNjaGVkdWxlcyB2aWEgY29uZmlnIGZpbGVcclxuICovXHJcblxyXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xyXG5pbXBvcnQgKiBhcyBldmVudHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cyc7XHJcbmltcG9ydCAqIGFzIHRhcmdldHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzJztcclxuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgT3JjaGVzdHJhdGlvblN0YWNrUHJvcHMgZXh0ZW5kcyBjZGsuU3RhY2tQcm9wcyB7XHJcbiAgcmVhZG9ubHkgZGlzY292ZXJ5RnVuY3Rpb246IGxhbWJkYS5JRnVuY3Rpb247XHJcbiAgcmVhZG9ubHkgaGVhbHRoTW9uaXRvckZ1bmN0aW9uPzogbGFtYmRhLklGdW5jdGlvbjtcclxuICByZWFkb25seSBjb3N0QW5hbHl6ZXJGdW5jdGlvbj86IGxhbWJkYS5JRnVuY3Rpb247XHJcbiAgcmVhZG9ubHkgY29tcGxpYW5jZUNoZWNrZXJGdW5jdGlvbj86IGxhbWJkYS5JRnVuY3Rpb247XHJcbiAgcmVhZG9ubHkgZGlzY292ZXJ5U2NoZWR1bGU6IHN0cmluZztcclxuICByZWFkb25seSBoZWFsdGhNb25pdG9yU2NoZWR1bGU6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE9yY2hlc3RyYXRpb25TdGFjayBleHRlbmRzIGNkay5TdGFjayB7XHJcbiAgcHVibGljIHJlYWRvbmx5IGRpc2NvdmVyeVJ1bGU6IGV2ZW50cy5SdWxlO1xyXG4gIHB1YmxpYyByZWFkb25seSBoZWFsdGhNb25pdG9yUnVsZT86IGV2ZW50cy5SdWxlO1xyXG5cclxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogT3JjaGVzdHJhdGlvblN0YWNrUHJvcHMpIHtcclxuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xyXG5cclxuICAgIGNvbnN0IHsgZGlzY292ZXJ5RnVuY3Rpb24sIGhlYWx0aE1vbml0b3JGdW5jdGlvbixcclxuICAgICAgICAgICAgY29zdEFuYWx5emVyRnVuY3Rpb24sIGNvbXBsaWFuY2VDaGVja2VyRnVuY3Rpb24sXHJcbiAgICAgICAgICAgIGRpc2NvdmVyeVNjaGVkdWxlLCBoZWFsdGhNb25pdG9yU2NoZWR1bGUgfSA9IHByb3BzO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIEV2ZW50QnJpZGdlIFJ1bGU6IFJEUyBEaXNjb3ZlcnkgKEhvdXJseSlcclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIFB1cnBvc2U6IEF1dG9tYXRpY2FsbHkgZGlzY292ZXIgUkRTIGluc3RhbmNlcyBhY3Jvc3MgYWNjb3VudHMvcmVnaW9uc1xyXG4gICAgLy8gUmVxdWlyZW1lbnRzOiBSRVEtMS4xIChhdXRvbWF0ZWQgZGlzY292ZXJ5KVxyXG4gICAgdGhpcy5kaXNjb3ZlcnlSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdEaXNjb3ZlcnlTY2hlZHVsZVJ1bGUnLCB7XHJcbiAgICAgIHJ1bGVOYW1lOiAncmRzLWRpc2NvdmVyeS1zY2hlZHVsZScsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiAnVHJpZ2dlcnMgUkRTIGRpc2NvdmVyeSBMYW1iZGEgZnVuY3Rpb24gaG91cmx5JyxcclxuICAgICAgc2NoZWR1bGU6IGV2ZW50cy5TY2hlZHVsZS5leHByZXNzaW9uKGRpc2NvdmVyeVNjaGVkdWxlKSxcclxuICAgICAgZW5hYmxlZDogdHJ1ZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFkZCBkaXNjb3ZlcnkgTGFtYmRhIGFzIHRhcmdldFxyXG4gICAgdGhpcy5kaXNjb3ZlcnlSdWxlLmFkZFRhcmdldChuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihkaXNjb3ZlcnlGdW5jdGlvbiwge1xyXG4gICAgICByZXRyeUF0dGVtcHRzOiAyLFxyXG4gICAgICBtYXhFdmVudEFnZTogY2RrLkR1cmF0aW9uLmhvdXJzKDIpLFxyXG4gICAgfSkpO1xyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIEV2ZW50QnJpZGdlIFJ1bGU6IEhlYWx0aCBNb25pdG9yIChFdmVyeSA1IG1pbnV0ZXMpXHJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgICAvLyBQdXJwb3NlOiBNb25pdG9yIFJEUyBoZWFsdGggbWV0cmljcyBhbmQgZ2VuZXJhdGUgYWxlcnRzXHJcbiAgICAvLyBSZXF1aXJlbWVudHM6IFJFUS0yLjEgKGhlYWx0aCBtb25pdG9yaW5nKVxyXG4gICAgaWYgKGhlYWx0aE1vbml0b3JGdW5jdGlvbikge1xyXG4gICAgICB0aGlzLmhlYWx0aE1vbml0b3JSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdIZWFsdGhNb25pdG9yU2NoZWR1bGVSdWxlJywge1xyXG4gICAgICAgIHJ1bGVOYW1lOiAncmRzLWhlYWx0aC1tb25pdG9yLXNjaGVkdWxlJyxcclxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RyaWdnZXJzIFJEUyBoZWFsdGggbW9uaXRvciBMYW1iZGEgZnVuY3Rpb24gZXZlcnkgNSBtaW51dGVzJyxcclxuICAgICAgICBzY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlLmV4cHJlc3Npb24oaGVhbHRoTW9uaXRvclNjaGVkdWxlKSxcclxuICAgICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIEFkZCBoZWFsdGggbW9uaXRvciBMYW1iZGEgYXMgdGFyZ2V0XHJcbiAgICAgIHRoaXMuaGVhbHRoTW9uaXRvclJ1bGUuYWRkVGFyZ2V0KG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGhlYWx0aE1vbml0b3JGdW5jdGlvbiwge1xyXG4gICAgICAgIHJldHJ5QXR0ZW1wdHM6IDIsXHJcbiAgICAgICAgbWF4RXZlbnRBZ2U6IGNkay5EdXJhdGlvbi5taW51dGVzKDMwKSxcclxuICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuICAgIC8vIEV2ZW50QnJpZGdlIFJ1bGU6IENvbXBsaWFuY2UgQ2hlY2tlciAoRGFpbHkgYXQgMDI6MDAgU0dUKVxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gUHVycG9zZTogQ2hlY2sgUkRTIGNvbXBsaWFuY2UgZGFpbHlcclxuICAgIC8vIFJlcXVpcmVtZW50czogUkVRLTYuMSAoY29tcGxpYW5jZSBjaGVja2luZylcclxuICAgIGlmIChjb21wbGlhbmNlQ2hlY2tlckZ1bmN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IGNvbXBsaWFuY2VSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdDb21wbGlhbmNlU2NoZWR1bGVSdWxlJywge1xyXG4gICAgICAgIHJ1bGVOYW1lOiAncmRzLWNvbXBsaWFuY2Utc2NoZWR1bGUnLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVHJpZ2dlcnMgUkRTIGNvbXBsaWFuY2UgY2hlY2tlciBMYW1iZGEgZnVuY3Rpb24gZGFpbHkgYXQgMDI6MDAgU0dUJyxcclxuICAgICAgICBzY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlLmNyb24oe1xyXG4gICAgICAgICAgbWludXRlOiAnMCcsXHJcbiAgICAgICAgICBob3VyOiAnMTgnLCAgLy8gMDI6MDAgU0dUID0gMTg6MDAgVVRDIChVVEMrOClcclxuICAgICAgICAgIGRheTogJyonLFxyXG4gICAgICAgICAgbW9udGg6ICcqJyxcclxuICAgICAgICAgIHllYXI6ICcqJyxcclxuICAgICAgICB9KSxcclxuICAgICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbXBsaWFuY2VSdWxlLmFkZFRhcmdldChuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihjb21wbGlhbmNlQ2hlY2tlckZ1bmN0aW9uLCB7XHJcbiAgICAgICAgcmV0cnlBdHRlbXB0czogMixcclxuICAgICAgICBtYXhFdmVudEFnZTogY2RrLkR1cmF0aW9uLmhvdXJzKDYpLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gRXZlbnRCcmlkZ2UgUnVsZTogQ29zdCBBbmFseXplciAoRGFpbHkgYXQgMDM6MDAgU0dUKVxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gUHVycG9zZTogQW5hbHl6ZSBSRFMgY29zdHMgZGFpbHlcclxuICAgIC8vIFJlcXVpcmVtZW50czogUkVRLTQuMSAoY29zdCBhbmFseXNpcylcclxuICAgIGlmIChjb3N0QW5hbHl6ZXJGdW5jdGlvbikge1xyXG4gICAgICBjb25zdCBjb3N0QW5hbHl6ZXJSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdDb3N0QW5hbHl6ZXJTY2hlZHVsZVJ1bGUnLCB7XHJcbiAgICAgICAgcnVsZU5hbWU6ICdyZHMtY29zdC1hbmFseXplci1zY2hlZHVsZScsXHJcbiAgICAgICAgZGVzY3JpcHRpb246ICdUcmlnZ2VycyBSRFMgY29zdCBhbmFseXplciBMYW1iZGEgZnVuY3Rpb24gZGFpbHkgYXQgMDM6MDAgU0dUJyxcclxuICAgICAgICBzY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlLmNyb24oe1xyXG4gICAgICAgICAgbWludXRlOiAnMCcsXHJcbiAgICAgICAgICBob3VyOiAnMTknLCAgLy8gMDM6MDAgU0dUID0gMTk6MDAgVVRDIChVVEMrOClcclxuICAgICAgICAgIGRheTogJyonLFxyXG4gICAgICAgICAgbW9udGg6ICcqJyxcclxuICAgICAgICAgIHllYXI6ICcqJyxcclxuICAgICAgICB9KSxcclxuICAgICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvc3RBbmFseXplclJ1bGUuYWRkVGFyZ2V0KG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGNvc3RBbmFseXplckZ1bmN0aW9uLCB7XHJcbiAgICAgICAgcmV0cnlBdHRlbXB0czogMixcclxuICAgICAgICBtYXhFdmVudEFnZTogY2RrLkR1cmF0aW9uLmhvdXJzKDYpLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgLy8gQ2xvdWRGb3JtYXRpb24gT3V0cHV0c1xyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0Rpc2NvdmVyeVJ1bGVOYW1lJywge1xyXG4gICAgICB2YWx1ZTogdGhpcy5kaXNjb3ZlcnlSdWxlLnJ1bGVOYW1lLFxyXG4gICAgICBkZXNjcmlwdGlvbjogJ0V2ZW50QnJpZGdlIHJ1bGUgbmFtZSBmb3IgUkRTIGRpc2NvdmVyeScsXHJcbiAgICAgIGV4cG9ydE5hbWU6ICdEaXNjb3ZlcnlSdWxlTmFtZScsXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAodGhpcy5oZWFsdGhNb25pdG9yUnVsZSkge1xyXG4gICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnSGVhbHRoTW9uaXRvclJ1bGVOYW1lJywge1xyXG4gICAgICAgIHZhbHVlOiB0aGlzLmhlYWx0aE1vbml0b3JSdWxlLnJ1bGVOYW1lLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRXZlbnRCcmlkZ2UgcnVsZSBuYW1lIGZvciBoZWFsdGggbW9uaXRvcmluZycsXHJcbiAgICAgICAgZXhwb3J0TmFtZTogJ0hlYWx0aE1vbml0b3JSdWxlTmFtZScsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFkZCB0YWdzXHJcbiAgICBjZGsuVGFncy5vZih0aGlzKS5hZGQoJ0NvbXBvbmVudCcsICdPcmNoZXN0cmF0aW9uJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==