/**
 * Onboarding Orchestration Stack - EventBridge Rules for Account Onboarding
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-12-08T00:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: REQ-1.1 → DESIGN-001 → TASK-2.2, TASK-2.3
 * Review Status: Pending
 * Risk Level: Level 2
 * 
 * Purpose: Define EventBridge rules for automated account discovery and onboarding.
 * Implements event-driven discovery (Organizations events) and scheduled discovery
 * (every 15 minutes) with dead letter queue for failed invocations.
 * 
 * Design Decisions:
 * - Event-driven: Trigger on CreateAccountResult from AWS Organizations
 * - Scheduled: Run every 15 minutes to catch any missed events
 * - DLQ: Capture failed invocations for manual investigation
 * - Retry: 2 attempts with exponential backoff
 */

import * as cdk from 'aws-cdk-lib';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as sqs from 'aws-cdk-lib/aws-sqs';
import { Construct } from 'constructs';

export interface OnboardingOrchestrationStackProps extends cdk.StackProps {
  readonly accountDiscoveryFunction: lambda.IFunction;
  readonly discoverySchedule?: string;  // Default: every 15 minutes
}

export class OnboardingOrchestrationStack extends cdk.Stack {
  public readonly organizationsEventRule: events.Rule;
  public readonly scheduledDiscoveryRule: events.Rule;
  public readonly deadLetterQueue: sqs.Queue;

  constructor(scope: Construct, id: string, props: OnboardingOrchestrationStackProps) {
    super(scope, id, props);

    const { accountDiscoveryFunction, discoverySchedule } = props;

    // ========================================
    // Dead Letter Queue for Failed Invocations
    // ========================================
    // Purpose: Capture failed Lambda invocations for manual investigation
    // Requirements: REQ-2.5 (error handling)
    this.deadLetterQueue = new sqs.Queue(this, 'OnboardingDiscoveryDLQ', {
      queueName: 'rds-dashboard-onboarding-discovery-dlq',
      retentionPeriod: cdk.Duration.days(14),
      encryption: sqs.QueueEncryption.KMS_MANAGED,
      visibilityTimeout: cdk.Duration.minutes(5),
    });

    // CloudWatch alarm for DLQ depth > 0
    const dlqAlarm = this.deadLetterQueue.metricApproximateNumberOfMessagesVisible()
      .createAlarm(this, 'OnboardingDLQAlarm', {
        alarmName: 'rds-dashboard-onboarding-dlq-depth',
        alarmDescription: 'Alert when onboarding discovery DLQ has messages',
        threshold: 0,
        evaluationPeriods: 1,
        comparisonOperator: cdk.aws_cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
        treatMissingData: cdk.aws_cloudwatch.TreatMissingData.NOT_BREACHING,
      });

    // ========================================
    // EventBridge Rule: Organizations Account Created Event
    // ========================================
    // Purpose: Trigger discovery when new account is created in Organizations
    // Requirements: REQ-1.1 (detect new accounts within 15 minutes)
    this.organizationsEventRule = new events.Rule(this, 'OrganizationsAccountCreatedRule', {
      ruleName: 'rds-dashboard-organizations-account-created',
      description: 'Triggers account discovery when new account is created in AWS Organizations',
      eventPattern: {
        source: ['aws.organizations'],
        detailType: ['AWS API Call via CloudTrail'],
        detail: {
          eventName: ['CreateAccountResult'],
          eventSource: ['organizations.amazonaws.com'],
        },
      },
      enabled: true,
    });

    // Add discovery Lambda as target with DLQ
    this.organizationsEventRule.addTarget(
      new targets.LambdaFunction(accountDiscoveryFunction, {
        retryAttempts: 2,
        maxEventAge: cdk.Duration.hours(2),
        deadLetterQueue: this.deadLetterQueue,
      })
    );

    // ========================================
    // EventBridge Rule: Scheduled Discovery (Every 15 minutes)
    // ========================================
    // Purpose: Periodic discovery to catch any missed events or manual account additions
    // Requirements: REQ-1.1 (detect new accounts within 15 minutes)
    const scheduleExpression = discoverySchedule || 'rate(15 minutes)';
    
    this.scheduledDiscoveryRule = new events.Rule(this, 'ScheduledAccountDiscoveryRule', {
      ruleName: 'rds-dashboard-scheduled-account-discovery',
      description: 'Triggers account discovery every 15 minutes to catch new accounts',
      schedule: events.Schedule.expression(scheduleExpression),
      enabled: true,
    });

    // Add discovery Lambda as target with DLQ
    this.scheduledDiscoveryRule.addTarget(
      new targets.LambdaFunction(accountDiscoveryFunction, {
        retryAttempts: 2,
        maxEventAge: cdk.Duration.hours(1),
        deadLetterQueue: this.deadLetterQueue,
      })
    );

    // ========================================
    // CloudFormation Outputs
    // ========================================
    new cdk.CfnOutput(this, 'OrganizationsEventRuleName', {
      value: this.organizationsEventRule.ruleName,
      description: 'EventBridge rule name for Organizations account created events',
      exportName: 'OnboardingOrganizationsEventRuleName',
    });

    new cdk.CfnOutput(this, 'ScheduledDiscoveryRuleName', {
      value: this.scheduledDiscoveryRule.ruleName,
      description: 'EventBridge rule name for scheduled account discovery',
      exportName: 'OnboardingScheduledDiscoveryRuleName',
    });

    new cdk.CfnOutput(this, 'DeadLetterQueueUrl', {
      value: this.deadLetterQueue.queueUrl,
      description: 'SQS Dead Letter Queue URL for failed discovery invocations',
      exportName: 'OnboardingDiscoveryDLQUrl',
    });

    new cdk.CfnOutput(this, 'DeadLetterQueueArn', {
      value: this.deadLetterQueue.queueArn,
      description: 'SQS Dead Letter Queue ARN for failed discovery invocations',
      exportName: 'OnboardingDiscoveryDLQArn',
    });

    // Add tags
    cdk.Tags.of(this).add('Component', 'OnboardingOrchestration');
    cdk.Tags.of(this).add('Feature', 'AutomatedAccountOnboarding');
  }
}
