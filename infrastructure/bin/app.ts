#!/usr/bin/env node
/**
 * CDK App Entry Point
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-11-12T17:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: TASK-1 â†’ Infrastructure Setup
 * Review Status: Pending
 * Risk Level: Level 2
 */

import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import * as dotenv from 'dotenv';
import { DataStack } from '../lib/data-stack';
import { IamStack } from '../lib/iam-stack';
import { ComputeStack } from '../lib/compute-stack';
import { OrchestrationStack } from '../lib/orchestration-stack';
import { ApiStack } from '../lib/api-stack';
import { MonitoringStack } from '../lib/monitoring-stack';
import { BffStack } from '../lib/bff-stack';
import { ConfigLoader } from '../../config/config-loader';

// Load environment variables (optional, config file takes precedence)
dotenv.config();

const app = new cdk.App();

// Load configuration from JSON file
const config = ConfigLoader.load();

// Environment configuration from config file
const environment = config.deployment.environment;
const account = process.env.CDK_DEFAULT_ACCOUNT || config.deployment.management_account_id;
const region = config.deployment.region;
const externalId = config.cross_account.external_id;

// Validate required environment variables
if (!account) {
  throw new Error('AWS_ACCOUNT_ID or CDK_DEFAULT_ACCOUNT must be set');
}

const env = {
  account,
  region,
};

// ========================================
// Data Stack (DynamoDB + S3)
// ========================================
const dataStack = new DataStack(app, `RDSDashboard-Data-${environment}`, {
  env,
  environment,
  description: 'RDS Dashboard - Data Layer (DynamoDB tables and S3 buckets)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// ========================================
// IAM Stack (Roles and Policies)
// ========================================
const iamStack = new IamStack(app, `RDSDashboard-IAM-${environment}`, {
  env,
  environment,
  externalId,
  rdsInventoryTable: dataStack.rdsInventoryTable,
  metricsCacheTable: dataStack.metricsCacheTable,
  healthAlertsTable: dataStack.healthAlertsTable,
  auditLogTable: dataStack.auditLogTable,
  dataBucket: dataStack.dataBucket,
  description: 'RDS Dashboard - IAM Layer (Lambda execution role and cross-account roles)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// IAM stack depends on data stack
iamStack.addDependency(dataStack);

// ========================================
// Compute Stack (Lambda Functions)
// ========================================
// Get enabled accounts and regions from config
const targetAccounts = ConfigLoader.getEnabledAccounts(config);
const targetRegions = ConfigLoader.getEnabledRegions(config);

const snsTopicArn = `arn:aws:sns:${region}:${account}:rds-dashboard-alerts-${environment}`;

const computeStack = new ComputeStack(app, `RDSDashboard-Compute-${environment}`, {
  env,
  environment,
  lambdaExecutionRole: iamStack.lambdaExecutionRole,
  rdsInventoryTable: dataStack.rdsInventoryTable,
  metricsCacheTable: dataStack.metricsCacheTable,
  healthAlertsTable: dataStack.healthAlertsTable,
  auditLogTable: dataStack.auditLogTable,
  dataBucket: dataStack.dataBucket,
  externalId,
  targetAccounts,
  targetRegions,
  snsTopicArn,
  description: 'RDS Dashboard - Compute Layer (Lambda functions)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// Compute stack depends on IAM stack
computeStack.addDependency(iamStack);

// ========================================
// Orchestration Stack (EventBridge Rules)
// ========================================
const orchestrationStack = new OrchestrationStack(app, `RDSDashboard-Orchestration-${environment}`, {
  env,
  environment,
  discoveryFunction: computeStack.discoveryFunction,
  healthMonitorFunction: computeStack.healthMonitorFunction,
  discoverySchedule: 'rate(1 hour)',  // Every hour
  healthMonitorSchedule: 'rate(5 minutes)',  // Every 5 minutes
  description: 'RDS Dashboard - Orchestration Layer (EventBridge scheduled rules)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// Orchestration stack depends on compute stack
orchestrationStack.addDependency(computeStack);

// ========================================
// API Stack (API Gateway)
// ========================================
const apiStack = new ApiStack(app, `RDSDashboard-API-${environment}`, {
  env,
  queryHandlerFunction: computeStack.queryHandlerFunction,
  operationsFunction: computeStack.operationsFunction,
  description: 'RDS Dashboard - API Layer (API Gateway and endpoints)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// API stack depends on compute stack
apiStack.addDependency(computeStack);

// ========================================
// Monitoring Stack (CloudWatch Dashboard and Alarms)
// ========================================
const monitoringStack = new MonitoringStack(app, `RDSDashboard-Monitoring-${environment}`, {
  env,
  discoveryFunction: computeStack.discoveryFunction,
  healthMonitorFunction: computeStack.healthMonitorFunction,
  costAnalyzerFunction: computeStack.costAnalyzerFunction,
  complianceCheckerFunction: computeStack.complianceCheckerFunction,
  operationsFunction: computeStack.operationsFunction,
  alertEmail: process.env.ALERT_EMAIL || 'ops@example.com',
  description: 'RDS Dashboard - Monitoring Layer (CloudWatch dashboards and alarms)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// Monitoring stack depends on compute stack
monitoringStack.addDependency(computeStack);

// ========================================
// BFF Stack (Backend-for-Frontend with Secrets Manager)
// ========================================
const bffStack = new BffStack(app, `RDSDashboard-BFF-${environment}`, {
  env,
  internalApiUrl: apiStack.api.url,
  apiKeyId: apiStack.apiKey.keyId,
  description: 'RDS Dashboard - BFF Layer (Secure proxy with Secrets Manager)',
  tags: {
    Project: 'RDSDashboard',
    Environment: environment,
    ManagedBy: 'CDK',
  },
});

// BFF stack depends on API stack
bffStack.addDependency(apiStack);

// ========================================
// Stack Tags
// ========================================
cdk.Tags.of(app).add('Project', 'RDSDashboard');
cdk.Tags.of(app).add('ManagedBy', 'CDK');
cdk.Tags.of(app).add('CostCenter', 'DBA-Team');

app.synth();
