#!/usr/bin/env node
/**
 * CDK App Entry Point
 * 
 * Generated by: claude-3.5-sonnet
 * Timestamp: 2025-11-12T17:00:00Z
 * Version: 1.0.0
 * Policy Version: v1.0.0
 * Traceability: TASK-1 â†’ Infrastructure Setup
 * Review Status: Pending
 * Risk Level: Level 2
 */

import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import * as dotenv from 'dotenv';
import { DataStack } from '../lib/data-stack';
import { IamStack } from '../lib/iam-stack';
import { ComputeStack } from '../lib/compute-stack';
import { OrchestrationStack } from '../lib/orchestration-stack';
import { ApiStack } from '../lib/api-stack';
import { MonitoringStack } from '../lib/monitoring-stack';
import { BffStack } from '../lib/bff-stack';
import { AuthStack } from '../lib/auth-stack';
import { WafStack } from '../lib/waf-stack';
import { FrontendStack } from '../lib/frontend-stack';
import { ConfigLoader } from '../../config/config-loader';

// Load environment variables (optional, config file takes precedence)
dotenv.config();

const app = new cdk.App();

// Load configuration from JSON file
const config = ConfigLoader.load();

// Deployment configuration from config file
const account = process.env.CDK_DEFAULT_ACCOUNT || config.deployment.management_account_id;
const region = config.deployment.region;
const externalId = config.cross_account.external_id;

// Validate required configuration
if (!account) {
  throw new Error('AWS_ACCOUNT_ID or CDK_DEFAULT_ACCOUNT must be set');
}

const env = {
  account,
  region,
};

// ========================================
// Data Stack (DynamoDB + S3)
// ========================================
const dataStack = new DataStack(app, 'RDSDashboard-Data', {
  env,
  description: 'RDS Dashboard - Data Layer (DynamoDB tables and S3 buckets)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// ========================================
// IAM Stack (Roles and Policies)
// ========================================
const iamStack = new IamStack(app, 'RDSDashboard-IAM', {
  env,
  externalId,
  rdsInventoryTable: dataStack.rdsInventoryTable,
  metricsCacheTable: dataStack.metricsCacheTable,
  healthAlertsTable: dataStack.healthAlertsTable,
  auditLogTable: dataStack.auditLogTable,
  approvalsTable: dataStack.approvalsTable,
  dataBucket: dataStack.dataBucket,
  description: 'RDS Dashboard - IAM Layer (Lambda execution role and cross-account roles)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// IAM stack depends on data stack
iamStack.addDependency(dataStack);

// ========================================
// Compute Stack (Lambda Functions)
// ========================================
// Get enabled accounts and regions from config
const targetAccounts = ConfigLoader.getEnabledAccounts(config);
const targetRegions = ConfigLoader.getEnabledRegions(config);

const snsTopicArn = `arn:aws:sns:${region}:${account}:rds-dashboard-alerts`;

const computeStack = new ComputeStack(app, 'RDSDashboard-Compute', {
  env,
  lambdaExecutionRole: iamStack.lambdaExecutionRole,
  rdsInventoryTable: dataStack.rdsInventoryTable,
  metricsCacheTable: dataStack.metricsCacheTable,
  healthAlertsTable: dataStack.healthAlertsTable,
  auditLogTable: dataStack.auditLogTable,
  approvalsTable: dataStack.approvalsTable,
  dataBucket: dataStack.dataBucket,
  externalId,
  targetAccounts,
  targetRegions,
  snsTopicArn,
  description: 'RDS Dashboard - Compute Layer (Lambda functions)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// Compute stack depends on IAM stack
computeStack.addDependency(iamStack);

// ========================================
// Orchestration Stack (EventBridge Rules)
// ========================================
const orchestrationStack = new OrchestrationStack(app, 'RDSDashboard-Orchestration', {
  env,
  discoveryFunction: computeStack.discoveryFunction,
  healthMonitorFunction: computeStack.healthMonitorFunction,
  discoverySchedule: 'rate(1 hour)',  // Every hour
  healthMonitorSchedule: 'rate(5 minutes)',  // Every 5 minutes
  description: 'RDS Dashboard - Orchestration Layer (EventBridge scheduled rules)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// Orchestration stack depends on compute stack
orchestrationStack.addDependency(computeStack);

// ========================================
// API Stack (API Gateway)
// ========================================
const apiStack = new ApiStack(app, 'RDSDashboard-API', {
  env,
  queryHandlerFunction: computeStack.queryHandlerFunction,
  operationsFunction: computeStack.operationsFunction,
  cloudOpsGeneratorFunction: computeStack.cloudOpsGeneratorFunction,
  monitoringFunction: computeStack.monitoringFunction,
  approvalWorkflowFunction: computeStack.approvalWorkflowFunction,
  description: 'RDS Dashboard - API Layer (API Gateway and endpoints)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// API stack depends on compute stack
apiStack.addDependency(computeStack);

// ========================================
// Monitoring Stack (CloudWatch Dashboard and Alarms)
// ========================================
const monitoringStack = new MonitoringStack(app, 'RDSDashboard-Monitoring', {
  env,
  discoveryFunction: computeStack.discoveryFunction,
  healthMonitorFunction: computeStack.healthMonitorFunction,
  costAnalyzerFunction: computeStack.costAnalyzerFunction,
  complianceCheckerFunction: computeStack.complianceCheckerFunction,
  operationsFunction: computeStack.operationsFunction,
  alertEmail: process.env.ALERT_EMAIL || 'ops@example.com',
  description: 'RDS Dashboard - Monitoring Layer (CloudWatch dashboards and alarms)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// Monitoring stack depends on compute stack
monitoringStack.addDependency(computeStack);

// ========================================
// Auth Stack (Cognito User Pool)
// ========================================
const authStack = new AuthStack(app, 'RDSDashboard-Auth', {
  env,
  frontendDomain: process.env.FRONTEND_DOMAIN, // Optional: set for production
  description: 'RDS Dashboard - Auth Layer (Cognito User Pool and groups)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// ========================================
// BFF Stack (Backend-for-Frontend with Express Container)
// ========================================
const bffStack = new BffStack(app, 'RDSDashboard-BFF', {
  env,
  internalApiUrl: apiStack.api.url,
  apiKeyId: apiStack.apiKey.keyId,
  userPoolId: authStack.userPool.userPoolId,
  userPoolClientId: authStack.userPoolClient.userPoolClientId,
  frontendUrl: process.env.FRONTEND_URL || process.env.FRONTEND_DOMAIN,
  description: 'RDS Dashboard - BFF Layer (Express container with JWT validation and RBAC)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// BFF stack depends on API and Auth stacks
bffStack.addDependency(apiStack);
bffStack.addDependency(authStack);

// ========================================
// WAF Stack (Web Application Firewall)
// ========================================
const wafStack = new WafStack(app, 'RDSDashboard-WAF', {
  env,
  apiGateway: apiStack.api,
  rateLimit: 100, // 100 requests per 5 minutes per IP
  blockedCountries: [], // Add country codes to block if needed (e.g., ['CN', 'RU'])
  enableOWASPRules: true,
  enableBotControl: true,
  description: 'RDS Dashboard - WAF Layer (Web Application Firewall protection)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// WAF stack depends on API stack
wafStack.addDependency(apiStack);

// ========================================
// Frontend Stack (S3 + CloudFront)
// ========================================
const frontendStack = new FrontendStack(app, 'RDSDashboard-Frontend', {
  env,
  customDomain: process.env.FRONTEND_DOMAIN,
  certificateArn: process.env.CERTIFICATE_ARN,
  description: 'RDS Dashboard - Frontend Layer (S3 bucket and CloudFront distribution)',
  tags: {
    Project: 'RDSDashboard',
    ManagedBy: 'CDK',
  },
});

// ========================================
// Stack Tags
// ========================================
cdk.Tags.of(app).add('Project', 'RDSDashboard');
cdk.Tags.of(app).add('ManagedBy', 'CDK');
cdk.Tags.of(app).add('CostCenter', 'DBA-Team');

app.synth();
