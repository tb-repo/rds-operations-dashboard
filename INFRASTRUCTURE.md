# Infrastructure Overview - Centralized Deployment Model

**Generated by:** claude-3.5-sonnet  
**Timestamp:** 2025-11-23T10:00:00Z  
**Version:** 2.0.0  
**Policy Version:** v1.0.0  
**Traceability:** CENTRALIZED-DEPLOYMENT → Infrastructure Refactoring

## Summary

This document provides an overview of the RDS Operations Dashboard infrastructure using the **centralized deployment model**. In this model, a single dashboard instance monitors all RDS instances across all AWS accounts, with instances classified by their `Environment` tag.

## What Was Created

### 1. Project Structure

```
rds-operations-dashboard/
├── infrastructure/              # AWS CDK infrastructure code
│   ├── lib/
│   │   ├── data-stack.ts       # DynamoDB tables + S3 bucket
│   │   └── iam-stack.ts        # IAM roles and policies
│   ├── bin/
│   │   └── app.ts              # CDK app entry point
│   ├── package.json
│   ├── tsconfig.json
│   ├── cdk.json
│   └── .env.example
├── lambda/                      # Lambda function code (prepared)
│   └── shared/                 # Shared utilities
│       ├── __init__.py
│       ├── aws_clients.py      # AWS service clients
│       ├── logger.py           # Structured logging
│       └── config.py           # Configuration management
├── docs/                        # Documentation
│   ├── deployment.md
│   ├── cross-account-setup.md
│   └── s3-bucket-structure.md
├── README.md
├── .gitignore
└── INFRASTRUCTURE.md (this file)
```

### 2. DynamoDB Tables (data-stack.ts)

**Centralized Deployment:** All tables use simple names without environment suffixes.

| Table Name | Purpose | Primary Key | GSI | TTL |
|------------|---------|-------------|-----|-----|
| `rds-inventory` | RDS instance metadata (all environments) | instance_id | account-region-index | No |
| `metrics-cache` | CloudWatch metrics cache | cache_key | None | Yes (5 min) |
| `health-alerts` | Active alerts | alert_id + created_at | instance-status-index | No |
| `audit-log` | Operations audit trail | operation_id + timestamp | instance-timestamp-index | No |
| `cost-snapshots` | Cost analysis snapshots | snapshot_id + timestamp | instance-timestamp-index | No |
| `rds-approvals` | Approval workflow requests | request_id + created_at | instance-status-index | No |

**Configuration:**
- Billing Mode: On-demand (pay per request)
- Encryption: AWS managed keys
- Point-in-time Recovery: Enabled for audit-log only
- Removal Policy: RETAIN (prevent accidental deletion)
- **Single tables** store data for all RDS instances across all environments

### 3. S3 Bucket (data-stack.ts)

**Bucket Name:** `rds-dashboard-data-{account-id}-{env}`

**Folder Structure:**
- `historical-metrics/` - 7-day retention
- `compliance-reports/` - 90-day Standard, then Glacier
- `cost-reports/` - 90-day Standard, then Glacier
- `cloudops-requests/` - 1-year retention
- `templates/` - No expiration

**Security:**
- Versioning: Enabled
- Encryption: SSE-S3
- Public Access: Blocked
- SSL/TLS: Required

### 4. IAM Roles (iam-stack.ts)

#### Lambda Execution Role
**Name:** `RDSDashboardLambdaRole-{env}`

**Permissions:**
- DynamoDB: Read/write to all tables
- S3: Read/write to data bucket
- SNS: Publish to alert topic
- STS: AssumeRole for cross-account access
- CloudWatch: PutMetricData
- CloudWatch Logs: Create log groups and streams

#### Cross-Account Role Template
**Name:** `RDSDashboardCrossAccountRole` (deployed in target accounts)

**Permissions:**
- RDS: Describe* and ListTagsForResource
- CloudWatch: GetMetricStatistics, GetMetricData, ListMetrics
- RDS Write: CreateDBSnapshot, RebootDBInstance, ModifyDBInstance (non-prod only)

**Trust Policy:**
- Principal: Lambda execution role in management account
- Condition: External ID must match

### 5. Shared Utilities (lambda/shared/)

#### aws_clients.py
- Centralized AWS service client creation
- Cross-account role assumption with STS
- Session caching to minimize API calls
- Automatic retry with exponential backoff
- Clients: RDS, CloudWatch, DynamoDB, S3, SNS, STS

#### logger.py
- Structured JSON logging for CloudWatch
- Correlation IDs for request tracing
- Automatic Lambda context inclusion
- Sensitive data sanitization
- Execution timing decorator

#### config.py
- Environment variable configuration
- Type validation and conversion
- Configuration caching
- Sensible defaults
- Error handling for missing config

## Design Decisions

### Why DynamoDB?
- **Serverless:** No baseline cost, scales automatically
- **Performance:** Single-digit millisecond latency
- **TTL:** Built-in cache expiration for metrics
- **Cost:** Lower than RDS for read-heavy workload

### Why On-Demand Billing?
- **No Baseline Cost:** Pay only for what you use
- **Automatic Scaling:** No capacity planning needed
- **Cost Effective:** For variable workload (50-100 instances)

### Why Singapore Region?
- **Data Locality:** 75% of RDS instances in Singapore
- **Cost Savings:** Minimize cross-region data transfer
- **Latency:** Low latency for majority of resources

### Why External ID?
- **Security:** Prevents confused deputy problem
- **Best Practice:** AWS recommended for cross-account access
- **Compliance:** Required for secure role assumption

## Configuration

### Environment Variables (Lambda)

```bash
# DynamoDB Tables
INVENTORY_TABLE=rds-inventory-prod
METRICS_CACHE_TABLE=metrics-cache-prod
HEALTH_ALERTS_TABLE=health-alerts-prod
AUDIT_LOG_TABLE=audit-log-prod

# S3 Bucket
DATA_BUCKET=rds-dashboard-data-123456789012-prod

# Cross-Account
EXTERNAL_ID=rds-dashboard-unique-id-12345
CROSS_ACCOUNT_ROLE_NAME=RDSDashboardCrossAccountRole
TARGET_ACCOUNTS=["123456789012","234567890123"]
TARGET_REGIONS=["ap-southeast-1","eu-west-2","ap-south-1","us-east-1"]

# Monitoring
SNS_TOPIC_ARN=arn:aws:sns:ap-southeast-1:123456789012:rds-dashboard-alerts-prod
CLOUDWATCH_NAMESPACE=RDSDashboard

# Cache
METRICS_TTL_SECONDS=300
CACHE_HIT_THRESHOLD=0.7

# Logging
LOG_LEVEL=INFO
```

## Cost Estimation

### Infrastructure Only (Task 1)

| Resource | Usage | Monthly Cost |
|----------|-------|--------------|
| DynamoDB (4 tables) | 1M reads, 100K writes, 1GB storage | $4.00 |
| S3 | 5GB storage, 10K requests | $0.50 |
| CloudWatch Logs | 2GB ingestion, 7-day retention | $1.00 |
| **Total** | | **$5.50** |

### Full System (All Tasks)

| Resource | Monthly Cost |
|----------|--------------|
| Infrastructure (above) | $5.50 |
| Lambda Functions | $3.50 |
| API Gateway | $0.35 |
| CloudFront | $1.50 |
| CloudWatch Metrics | $5.00 |
| Data Transfer | $0.06 |
| Other | $1.61 |
| **Total** | **~$17.52** |

**Well within $30-40 budget!**

## Security Features

### Encryption
- **At Rest:** DynamoDB (AWS managed), S3 (SSE-S3)
- **In Transit:** TLS 1.2+ for all AWS API calls

### Access Control
- **Least Privilege:** IAM roles with minimal permissions
- **External ID:** Prevents confused deputy attacks
- **Resource Tags:** Environment-based access control

### Audit Trail
- **CloudTrail:** All API calls logged
- **Audit Log Table:** Operations history with user identity
- **CloudWatch Logs:** Lambda execution logs

### Data Protection
- **S3 Versioning:** Protect against accidental deletion
- **DynamoDB PITR:** Point-in-time recovery for audit log
- **Sensitive Data:** Sanitized in logs

## Monitoring

### CloudWatch Metrics (Custom)
- `RDSDashboard/InstancesDiscovered`
- `RDSDashboard/HealthChecksCompleted`
- `RDSDashboard/AlertsGenerated`
- `RDSDashboard/CacheHitRate`
- `RDSDashboard/DataTransferGB`

### CloudWatch Logs
- `/aws/lambda/rds-discovery-{env}`
- `/aws/lambda/rds-health-monitor-{env}`
- `/aws/lambda/rds-cost-analyzer-{env}`
- `/aws/lambda/rds-compliance-checker-{env}`
- `/aws/lambda/rds-operations-{env}`

### Alarms (To be created in Task 11)
- Discovery failure
- High error rate
- API latency
- Cost overrun

## Next Steps

### Task 2: RDS Discovery Service
- Create Lambda function for RDS instance discovery
- Implement cross-account scanning
- Store inventory in DynamoDB
- Schedule with EventBridge (hourly)

### Task 3: Health Monitor Service
- Create Lambda function for health monitoring
- Implement metrics caching
- Query CloudWatch with optimization
- Generate alerts for threshold violations

### Subsequent Tasks
- Cost Analyzer (Task 4)
- Compliance Checker (Task 5)
- Operations Service (Task 6)
- CloudOps Generator (Task 7)
- API Gateway (Task 8)
- Frontend Dashboard (Task 10)
- Monitoring Setup (Task 11)

## Deployment Status

- ✅ Project structure created
- ✅ DynamoDB tables defined
- ✅ S3 bucket configured
- ✅ IAM roles created
- ✅ Shared utilities implemented
- ✅ Documentation completed
- ⏭️ Ready for Lambda function implementation

## References

- [Deployment Guide](docs/deployment.md)
- [Cross-Account Setup](docs/cross-account-setup.md)
- [S3 Bucket Structure](docs/s3-bucket-structure.md)
- [Requirements Document](.kiro/specs/rds-operations-dashboard/requirements.md)
- [Design Document](.kiro/specs/rds-operations-dashboard/design.md)

## Governance Compliance

**AI SDLC Framework:**
- ✅ Metadata included in all artifacts
- ✅ Traceability to requirements maintained
- ✅ Design decisions documented with rationale
- ✅ Security best practices followed
- ✅ Code includes inline comments explaining AI decisions
- ✅ Structured logging for audit trail

**Review Status:** Pending human validation (Gate 3)

**Risk Level:** Level 2 (Medium Risk - Decision-support outputs with human approval)
